rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function userRef(uid) {
      return /databases/$(database)/documents/users/$(uid);
    }

    function hasUserDoc() {
      return signedIn() && exists(userRef(request.auth.uid));
    }

    function userDoc() {
      return get(userRef(request.auth.uid)).data;
    }

    // Admin: po mailu lub po polu admin==true lub role=="admin"
    function isAdmin() {
      return signedIn() && (
        request.auth.token.email == "aquivivo.pl@gmail.com"
        || (hasUserDoc() && (
              userDoc().admin == true
              || (("role" in userDoc()) && userDoc().role == "admin")
           ))
      );
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function notBlocked() {
      return hasUserDoc() && userDoc().blocked != true;
    }

    // "Globalny" dostęp (premium / access=true / trial accessUntil)
    function hasGlobalAccess() {
      return isAdmin() || (
        signedIn()
        && hasUserDoc()
        && notBlocked()
        && (
          userDoc().access == true
          || userDoc().plan == "premium"
          || (("accessUntil" in userDoc()) && userDoc().accessUntil > request.time)
        )
      );
    }

    // Dostęp do konkretnego poziomu (A1/A2/B1/B2) – levels[] w users doc
    function hasLevel(level) {
      return hasUserDoc()
        && ("levels" in userDoc())
        && (userDoc().levels is list)
        && userDoc().levels.hasAny([level]);
    }

    function canReadLevel(level) {
      return hasGlobalAccess() || (signedIn() && notBlocked() && hasLevel(level));
    }

    function friendReqDoc(a, b) {
      return /databases/$(database)/documents/friend_requests/$(a + "__" + b);
    }

    function blockDoc(a, b) {
      return /databases/$(database)/documents/user_blocks/$(a + "__" + b);
    }

    function isBlocked(a, b) {
      return exists(blockDoc(a, b)) || exists(blockDoc(b, a));
    }

    function isFriends(a, b) {
      return (
        (exists(friendReqDoc(a, b)) && get(friendReqDoc(a, b)).data.status == "accepted")
        || (exists(friendReqDoc(b, a)) && get(friendReqDoc(b, a)).data.status == "accepted")
      );
    }

    function publicUserDoc(uid) {
      return /databases/$(database)/documents/public_users/$(uid);
    }

    function allowsFriendRequests(uid) {
      return !exists(publicUserDoc(uid)) || get(publicUserDoc(uid)).data.allowFriendRequests != false;
    }

    function allowsMessages(uid) {
      return !exists(publicUserDoc(uid)) || get(publicUserDoc(uid)).data.allowMessages != false;
    }

    function isPublicProfile(uid) {
      return !exists(publicUserDoc(uid)) || get(publicUserDoc(uid)).data.publicProfile != false;
    }

    function postsVisibility(uid) {
      return !exists(publicUserDoc(uid))
        ? "public"
        : (("postsVisibility" in get(publicUserDoc(uid)).data)
          ? get(publicUserDoc(uid)).data.postsVisibility
          : (get(publicUserDoc(uid)).data.publicProfile == false ? "private" : "public"));
    }

    function canViewFeed(uid) {
      return isAdmin() || (
        signedIn()
        && !isBlocked(request.auth.uid, uid)
        && (
          isOwner(uid)
          || postsVisibility(uid) == "public"
          || (postsVisibility(uid) == "friends" && isFriends(request.auth.uid, uid))
        )
      );
    }

    /* ===== USERS ===== */

    // User może zmieniać tylko "bezpieczne" pola profilu
    function userEditableKeys() {
      return ["name","displayName","handle","handleLower","photoURL","photoPath","lang","gender","studyGoalMin","reviewReminders","publicProfile","allowFriendRequests","allowMessages","note","noteUser","refCode","refCodeCreatedAt","reviewDailyMinutes","reviewDailyLimit","reviewDirection","updatedAt"];
    }

    // Chronione – user nie może ich ruszać
    function protectedUserKeys() {
      return ["role","admin","plan","levels","access","accessUntil","blocked","createdAt","email","emailLower"];
    }

    // Dozwolone pola w samodzielnej aktywacji triala przez usera
    function trialUserKeys() {
      return ["plan","levels","access","blocked","accessUntil","trialUsedAt","trialLevel","trialDays","trialSource","trialEligibleAfter","updatedAt"];
    }

    function isValidTrialLevel(level) {
      return ["A1"].hasAny([level]);
    }

    function isTrialPlan(plan, level) {
      return (plan == "trial_a1" && level == "A1");
    }

    function lastLoginTs() {
      return ("lastLoginAt" in resource.data) ? resource.data.lastLoginAt
        : (("lastSeenAt" in resource.data) ? resource.data.lastSeenAt
          : (("createdAt" in resource.data) ? resource.data.createdAt : null));
    }

    function lastAccessEndTs() {
      return ("accessUntil" in resource.data) ? resource.data.accessUntil
        : (("trialUsedAt" in resource.data) ? resource.data.trialUsedAt
          : lastLoginTs());
    }

    function inactivePlanOk() {
      return (lastAccessEndTs() is timestamp)
        && lastAccessEndTs() <= request.time - duration.value(150, 'd');
    }

    function noLoginOk() {
      return (lastLoginTs() is timestamp)
        && lastLoginTs() <= request.time - duration.value(60, 'd');
    }

    function trialEligibleNow() {
      return !("trialUsedAt" in resource.data)
        || resource.data.trialUsedAt == null
        || (("trialEligibleAfter" in resource.data)
          && (resource.data.trialEligibleAfter is timestamp)
          && resource.data.trialEligibleAfter <= request.time)
        || inactivePlanOk()
        || noLoginOk();
    }

    function isSelfTrialUpdate(uid) {
      return isOwner(uid)
        && trialEligibleNow()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(trialUserKeys())
        && isValidTrialLevel(request.resource.data.trialLevel)
        && isTrialPlan(request.resource.data.plan, request.resource.data.trialLevel)
        && request.resource.data.trialDays == 7
        && request.resource.data.trialSource == "user"
        && request.resource.data.access == false
        && request.resource.data.blocked == false
        && ("levels" in request.resource.data)
        && (request.resource.data.levels is list)
        && request.resource.data.levels.hasAny([request.resource.data.trialLevel])
        && request.resource.data.accessUntil >= request.time
        && request.resource.data.accessUntil <= request.time + duration.value(7, 'd');
    }

    match /users/{uid} {

      allow read: if isAdmin() || isOwner(uid);

      // Create: pozwól userowi utworzyć swój doc (bez porównania createdAt do request.time)
      // Minimalny kontrakt: email + admin/access/blocked (reszta może dopełnić admin/panel)
      allow create: if isAdmin() || (
        isOwner(uid)
        && request.resource.data.email == request.auth.token.email
        // emailLower opcjonalne (jeśli jest – musi pasować)
        && ( !("emailLower" in request.resource.data) || request.resource.data.emailLower == request.auth.token.email.lower() )
        && ( !("admin" in request.resource.data) || request.resource.data.admin == false )
        && ( !("blocked" in request.resource.data) || request.resource.data.blocked == false )
        // createdAt może być serverTimestamp – nie walidujemy "== request.time"
      );

      // Update: admin wszystko, user tylko userEditableKeys() + self-trial
      allow update: if isAdmin() || isSelfTrialUpdate(uid) || (
        isOwner(uid)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(userEditableKeys())
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(protectedUserKeys())
      );

      allow delete: if isAdmin();
    }

    /* ===== COURSES (lista tematów) ===== */
    match /courses/{docId} {
      allow read: if signedIn()
        && notBlocked()
        && (
          hasGlobalAccess()
          || hasLevel(resource.data.level)
          || resource.data.level == "A1"
        );
      allow write: if isAdmin();
    }

    /* ===== COURSE META (treść lekcji) =====
       docId: "A1__slug" / "A2__slug" / "B1__slug" / "B2__slug"
    */
    match /course_meta/{docId} {
      allow read: if signedIn() && notBlocked() && (
        isAdmin()
        || (docId.startsWith("A1__") && canReadLevel("A1"))
        || (docId.startsWith("A2__") && canReadLevel("A2"))
        || (docId.startsWith("B1__") && canReadLevel("B1"))
        || (docId.startsWith("B2__") && canReadLevel("B2"))
      );

      allow write: if isAdmin();
    }

    /* ===== EXERCISES =====
       Każdy exercise doc powinien mieć pole: level: "A1"/"A2"/"B1"/"B2"
    */
    match /exercises/{id} {
      allow read: if signedIn() && notBlocked() && (
        isAdmin()
        || (("level" in resource.data) && canReadLevel(resource.data.level))
      );

      allow write: if isAdmin();
    }

    /* ===== SERVICES (OFERTA) ===== */
    match /services/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    /* ===== PROMO CODES ===== */
    match /promo_codes/{codeId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    /* ===== SITE SETTINGS ===== */
    match /site_settings/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    /* ===== PROGRESS ===== */
    match /user_progress/{uid}/topics/{topicId} {
      allow read, write: if isAdmin() || isOwner(uid);
    }

    /* ===== REVIEWS / RATINGS ===== */
    match /reviews/{id} {
      allow read: if isAdmin() || (signedIn() && resource.data.userId == request.auth.uid);
      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (signedIn() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }

    /* ===== REFERRALS / REWARDS (jak miałaś) ===== */
    match /referrals/{id} {
      allow read: if isAdmin() || (signedIn() && resource.data.ownerUid == request.auth.uid);
      allow create: if signedIn()
        && request.resource.data.newUserUid == request.auth.uid
        && request.resource.data.status == "PENDING";
      allow update, delete: if isAdmin();
    }

    match /rewards/{id} {
      allow read: if isAdmin() || (signedIn() && resource.data.ownerUid == request.auth.uid);
      allow write: if isAdmin();
    }

    /* ===== SPACED REPETITION ===== */
    match /user_spaced/{uid}/cards/{cardId} {
      allow read, write: if isAdmin() || isOwner(uid);
    }

    /* ===== AUDIO LIBRARY ===== */
    match /audio_library/{id} {
      allow read, write: if isAdmin();
    }

    /* ===== APP LOGS ===== */
    match /app_logs/{id} {
      allow read: if isAdmin();
      allow create: if signedIn();
      allow update: if false;
      allow delete: if isAdmin();
    }

    /* ===== USER REPORTS ===== */
    match /user_reports/{id} {
      allow read: if isAdmin();
      allow create: if signedIn() && (isAdmin() || request.resource.data.userId == request.auth.uid);
      allow update, delete: if isAdmin();
    }

    /* ===== PUBLIC PROFILES ===== */
    match /public_users/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isOwner(uid);
      allow delete: if isAdmin();
    }

    /* ===== FRIEND REQUESTS ===== */
    match /friend_requests/{id} {
      allow read: if isAdmin() || (signedIn() && (
        resource.data.fromUid == request.auth.uid || resource.data.toUid == request.auth.uid
      ));

      allow create: if signedIn()
        && request.resource.data.fromUid == request.auth.uid
        && request.resource.data.toUid is string
        && request.resource.data.toUid != request.auth.uid
        && !isBlocked(request.resource.data.fromUid, request.resource.data.toUid)
        && allowsFriendRequests(request.resource.data.toUid)
        && request.resource.data.status == "pending";

      allow update: if signedIn()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["status","updatedAt"])
        && (
          isAdmin()
          || (resource.data.toUid == request.auth.uid && request.resource.data.status in ["accepted","declined"])
          || (resource.data.fromUid == request.auth.uid && request.resource.data.status == "cancelled")
        );

      allow delete: if isAdmin() || (signedIn() && (
        resource.data.fromUid == request.auth.uid || resource.data.toUid == request.auth.uid
      ));
    }

    /* ===== USER MESSAGES ===== */
    match /user_inbox/{uid}/messages/{msgId} {
      allow read: if isAdmin() || isOwner(uid);
      allow create: if signedIn()
        && request.resource.data.fromUid == request.auth.uid
        && request.resource.data.toUid is string
        && isFriends(request.resource.data.fromUid, request.resource.data.toUid)
        && !isBlocked(request.resource.data.fromUid, request.resource.data.toUid)
        && allowsMessages(request.resource.data.toUid)
        && (request.auth.uid == uid || request.resource.data.toUid == uid);
      allow update: if isOwner(uid);
      allow delete: if isAdmin() || isOwner(uid);
    }

    /* ===== NOTIFICATIONS ===== */
    match /user_notifications/{uid}/items/{id} {
      allow read: if isAdmin() || isOwner(uid);
      allow create, update: if isAdmin() || isOwner(uid);
      allow delete: if isAdmin();
    }

    /* ===== LOGIN INDEX ===== */
    match /login_index/{handle} {
      allow read: if true;
      allow create, update: if signedIn()
        && request.resource.data.uid == request.auth.uid;
      allow delete: if isAdmin() || (signedIn() && resource.data.uid == request.auth.uid);
    }

    /* ===== USER FEED ===== */
    match /user_feed/{uid}/posts/{postId} {
      allow read: if canViewFeed(uid);
      allow create: if isOwner(uid)
        && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if isOwner(uid) || isAdmin();
    }

    match /user_feed/{uid}/posts/{postId}/comments/{commentId} {
      allow read: if canViewFeed(uid);
      allow create: if signedIn()
        && !isBlocked(request.auth.uid, uid)
        && (isOwner(uid) || isFriends(request.auth.uid, uid))
        && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if isAdmin() || (
        signedIn()
        && resource.data.authorUid == request.auth.uid
      );
    }

    match /user_feed/{uid}/posts/{postId}/reactions/{reactionId} {
      allow read: if canViewFeed(uid);
      allow create: if signedIn()
        && !isBlocked(request.auth.uid, uid)
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn()
        && !isBlocked(request.auth.uid, uid)
        && resource.data.userId == request.auth.uid;
    }

    /* ===== USER BLOCKS ===== */
    match /user_blocks/{id} {
      allow read: if isAdmin() || (signedIn() && (
        resource.data.fromUid == request.auth.uid || resource.data.toUid == request.auth.uid
      ));
      allow create: if signedIn()
        && request.resource.data.fromUid == request.auth.uid
        && request.resource.data.toUid is string
        && request.resource.data.toUid != request.auth.uid
        && request.resource.id == request.auth.uid + "__" + request.resource.data.toUid;
      allow delete: if isAdmin() || (signedIn() && resource.data.fromUid == request.auth.uid);
      allow update: if false;
    }

    /* ===== BROADCASTS ===== */
    match /broadcasts/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    /* ===== PAYMENTS ===== */
    match /payments/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /payment_attempts/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
