rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function signedIn() {
      return request.auth != null;
    }

    function userRef(uid) {
      return /databases/$(database)/documents/users/$(uid);
    }

    function hasUserDoc() {
      return signedIn() && exists(userRef(request.auth.uid));
    }

    function userDoc() {
      return get(userRef(request.auth.uid)).data;
    }

    // Admin: po mailu lub po polu admin==true lub role=="admin"
    function isAdmin() {
      return signedIn() && (
        request.auth.token.email == "aquivivo.pl@gmail.com"
        || (hasUserDoc() && (
              userDoc().admin == true
              || (("role" in userDoc()) && userDoc().role == "admin")
           ))
      );
    }

    function supportAgentDoc(uid) {
      return /databases/$(database)/documents/support_agents/$(uid);
    }

    function isSupport() {
      return signedIn() && exists(supportAgentDoc(request.auth.uid));
    }

    function isOwner(uid) {
      return signedIn() && request.auth.uid == uid;
    }

    function notBlocked() {
      return signedIn() && (
        !hasUserDoc()
        || userDoc().blocked != true
      );
    }

    // "Globalny" dostęp (premium / access=true / trial accessUntil)
    function hasGlobalAccess() {
      return isAdmin() || (
        signedIn()
        && hasUserDoc()
        && notBlocked()
        && (
          userDoc().access == true
          || userDoc().plan == "premium"
          || (("accessUntil" in userDoc()) && userDoc().accessUntil > request.time)
        )
      );
    }

    // Dostęp do konkretnego poziomu (A1/A2/B1/B2) – levels[] w users doc
    function hasLevel(level) {
      return hasUserDoc()
        && ("levels" in userDoc())
        && (userDoc().levels is list)
        && userDoc().levels.hasAny([level]);
    }

    function canReadLevel(level) {
      return hasGlobalAccess() || (signedIn() && notBlocked() && hasLevel(level));
    }

    function friendReqDoc(a, b) {
      return /databases/$(database)/documents/friend_requests/$(a + "__" + b);
    }

    function blockDoc(a, b) {
      return /databases/$(database)/documents/user_blocks/$(a + "__" + b);
    }

    function isBlocked(a, b) {
      return exists(blockDoc(a, b)) || exists(blockDoc(b, a));
    }

    function isFriends(a, b) {
      return (
        (exists(friendReqDoc(a, b)) && get(friendReqDoc(a, b)).data.status == "accepted")
        || (exists(friendReqDoc(b, a)) && get(friendReqDoc(b, a)).data.status == "accepted")
      );
    }

    function idHasUid(id, uid) {
      return id.matches("^" + uid + "__.*") || id.matches(".*__" + uid + "$");
    }

    function publicUserDoc(uid) {
      return /databases/$(database)/documents/public_users/$(uid);
    }

    function allowsFriendRequests(uid) {
      return !exists(publicUserDoc(uid)) || get(publicUserDoc(uid)).data.allowFriendRequests != false;
    }

    function allowsMessages(uid) {
      return !exists(publicUserDoc(uid)) || get(publicUserDoc(uid)).data.allowMessages != false;
    }

    function postsVisibility(uid) {
      return !exists(publicUserDoc(uid))
        ? "public"
        : (("postsVisibility" in get(publicUserDoc(uid)).data)
          ? get(publicUserDoc(uid)).data.postsVisibility
          : (get(publicUserDoc(uid)).data.publicProfile == false ? "private" : "public"));
    }

    function canViewFeed(uid) {
      return isAdmin() || (
        signedIn()
        && !isBlocked(request.auth.uid, uid)
        && (
          isOwner(uid)
          || postsVisibility(uid) == "public"
          || (postsVisibility(uid) == "friends" && isFriends(request.auth.uid, uid))
        )
      );
    }

    function isCorrectionPost(uid, postId) {
      return exists(/databases/$(database)/documents/user_feed/$(uid)/posts/$(postId))
        && get(/databases/$(database)/documents/user_feed/$(uid)/posts/$(postId)).data.type == "correction";
    }

    /* ===== USERS ===== */

    // User może zmieniać tylko "bezpieczne" pola profilu
    function userEditableKeys() {
      return ["name","displayName","handle","handleLower","photoURL","photoPath","lang","gender","studyGoalMin","reviewReminders","publicProfile","allowFriendRequests","allowMessages","note","noteUser","refCode","refCodeCreatedAt","reviewDailyMinutes","reviewDailyLimit","reviewDirection","updatedAt"];
    }

    // Chronione – user nie może ich ruszać
    function protectedUserKeys() {
      return ["role","admin","plan","levels","access","accessUntil","blocked","createdAt","email","emailLower"];
    }

    // Dozwolone pola w samodzielnej aktywacji triala przez usera
    function trialUserKeys() {
      return ["plan","levels","access","blocked","accessUntil","trialUsedAt","trialLevel","trialDays","trialSource","trialEligibleAfter","updatedAt"];
    }

    function isValidTrialLevel(level) {
      return ["A1"].hasAny([level]);
    }

    function isTrialPlan(plan, level) {
      return (plan == "trial_a1" && level == "A1");
    }

    function lastLoginTs() {
      return ("lastLoginAt" in resource.data) ? resource.data.lastLoginAt
        : (("lastSeenAt" in resource.data) ? resource.data.lastSeenAt
          : (("createdAt" in resource.data) ? resource.data.createdAt : null));
    }

    function lastAccessEndTs() {
      return ("accessUntil" in resource.data) ? resource.data.accessUntil
        : (("trialUsedAt" in resource.data) ? resource.data.trialUsedAt
          : lastLoginTs());
    }

    function inactivePlanOk() {
      return (lastAccessEndTs() is timestamp)
        && lastAccessEndTs() <= request.time - duration.value(150, 'd');
    }

    function noLoginOk() {
      return (lastLoginTs() is timestamp)
        && lastLoginTs() <= request.time - duration.value(60, 'd');
    }

    function trialEligibleNow() {
      return !("trialUsedAt" in resource.data)
        || resource.data.trialUsedAt == null
        || (("trialEligibleAfter" in resource.data)
          && (resource.data.trialEligibleAfter is timestamp)
          && resource.data.trialEligibleAfter <= request.time)
        || inactivePlanOk()
        || noLoginOk();
    }

    function isSelfTrialUpdate(uid) {
      return isOwner(uid)
        && trialEligibleNow()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(trialUserKeys())
        && isValidTrialLevel(request.resource.data.trialLevel)
        && isTrialPlan(request.resource.data.plan, request.resource.data.trialLevel)
        && request.resource.data.trialDays == 7
        && request.resource.data.trialSource == "user"
        && request.resource.data.access == false
        && request.resource.data.blocked == false
        && ("levels" in request.resource.data)
        && (request.resource.data.levels is list)
        && request.resource.data.levels.hasAny([request.resource.data.trialLevel])
        && request.resource.data.accessUntil >= request.time
        && request.resource.data.accessUntil <= request.time + duration.value(7, 'd');
    }

    match /users/{uid} {

      allow read: if isAdmin() || isOwner(uid);

      // Create: pozwól userowi utworzyć swój doc (bez porównania createdAt do request.time)
      // Minimalny kontrakt: email + admin/access/blocked (reszta może dopełnić admin/panel)
      allow create: if isAdmin() || (
        isOwner(uid)
        && (request.resource.data.email is string)
        && (request.auth.token.email is string)
        && request.resource.data.email.lower() == request.auth.token.email.lower()
        // emailLower opcjonalne (jeśli jest – musi pasować)
        && ( !("emailLower" in request.resource.data) || request.resource.data.emailLower == request.auth.token.email.lower() )
        && ( !("admin" in request.resource.data) || request.resource.data.admin == false )
        && ( !("blocked" in request.resource.data) || request.resource.data.blocked == false )
        // createdAt może być serverTimestamp – nie walidujemy "== request.time"
      );

      // Update: admin wszystko, user tylko userEditableKeys() + self-trial
      allow update: if isAdmin() || isSelfTrialUpdate(uid) || (
        isOwner(uid)
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(userEditableKeys())
        && !request.resource.data.diff(resource.data).affectedKeys().hasAny(protectedUserKeys())
      );

      allow delete: if isAdmin();
    }

    /* ===== COURSES (lista tematów) ===== */
    match /courses/{docId} {
      allow read: if isAdmin() || (
        signedIn()
        && notBlocked()
        && (
          hasGlobalAccess()
          || hasLevel(resource.data.level)
          || resource.data.level == "A1"
        )
      );
      allow write: if isAdmin();
    }

    
    /* ===== COURSE PATHS ===== */
    match /course_paths/{docId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    /* ===== MODULES ===== */
    match /modules/{docId} {
      allow read: if isAdmin() || (
        signedIn()
        && notBlocked()
        && (
          (("level" in resource.data) && canReadLevel(resource.data.level))
          || (("level" in resource.data) && resource.data.level == "A1")
          || !("level" in resource.data)
        )
      );
      allow write: if isAdmin();
    }

    /* ===== LESSONS ===== */
    match /lessons/{docId} {
      allow read: if isAdmin() || (
        signedIn()
        && notBlocked()
        && (
          (("level" in resource.data) && canReadLevel(resource.data.level))
          || (("level" in resource.data) && resource.data.level == "A1")
          || !("level" in resource.data)
        )
      );
      allow write: if isAdmin();
    }

/* ===== COURSE META (treść lekcji) =====
       docId: "A1__slug" / "A2__slug" / "B1__slug" / "B2__slug"
    */
    match /course_meta/{docId} {
      allow read: if isAdmin() || (
        signedIn() && notBlocked() && (
          (docId.matches("^A1__.*"))
          || (docId.matches("^A2__.*") && canReadLevel("A2"))
          || (docId.matches("^B1__.*") && canReadLevel("B1"))
          || (docId.matches("^B2__.*") && canReadLevel("B2"))
        )
      );

      allow write: if isAdmin();
    }

    /* ===== EXERCISES =====
       Każdy exercise doc powinien mieć pole: level: "A1"/"A2"/"B1"/"B2"
    */
    match /exercises/{id} {
      allow read: if isAdmin() || (
        signedIn() && notBlocked() && (
          (("level" in resource.data) && canReadLevel(resource.data.level))
          || (("level" in resource.data) && resource.data.level == "A1")
        )
      );

      allow write: if isAdmin();
    }

    /* ===== DRIVING MATERIALS ===== */
    match /{collectionId}/{id} {
      allow read: if
        [
          "driving_vocab",
          "driving_signs",
          "driving_faq",
          "driving_checklist",
          "driving_dialogues",
          "driving_exam_traps",
          "driving_audio",
          "driving_images",
          "driving_abbr",
          "driving_quiz"
        ].hasAny([collectionId])
        && signedIn()
        && notBlocked();
      allow write: if
        [
          "driving_vocab",
          "driving_signs",
          "driving_faq",
          "driving_checklist",
          "driving_dialogues",
          "driving_exam_traps",
          "driving_audio",
          "driving_images",
          "driving_abbr",
          "driving_quiz"
        ].hasAny([collectionId])
        && isAdmin();
    }

    /* ===== SERVICES (OFERTA) ===== */
    match /services/{id} {
      allow read: if true;
      allow create, update, delete: if isAdmin();
    }

    /* ===== PROMO CODES ===== */
    match /promo_codes/{codeId} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    /* ===== SITE SETTINGS ===== */
    match /site_settings/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    /* ===== PROGRESS ===== */
    match /user_progress/{uid}/topics/{topicId} {
      allow read, write: if isAdmin() || isOwner(uid);
    }

    /* ===== REVIEWS / RATINGS ===== */
    match /reviews/{id} {
      allow read: if isAdmin() || (signedIn() && resource.data.userId == request.auth.uid);
      allow create: if signedIn()
        && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (signedIn() && resource.data.userId == request.auth.uid);
      allow delete: if isAdmin();
    }

    /* ===== REFERRALS / REWARDS (jak miałaś) ===== */
    match /referrals/{id} {
      allow read: if isAdmin() || (signedIn() && resource.data.ownerUid == request.auth.uid);
      allow create: if signedIn()
        && request.resource.data.newUserUid == request.auth.uid
        && request.resource.data.status == "PENDING";
      allow update, delete: if isAdmin();
    }

    match /rewards/{id} {
      allow read: if isAdmin() || (signedIn() && resource.data.ownerUid == request.auth.uid);
      allow write: if isAdmin();
    }

    /* ===== SPACED REPETITION ===== */
    match /user_spaced/{uid}/cards/{cardId} {
      allow read, write: if isAdmin() || isOwner(uid);
    }

    /* ===== AUDIO LIBRARY ===== */
    match /audio_library/{id} {
      allow read, write: if isAdmin();
    }

    /* ===== APP LOGS ===== */
    match /app_logs/{id} {
      allow read: if isAdmin();
      allow create: if signedIn();
      allow update: if false;
      allow delete: if isAdmin();
    }

    /* ===== PAGE VIEWS ===== */
    match /page_views/{id} {
      allow read: if isAdmin();
      allow create: if signedIn();
      allow update, delete: if false;
    }

    /* ===== USER REPORTS ===== */
    match /user_reports/{id} {
      allow read: if isAdmin();
      allow create: if signedIn() && (isAdmin() || request.resource.data.userId == request.auth.uid);
      allow update, delete: if isAdmin();
    }

    /* ===== CONTACT FORM (index) ===== */
    match /contact_messages/{id} {
      allow read, update, delete: if isAdmin();
      allow create: if
        request.resource.data.email is string
        && request.resource.data.message is string
        && request.resource.data.email.size() > 3
        && request.resource.data.email.size() <= 254
        && request.resource.data.message.size() > 0
        && request.resource.data.message.size() <= 4000;
    }

    /* ===== PUBLIC PROFILES ===== */
    match /public_users/{uid} {
      allow read: if signedIn();
      allow create, update: if isAdmin() || isOwner(uid);
      allow delete: if isAdmin();
    }

    /* ===== FRIEND REQUESTS ===== */
    match /friend_requests/{id} {
      allow read: if isAdmin() || (
        signedIn()
        && idHasUid(id, request.auth.uid)
      );

      allow create: if signedIn()
        && request.resource.data.keys().hasOnly(["fromUid","toUid","status","createdAt","updatedAt"])
        && request.resource.data.fromUid == request.auth.uid
        && request.resource.data.toUid is string
        && request.resource.data.toUid != request.auth.uid
        && id == (request.resource.data.fromUid + "__" + request.resource.data.toUid)
        && !isBlocked(request.resource.data.fromUid, request.resource.data.toUid)
        && allowsFriendRequests(request.resource.data.toUid)
        && request.resource.data.status == "pending";

      allow update: if signedIn()
        && request.resource.data.diff(resource.data).affectedKeys().hasOnly(["status","updatedAt"])
        && (
          isAdmin()
          || (
            resource.data.toUid == request.auth.uid
            && resource.data.status == "pending"
            && request.resource.data.status in ["accepted","declined"]
          )
          || (
            resource.data.fromUid == request.auth.uid
            && resource.data.status == "pending"
            && request.resource.data.status == "cancelled"
          )
          || (
            resource.data.fromUid == request.auth.uid
            && resource.data.status in ["declined","cancelled"]
            && request.resource.data.status == "pending"
            && !isBlocked(resource.data.fromUid, resource.data.toUid)
            && allowsFriendRequests(resource.data.toUid)
          )
        );

      allow delete: if isAdmin() || (signedIn() && (
        resource.data.fromUid == request.auth.uid || resource.data.toUid == request.auth.uid
      ));
    }

    /* ===== USER MESSAGES ===== */
    match /user_inbox/{uid}/messages/{msgId} {
      allow read: if isAdmin() || isOwner(uid);
      allow create: if signedIn()
        && request.resource.data.fromUid == request.auth.uid
        && request.resource.data.toUid is string
        && isFriends(request.resource.data.fromUid, request.resource.data.toUid)
        && !isBlocked(request.resource.data.fromUid, request.resource.data.toUid)
        && allowsMessages(request.resource.data.toUid)
        && (request.auth.uid == uid || request.resource.data.toUid == uid);
      allow update: if isOwner(uid);
      allow delete: if isAdmin() || isOwner(uid);
    }

    /* ===== SUPPORT AGENTS ===== */
    match /support_agents/{uid} {
      allow read: if signedIn();
      allow create, update, delete: if isAdmin();
    }

    /* ===== CONVERSATIONS (DM / GROUP / SUPPORT) ===== */
    match /conversations/{convId} {
      function isParticipant() {
        return ("participants" in resource.data)
          && (resource.data.participants is list)
          && resource.data.participants.hasAny([request.auth.uid]);
      }
      function isParticipantNew() {
        return ("participants" in request.resource.data)
          && (request.resource.data.participants is list)
          && request.resource.data.participants.hasAny([request.auth.uid]);
      }
      function isOwnerOrAdmin() {
        return request.auth.uid == resource.data.ownerId
          || (("admins" in resource.data)
            && (resource.data.admins is list)
            && resource.data.admins.hasAny([request.auth.uid]));
      }
      function joinModeOpen() {
        return !("joinMode" in resource.data) || resource.data.joinMode == "open";
      }
      function participantsCount() {
        return ("participants" in resource.data)
          && (resource.data.participants is list)
          ? resource.data.participants.size()
          : 0;
      }
      function keepsExistingParticipants() {
        return !("participants" in resource.data)
          || !(resource.data.participants is list)
          || request.resource.data.participants.hasAll(resource.data.participants);
      }
      function participantUpdateAllowedKeys() {
        return ["lastAt","lastMessage","lastMessageId","reads","typing","updatedAt"];
      }
      function joinUpdateAllowedKeys() {
        return ["participants","memberCount","reads","updatedAt"];
      }
      function isBanned(uid) {
        return exists(/databases/$(database)/documents/conversations/$(convId)/bans/$(uid));
      }

      allow read: if signedIn()
        && notBlocked()
        && (
          isAdmin()
          || (isSupport() && resource.data.type == "support")
          || isParticipant()
          || (resource.data.type == "group" && resource.data.public == true)
        );

      allow create: if signedIn()
        && notBlocked()
        && request.resource.data.createdBy == request.auth.uid
        && ("participants" in request.resource.data)
        && (request.resource.data.participants is list)
        && request.resource.data.participants.hasAny([request.auth.uid]);

      allow update: if signedIn()
        && notBlocked()
        && (
          isAdmin()
          || (isSupport() && resource.data.type == "support")
          || isOwnerOrAdmin()
          || (
            isParticipant()
            && request.resource.data.participants == resource.data.participants
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(participantUpdateAllowedKeys())
          )
          || (
            resource.data.type == "group"
            && joinModeOpen()
            && !isParticipant()
            && isParticipantNew()
            && !isBanned(request.auth.uid)
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(joinUpdateAllowedKeys())
            && request.resource.data.participants.size() == participantsCount() + 1
            && keepsExistingParticipants()
          )
          || (
            isParticipant()
            && !isParticipantNew()
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(joinUpdateAllowedKeys())
            && request.resource.data.participants.size() == participantsCount() - 1
            && resource.data.participants.hasAll(request.resource.data.participants)
          )
        );

      allow delete: if isAdmin() || isOwnerOrAdmin();

      match /messages/{msgId} {
        function canMessageRead() {
          return isAdmin()
            || (isSupport() && get(/databases/$(database)/documents/conversations/$(convId)).data.type == "support")
            || get(/databases/$(database)/documents/conversations/$(convId)).data.participants.hasAny([request.auth.uid]);
        }
        function senderUpdateKeys() {
          return ["text","textLower","tokens","attachments","attachmentNames","hasAttachments","editedAt","editedBy","deleted","deletedAt","deletedBy","replyTo","updatedAt"];
        }
        function reactionUpdateKeys() {
          return ["reactions","updatedAt"];
        }
        allow read: if signedIn()
          && notBlocked()
          && canMessageRead();
        allow create: if signedIn()
          && notBlocked()
          && request.resource.data.senderId == request.auth.uid
          && !isBanned(request.auth.uid)
          && get(/databases/$(database)/documents/conversations/$(convId)).data.participants.hasAny([request.auth.uid]);
        allow update: if isAdmin()
          || (
            request.auth.uid == resource.data.senderId
            && request.resource.data.senderId == resource.data.senderId
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(senderUpdateKeys())
          )
          || (
            signedIn()
            && notBlocked()
            && canMessageRead()
            && request.resource.data.senderId == resource.data.senderId
            && request.resource.data.diff(resource.data).affectedKeys().hasOnly(reactionUpdateKeys())
          );
        allow delete: if isAdmin()
          || request.auth.uid == resource.data.senderId;
      }

      match /audit/{auditId} {
        allow read: if isAdmin() || isSupport();
        allow create: if signedIn()
          && notBlocked()
          && get(/databases/$(database)/documents/conversations/$(convId)).data.participants.hasAny([request.auth.uid]);
        allow update, delete: if isAdmin();
      }

      match /requests/{reqId} {
        allow read: if isAdmin()
          || isSupport()
          || (signedIn() && resource.data.uid == request.auth.uid);
        allow create: if signedIn()
          && notBlocked()
          && request.resource.data.uid == request.auth.uid
          && get(/databases/$(database)/documents/conversations/$(convId)).data.type == "group"
          && get(/databases/$(database)/documents/conversations/$(convId)).data.joinMode == "approval"
          && !get(/databases/$(database)/documents/conversations/$(convId)).data.participants.hasAny([request.auth.uid])
          && !isBanned(request.auth.uid)
          && request.resource.data.status == "pending";
        allow update: if isAdmin()
          || (
            signedIn()
            && (
              (("admins" in get(/databases/$(database)/documents/conversations/$(convId)).data)
                && get(/databases/$(database)/documents/conversations/$(convId)).data.admins.hasAny([request.auth.uid]))
              || get(/databases/$(database)/documents/conversations/$(convId)).data.ownerId == request.auth.uid
            )
          );
        allow delete: if isAdmin()
          || (signedIn() && resource.data.uid == request.auth.uid)
          || (
            signedIn()
            && (
              (("admins" in get(/databases/$(database)/documents/conversations/$(convId)).data)
                && get(/databases/$(database)/documents/conversations/$(convId)).data.admins.hasAny([request.auth.uid]))
              || get(/databases/$(database)/documents/conversations/$(convId)).data.ownerId == request.auth.uid
            )
          );
      }

      match /bans/{uid} {
        allow read: if isAdmin() || isOwnerOrAdmin() || (signedIn() && request.auth.uid == uid);
        allow create, update, delete: if isAdmin() || isOwnerOrAdmin();
      }
    }

    /* ===== NOTIFICATIONS ===== */
    match /user_notifications/{uid}/items/{id} {
      allow read: if isAdmin() || isOwner(uid);
      allow create, update: if isAdmin() || isOwner(uid);
      allow delete: if isAdmin();
    }

    /* ===== USER SETTINGS ===== */
    match /user_settings/{uid} {
      allow read, write: if isOwner(uid);
    }

    /* ===== USER STATUS (PRESENCE) ===== */
    match /user_status/{uid} {
      allow read: if signedIn();
      allow write: if isOwner(uid);
    }

    /* ===== CONVERSATION SETTINGS (per user) ===== */
    match /users/{uid}/conversations/{convId} {
      allow read, write: if isOwner(uid);
    }

    /* ===== REPORTS ===== */
    match /reports/{reportId} {
      allow create: if signedIn() && notBlocked();
      allow read, update: if isAdmin() || isSupport();
      allow delete: if isAdmin();
    }

    /* ===== PUSH TOKENS ===== */
    match /user_push_tokens/{uid}/tokens/{token} {
      allow read, write: if isAdmin() || isOwner(uid);
    }

    /* ===== LOGIN INDEX ===== */
    match /login_index/{handle} {
      allow read: if true;
      allow create, update: if signedIn()
        && request.resource.data.uid == request.auth.uid;
      allow delete: if isAdmin() || (signedIn() && resource.data.uid == request.auth.uid);
    }

    /* ===== EMAIL INDEX (direct lookup only) ===== */
    match /email_index/{emailLower} {
      allow get: if signedIn();
      allow list: if false;
      allow create, update: if signedIn()
        && request.resource.data.uid == request.auth.uid
        && request.resource.data.emailLower == emailLower;
      allow delete: if isAdmin() || (signedIn() && resource.data.uid == request.auth.uid);
    }

    /* ===== USER FEED ===== */
    match /user_feed/{uid}/posts/{postId} {
      allow read: if canViewFeed(uid) || (
        signedIn()
        && notBlocked()
        && !isBlocked(request.auth.uid, uid)
        && resource.data.type == "correction"
      );
      allow create: if isOwner(uid)
        && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if isOwner(uid) || isAdmin();
    }

    match /user_feed/{uid}/posts/{postId}/comments/{commentId} {
      allow read: if canViewFeed(uid) || (
        signedIn()
        && notBlocked()
        && !isBlocked(request.auth.uid, uid)
        && isCorrectionPost(uid, postId)
      );
      allow create: if signedIn()
        && notBlocked()
        && !isBlocked(request.auth.uid, uid)
        && (isOwner(uid) || isFriends(request.auth.uid, uid) || isCorrectionPost(uid, postId))
        && request.resource.data.authorUid == request.auth.uid;
      allow update, delete: if isAdmin() || (
        signedIn()
        && resource.data.authorUid == request.auth.uid
      );
    }

    match /user_feed/{uid}/posts/{postId}/reactions/{reactionId} {
      allow read: if canViewFeed(uid) || (
        signedIn()
        && notBlocked()
        && !isBlocked(request.auth.uid, uid)
        && isCorrectionPost(uid, postId)
      );
      allow create: if signedIn()
        && notBlocked()
        && !isBlocked(request.auth.uid, uid)
        && request.resource.data.userId == request.auth.uid;
      allow update, delete: if signedIn()
        && notBlocked()
        && !isBlocked(request.auth.uid, uid)
        && resource.data.userId == request.auth.uid;
    }

    /* ===== COMMUNITY CORRECTIONS INDEX (read-only for users) ===== */
    match /community_corrections/{id} {
      allow read: if signedIn() && notBlocked();
      allow create, update, delete: if isAdmin();
    }

    /* ===== USER SAVES (private) ===== */
    match /user_saves/{uid}/collections/{colId} {
      allow read, create, update, delete: if isAdmin() || isOwner(uid);
    }
    match /user_saves/{uid}/items/{saveId} {
      allow read, create, update, delete: if isAdmin() || isOwner(uid);
    }

    /* ===== USER ACTIVITY (private) ===== */
    match /user_activity/{uid}/days/{dayId} {
      allow read, create, update, delete: if isAdmin() || isOwner(uid);
    }

    /* ===== USER FOLLOWS ===== */
    match /user_follows/{id} {
      allow read: if isAdmin() || (
        signedIn()
        && notBlocked()
      );
      allow create: if signedIn()
        && notBlocked()
        && request.resource.data.fromUid == request.auth.uid
        && request.resource.data.toUid is string
        && request.resource.data.toUid != request.auth.uid
        && !isBlocked(request.resource.data.fromUid, request.resource.data.toUid)
        && request.resource.id == request.auth.uid + "__" + request.resource.data.toUid;
      allow delete: if isAdmin() || (signedIn() && resource.data.fromUid == request.auth.uid);
      allow update: if false;
    }

    /* ===== USER BLOCKS ===== */
    match /user_blocks/{id} {
      allow read: if isAdmin() || (
        signedIn()
        && (
          resource.data.fromUid == request.auth.uid
          || resource.data.toUid == request.auth.uid
        )
      );
      allow create: if signedIn()
        && request.resource.data.fromUid == request.auth.uid
        && request.resource.data.toUid is string
        && request.resource.data.toUid != request.auth.uid
        && request.resource.id == request.auth.uid + "__" + request.resource.data.toUid;
      allow delete: if isAdmin() || (signedIn() && resource.data.fromUid == request.auth.uid);
      allow update: if false;
    }

    /* ===== BROADCASTS ===== */
    match /broadcasts/{id} {
      allow read: if signedIn();
      allow write: if isAdmin();
    }

    /* ===== PAYMENTS ===== */
    match /payments/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /payment_attempts/{id} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
