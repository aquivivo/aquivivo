<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Admin lecci√≥n | AquiVivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    :root{ --yellow:#FCD116; --blue:#003893; --red:#CE1126; --ink:#0b1b3f; }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Montserrat, Arial, sans-serif;
      min-height:100vh;
      background: linear-gradient(180deg, #001a4d, #003893, #001a4d);
      color:#fff;
    }

    .nav-glass{
      position: sticky; top: 0; z-index: 50;
      background: rgba(0, 56, 147, 0.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.14);
    }
    .nav-glass::after{
      content:""; display:block; height:3px;
      background: linear-gradient(90deg, var(--yellow), var(--blue), var(--red));
      opacity:.85;
    }
    .nav-inner{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding: 14px 16px; max-width: 1100px; margin: 0 auto;
      flex-wrap: wrap;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 180px; }
    .logo-flag{
      width:42px; height:42px; border-radius:999px;
      background: linear-gradient(180deg, var(--yellow) 0 33.33%, var(--blue) 33.33% 66.66%, var(--red) 66.66% 100%);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }
    .name{ font-family:"Playfair Display", serif; font-weight:900; font-size:24px; color:#fff; letter-spacing:.2px; }
    .nav-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding: 12px 16px; border-radius:999px; font-weight:900;
      cursor:pointer; text-decoration:none; white-space:nowrap;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.12);
      color:#fff;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{ transform: translateY(-2px); filter: brightness(1.03); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn-yellow{
      background: rgba(252, 209, 22, 0.95);
      border-color: rgba(252, 209, 22, 0.7);
      color: var(--ink);
    }
    .btn-red{
      background: rgba(206, 17, 38, 0.92);
      border-color: rgba(206, 17, 38, 0.8);
      color: #fff;
    }

    .container{ max-width: 1100px; margin: 0 auto; padding: 18px 16px 60px; }

    h1{
      font-family:"Playfair Display", serif;
      font-weight: 900;
      font-size: 40px;
      margin: 0 0 8px 0;
      line-height: 1.05;
      color: var(--yellow);
    }
    .subtitle{ opacity:0.9; margin: 0; line-height: 1.6; max-width: 980px; }

    .card{
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      padding: 16px;
      margin: 14px 0;
    }
    .sectionTitle{
      margin: 12px 0 10px;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: 0.3px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .metaRow{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; margin-top: 10px; }
    .pill{
      font-size: 12px; font-weight: 900; border-radius: 999px; padding: 8px 12px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.12);
      color: #fff;
    }
    .pill-yellow{ background: rgba(252, 209, 22, 0.95); color: var(--ink); border-color: rgba(252, 209, 22, 0.7); }
    .pill-green{ background: rgba(34,197,94,.14); border:1px solid rgba(34,197,94,.25); color:#eafff1; }
    .pill-red{ background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.22); color:#ffecec; }

    .formGrid{ display:grid; gap: 10px; grid-template-columns: repeat(2, minmax(0,1fr)); align-items:start; }
    @media (max-width: 860px){ .formGrid{ grid-template-columns: 1fr; } }
    .field{ display:grid; gap:6px; }
    .field label{ font-size: 12px; font-weight: 900; opacity:.92; letter-spacing:.2px; }
    .input, .select, textarea{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.12);
      color:#fff;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      font-family: Montserrat, Arial, sans-serif;
      font-weight: 700;
    }
    textarea{
      min-height: 320px;
      resize: vertical;
      line-height: 1.5;
      background: rgba(0,0,0,0.18);
      border-color: rgba(255,255,255,0.18);
    }
    .select{
      cursor:pointer;
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      padding-right: 42px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.92) 50%),
        linear-gradient(135deg, rgba(255,255,255,0.92) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }
    .select option{ background: var(--blue); color: #fff; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; margin-top: 10px; }
    .hintSmall{ font-size: 12px; opacity: .78; margin-top: 10px; line-height: 1.35; }

    #toast{
      display:none;
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 9999;
      padding: 12px 14px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing: 0.2px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(10px);
      max-width: min(920px, calc(100% - 24px));
      text-align:center;
    }
    .toast-ok{ background: rgba(6, 95, 70, 0.92); color: #fff; }
    .toast-bad{ background: rgba(185, 28, 28, 0.92); color: #fff; }
    .toast-warn{ background: rgba(252, 209, 22, 0.94); color: var(--ink); border-color: rgba(252, 209, 22, 0.7); }

    /* Preview */
    .previewBox{ border-radius: 16px; padding: 14px; background: rgba(0,0,0,0.18); border: 1px solid rgba(255,255,255,0.14); }
    .previewBox .lessonHtml{ line-height: 1.65; font-size: 15px; opacity: .97; white-space: normal; }
    .previewBox .lessonHtml h2, .previewBox .lessonHtml h3{ color: var(--yellow); margin: 18px 0 10px; }
    .previewBox .lessonHtml img{ max-width:100%; border-radius: 18px; border: 1px solid rgba(255,255,255,0.14); display:block; margin: 14px auto; }
  </style>
</head>

<body>
  <div id="appHeader"></div>

  <div class="nav-glass">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo-flag" aria-hidden="true"></div>
        <div class="name">AquiVivo</div>
      </div>
      <div class="nav-actions">
        <a class="btn" id="btnBackCourse" href="#">‚¨ÖÔ∏è Curso</a>
        <a class="btn btn-yellow" id="btnOpenLesson" href="#">üìñ Ver lecci√≥n</a>
        <a class="btn" id="btnOpenExercises" href="#">üß© Admin ejercicios</a>
        <button class="btn btn-red" id="btnLogout" type="button">Cerrar sesi√≥n</button>
      </div>
    </div>
  </div>

  <main class="page">
    <div class="container">

      <div class="card">
        <h1>Admin ‚Äî Lecci√≥n</h1>
        <p class="subtitle">Aqu√≠ editas el contenido de la lecci√≥n (HTML) y sus metadatos. Los ejercicios se gestionan en la p√°gina de ejercicios.</p>
        <div class="metaRow">
          <span class="pill pill-yellow" id="pillLevel">Nivel: ‚Äî</span>
          <span class="pill" id="pillTopic">Tema: ‚Äî</span>
          <span class="pill" id="pillDoc">Doc: ‚Äî</span>
          <span class="pill" id="pillPub">‚Äî</span>
        </div>
      </div>

      <div class="card" id="adminOnly" style="display:none;">
        <div class="sectionTitle">üß© Meta</div>
        <div class="formGrid">
          <div class="field">
            <label for="titleInput">T√≠tulo</label>
            <input class="input" id="titleInput" placeholder="p. ej. Caso nominativo ‚Äî podstawy" />
          </div>
          <div class="field">
            <label for="typeSelect">Tipo</label>
            <select class="select" id="typeSelect">
              <option value="">‚Äî</option>
              <option value="grammar">Gram√°tica</option>
              <option value="vocab">Vocabulario</option>
              <option value="practice">Pr√°ctica</option>
              <option value="mixed">Mixto</option>
            </select>
          </div>
          <div class="field" style="grid-column: 1 / -1;">
            <label for="descInput">Descripci√≥n corta</label>
            <input class="input" id="descInput" placeholder="1‚Äì2 frases sobre la lecci√≥n" />
          </div>
          <div class="field">
            <label for="durationInput">Duraci√≥n (min)</label>
            <input class="input" id="durationInput" type="number" min="0" placeholder="p. ej. 45" />
          </div>
          <div class="field">
            <label for="publishedToggle">Publicado</label>
            <select class="select" id="publishedToggle">
              <option value="false">Borrador</option>
              <option value="true">Publicado</option>
            </select>
          </div>

          <div class="field" style="grid-column: 1 / -1;">
            <label for="htmlArea">Contenido (HTML)</label>
            <textarea id="htmlArea" placeholder="<h2>...</h2>"></textarea>
            <div class="hintSmall">Tip: puedes pegar HTML con <code>&lt;h2&gt;</code>, listas, im√°genes, tablas. Esto se mostrar√° en <b>lessonpage.html</b>.</div>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="btnLoad" type="button">üîÑ Recargar</button>
          <button class="btn btn-yellow" id="btnSave" type="button">üíæ Guardar</button>
        </div>
      </div>

      <div class="card" id="noAdmin" style="display:none;">
        <div class="sectionTitle">‚õî Acceso denegado</div>
        <div class="hintSmall">Este panel es solo para admin.</div>
      </div>

      <div class="card">
        <div class="sectionTitle">üëÅÔ∏è Vista previa</div>
        <div class="previewBox">
          <div id="previewTitle" style="font-weight:900; font-size:18px; margin-bottom:8px;">‚Äî</div>
          <div id="previewDesc" style="opacity:.9; margin-bottom:10px;">‚Äî</div>
          <div id="previewBody" class="lessonHtml"></div>
        </div>
      </div>

      <div id="toast"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM",
      authDomain: "aquivivo-platform.firebaseapp.com",
      projectId: "aquivivo-platform",
      storageBucket: "aquivivo-platform.firebasestorage.app",
      messagingSenderId: "116115622011",
      appId: "1:116115622011:web:33a4a583eba4368071bade"
    };

    const ADMIN_EMAILS = ["aquivivo.pl@gmail.com"];
    const isAdmin = (email) => ADMIN_EMAILS.some(a => (a||"").toLowerCase() === (email||"").toLowerCase());

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    const toast = $("toast");
    const btnLogout = $("btnLogout");
    const btnBackCourse = $("btnBackCourse");
    const btnOpenLesson = $("btnOpenLesson");
    const btnOpenExercises = $("btnOpenExercises");

    const pillLevel = $("pillLevel");
    const pillTopic = $("pillTopic");
    const pillDoc = $("pillDoc");
    const pillPub = $("pillPub");

    const adminOnly = $("adminOnly");
    const noAdmin = $("noAdmin");

    const titleInput = $("titleInput");
    const descInput = $("descInput");
    const typeSelect = $("typeSelect");
    const durationInput = $("durationInput");
    const publishedToggle = $("publishedToggle");
    const htmlArea = $("htmlArea");

    const btnLoad = $("btnLoad");
    const btnSave = $("btnSave");

    const previewTitle = $("previewTitle");
    const previewDesc = $("previewDesc");
    const previewBody = $("previewBody");

    const params = new URLSearchParams(location.search);
    const LEVEL = (params.get("level") || "").toUpperCase();
    const TOPIC_ID = (params.get("id") || "").trim();
    const DOC_ID = `${LEVEL}__${TOPIC_ID}`;

    btnBackCourse.href = `course.html?level=${encodeURIComponent(LEVEL)}`;
    btnOpenLesson.href = `lessonpage.html?level=${encodeURIComponent(LEVEL)}&id=${encodeURIComponent(TOPIC_ID)}`;
    btnOpenExercises.href = `ejercicioadmin.html?level=${encodeURIComponent(LEVEL)}&id=${encodeURIComponent(TOPIC_ID)}`;

    function showToast(msg, kind="toast-ok"){
      if(!toast) return;
      toast.className = kind;
      toast.textContent = msg;
      toast.style.display = "block";
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=>{ toast.style.display = "none"; }, 2500);
    }

    function setMetaPills(published){
      pillLevel.textContent = `Nivel: ${LEVEL || "‚Äî"}`;
      pillTopic.textContent = `Tema: ${TOPIC_ID || "‚Äî"}`;
      pillDoc.textContent = `Doc: ${DOC_ID || "‚Äî"}`;
      pillPub.className = "pill " + (published ? "pill-green" : "pill-red");
      pillPub.textContent = published ? "Publicado" : "Borrador";
    }

    function renderPreview(){
      const t = (titleInput.value || "").trim();
      const d = (descInput.value || "").trim();
      const h = (htmlArea.value || "").trim();

      previewTitle.textContent = t || "‚Äî";
      previewDesc.textContent = d || "‚Äî";
      previewBody.innerHTML = h || "<div style='opacity:.8'>Sin contenido todav√≠a.</div>";
    }

    async function loadDoc(){
      if(!LEVEL || !TOPIC_ID){
        showToast("Faltan par√°metros en la URL (level, id).", "toast-bad");
        return;
      }

      setMetaPills(false);

      const ref = doc(db, "course_meta", DOC_ID);
      const snap = await getDoc(ref);

      if(!snap.exists()){
        // empty
        titleInput.value = "";
        descInput.value = "";
        typeSelect.value = "";
        durationInput.value = "";
        publishedToggle.value = "false";
        htmlArea.value = "";
        setMetaPills(false);
        renderPreview();
        return;
      }

      const d = snap.data() || {};
      titleInput.value = d.title || "";
      descInput.value = d.desc || "";
      typeSelect.value = d.type || "";
      durationInput.value = (d.durationMin ?? "") === 0 ? "" : (d.durationMin ?? "");
      publishedToggle.value = d.published ? "true" : "false";
      htmlArea.value = d.html || "";

      setMetaPills(!!d.published);
      renderPreview();
    }

    async function saveDoc(){
      const title = (titleInput.value || "").trim();
      const desc = (descInput.value || "").trim();
      const type = (typeSelect.value || "").trim();
      const durationMin = Number(durationInput.value || 0);
      const published = publishedToggle.value === "true";
      const html = (htmlArea.value || "").trim();

      const payload = {
        title, desc, type,
        durationMin: durationMin > 0 ? durationMin : 0,
        published,
        html,
        updatedAt: serverTimestamp()
      };

      // Create createdAt only on first save (merge + if missing)
      const ref = doc(db, "course_meta", DOC_ID);
      const snap = await getDoc(ref);
      if(!snap.exists()){
        payload.createdAt = serverTimestamp();
      }

      await setDoc(ref, payload, { merge: true });
      setMetaPills(published);
      renderPreview();
      showToast("Guardado ‚úÖ", "toast-ok");
    }

    btnLoad.addEventListener("click", async ()=>{
      try{ await loadDoc(); showToast("Recargado", "toast-warn"); }catch(e){ console.error(e); showToast("Error al recargar.", "toast-bad"); }
    });
    btnSave.addEventListener("click", async ()=>{
      try{ await saveDoc(); }catch(e){ console.error(e); showToast("Error al guardar.", "toast-bad"); }
    });
    htmlArea.addEventListener("input", ()=>{ try{ renderPreview(); }catch(e){} });

    btnLogout.addEventListener("click", async ()=>{
      try{ await signOut(auth); }catch(e){}
      location.href = "login.html";
    });

    onAuthStateChanged(auth, async (user)=>{
      if(!user){
        location.href = "login.html";
        return;
      }
      if(!isAdmin(user.email)){
        adminOnly.style.display = "none";
        noAdmin.style.display = "block";
        return;
      }
      adminOnly.style.display = "block";
      noAdmin.style.display = "none";
      try{ await loadDoc(); }catch(e){ console.error(e); showToast("Error cargando doc.", "toast-bad"); }
    });
  </script>
</body>
</html>
