rules_version = '2';
service firebase.storage {
  match /b/{bucket}/o {
    function signedIn() {
      return request.auth != null;
    }

    function isAdmin() {
      return signedIn() && request.auth.token.email == "aquivivo.pl@gmail.com";
    }

    function isSupport() {
      return signedIn()
        && firestore.get(/databases/$(database)/documents/support_agents/$(request.auth.uid)).exists();
    }

    function convDoc(convId) {
      return firestore.get(/databases/$(database)/documents/conversations/$(convId));
    }

    function isParticipant(convId) {
      return signedIn()
        && convDoc(convId).data.participants.hasAny([request.auth.uid]);
    }

    function canReadChat(convId) {
      return isAdmin()
        || isParticipant(convId)
        || (isSupport() && convDoc(convId).data.type == "support");
    }

    function canWriteChat(convId) {
      return isAdmin()
        || isParticipant(convId)
        || (isSupport() && convDoc(convId).data.type == "support");
    }

    match /avatars/{uid}/{file} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && request.auth.uid == uid;
    }
    match /audio/flashcards/{folder}/{file} {
      allow read: if true;
      allow write: if request.auth != null
        && request.auth.token.email == "aquivivo.pl@gmail.com";
    }
    match /audio/library/{allPaths=**} {
      allow read: if true;
      allow write: if request.auth != null
        && request.auth.token.email == "aquivivo.pl@gmail.com";
    }

    match /chat/{convId}/{allPaths=**} {
      allow read: if canReadChat(convId);
      allow write: if canWriteChat(convId)
        && request.resource.size < 25 * 1024 * 1024;
    }
  }
}
