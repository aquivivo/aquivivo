<!doctype html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Lecci√≥n | AquiVivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800;900&family=Playfair+Display:wght@700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    :root{ --yellow:#FCD116; --blue:#003893; --red:#CE1126; --ink:#0b1b3f; }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: Montserrat, Arial, sans-serif;
      min-height:100vh;
      background: linear-gradient(180deg, #001a4d, #003893, #001a4d);
      color:#fff;
    }

    /* === NAV + UI (sp√≥jne z lesson.html) === */
    .nav-glass{
      position: sticky; top: 0; z-index: 50;
      background: rgba(0, 56, 147, 0.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255, 255, 255, 0.14);
    }
    .nav-glass::after{
      content:""; display:block; height:3px;
      background: linear-gradient(90deg, var(--yellow), var(--blue), var(--red));
      opacity:.85;
    }
    .nav-inner{
      display:flex; align-items:center; justify-content:space-between; gap:14px;
      padding: 14px 16px; max-width: 1100px; margin: 0 auto;
      flex-wrap: wrap;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 180px; }
    .logo-flag{
      width:42px; height:42px; border-radius:999px;
      background: linear-gradient(180deg, var(--yellow) 0 33.33%, var(--blue) 33.33% 66.66%, var(--red) 66.66% 100%);
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }
    .name{ font-family:"Playfair Display", serif; font-weight:900; font-size:24px; color:#fff; letter-spacing:.2px; }
    .nav-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:flex-end; }
.btn{
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      padding: 12px 16px; border-radius:999px; font-weight:900;
      cursor:pointer; text-decoration:none; white-space:nowrap;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.12);
      color:#fff;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }
    .btn:hover{ transform: translateY(-2px); filter: brightness(1.03); }
    .btn:disabled{ opacity:.6; cursor:not-allowed; transform:none; }
    .btn-yellow{
      background: rgba(252, 209, 22, 0.95);
      border-color: rgba(252, 209, 22, 0.7);
      color: var(--ink);
    }
    .btn-red{
      background: rgba(206, 17, 38, 0.92);
      border-color: rgba(206, 17, 38, 0.8);
      color: #fff;
    }

    .container{ max-width: 1100px; margin: 0 auto; padding: 18px 16px 60px; }
    h1{
      font-family:"Playfair Display", serif;
      font-weight: 900;
      font-size: 44px;
      margin: 18px 0 8px 0;
      line-height: 1.05;
      color: var(--yellow);
    }
    @media (max-width: 860px){ h1{ font-size: 36px; } }
    .subtitle{ opacity:0.9; margin: 0 0 12px 0; line-height: 1.6; max-width: 980px; }

    .card{
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      padding: 16px;
      margin: 14px 0;
    }

    .metaRow{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; margin-top: 8px; }
    .pill{
      font-size: 12px; font-weight: 900; border-radius: 999px; padding: 6px 10px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.12);
      color: #fff;
    }
    .pill-yellow{ background: rgba(252, 209, 22, 0.95); color: var(--ink); border-color: rgba(252, 209, 22, 0.7); }
    .pill-green{ background: rgba(34,197,94,.14); border:1px solid rgba(34,197,94,.25); color:#eafff1; }
    .pill-red{ background: rgba(239,68,68,.12); border:1px solid rgba(239,68,68,.22); color:#ffecec; }

    .sectionTitle{
      margin: 22px 0 10px;
      font-size: 16px;
      font-weight: 900;
      letter-spacing: 0.3px;
      display:flex;
      align-items:center;
      gap:10px;
    }

    /* === Lesson content === */
    .lessonHtml{ line-height: 1.65; font-size: 15px; opacity: .97; white-space: normal; }
    .lessonHtml h2, .lessonHtml h3{ color: var(--yellow); margin: 18px 0 10px; }
    .lessonHtml img{
      max-width:100%;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      display:block;
      margin: 14px auto;
    }
    .empty{ opacity:.78; font-size: 14px; padding: 10px 0; }
    .errorBox{
      background: rgba(239,68,68,.14);
      border: 1px solid rgba(239,68,68,.30);
      border-radius: 16px;
      padding: 12px 14px;
      color: #ffecec;
      font-weight: 800;
      line-height: 1.45;
      display:none;
      margin-top: 10px;
    }

    /* === Admin CMS === */
    .adminWrap{ display:none; }
    .adminHead{
      display:flex; align-items:center; justify-content: space-between;
      gap: 10px; flex-wrap: wrap; margin-bottom: 10px;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding: 8px 12px; border-radius: 999px;
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.12);
      font-weight: 900; font-size: 12px;
    }
    .adminRight{ display:flex; gap:10px; flex-wrap: wrap; align-items:center; justify-content:flex-end; }

    .toggle{
      display:inline-flex; align-items:center; gap:10px;
      padding: 8px 12px; border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      font-weight: 900; cursor:pointer; user-select:none;
    }
    .toggle input{ width: 16px; height: 16px; }

    .mini{
      padding: 10px 12px;
      border-radius: 999px;
      font-weight: 900;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.10);
      color:#fff;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
    }
    .mini:hover{ filter:brightness(1.06); transform: translateY(-1px); }
    .mini-yellow{ background: rgba(252,209,22,.95); border-color: rgba(252,209,22,.70); color: var(--ink); }
    .mini-red{ background: rgba(206,17,38,.20); border-color: rgba(206,17,38,.35); color:#fff; }

    .twoCols{ display:grid; gap: 12px; grid-template-columns: 1fr 1fr; align-items:start; }
    @media (max-width: 980px){ .twoCols{ grid-template-columns: 1fr; } }

    .formGrid{ display:grid; gap: 10px; grid-template-columns: repeat(2, minmax(0,1fr)); align-items:start; }
    @media (max-width: 860px){ .formGrid{ grid-template-columns: 1fr; } }
    .field{ display:grid; gap:6px; }
    .field label{ font-size: 12px; font-weight: 900; opacity:.92; letter-spacing:.2px; }
    .input, .select, textarea{
      width: 100%;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.12);
      color:#fff;
      padding: 10px 12px;
      font-size: 14px;
      outline: none;
      font-family: Montserrat, Arial, sans-serif;
      font-weight: 700;
    }
    textarea{
      min-height: 260px;
      resize: vertical;
      line-height: 1.5;
      background: rgba(0,0,0,0.18);
      border-color: rgba(255,255,255,0.18);
    }
    .input::placeholder, textarea::placeholder{ color: rgba(255,255,255,0.55); }
    .select{
      cursor:pointer;
      appearance:none; -webkit-appearance:none; -moz-appearance:none;
      padding-right: 42px;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,0.92) 50%),
        linear-gradient(135deg, rgba(255,255,255,0.92) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px);
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }
    .select option{ background: var(--blue); color: #fff; }

    .editorTools{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; margin-top:10px; }
    .toolRow{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .muted{ opacity:.85; }
    .hintSmall{ font-size: 12px; opacity: .78; margin-top: 8px; line-height: 1.35; }

    .historyList{ display:grid; gap: 10px; }
    .historyItem{
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 16px;
      padding: 12px;
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .historyMeta{ font-size: 12px; opacity:.9; line-height:1.35; }
    .historyMeta b{ color: var(--yellow); }
    .historyActions{ display:flex; gap: 8px; flex-wrap: wrap; }

    /* Toast */
    #toast{
      display:none;
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      z-index: 9999;
      padding: 12px 14px;
      border-radius: 999px;
      font-weight: 900;
      letter-spacing: 0.2px;
      box-shadow: 0 14px 30px rgba(0,0,0,0.28);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(10px);
      max-width: min(920px, calc(100% - 24px));
      text-align:center;
    }
    .toast-ok{ background: rgba(6, 95, 70, 0.92); color: #fff; }
    .toast-bad{ background: rgba(185, 28, 28, 0.92); color: #fff; }
    .toast-warn{ background: rgba(252, 209, 22, 0.94); color: var(--ink); border-color: rgba(252, 209, 22, 0.7); }
  </style>
</head>

<body>
  <div id="appHeader"></div>

  <nav class="nav-glass">
    <div class="nav-inner">
      <div class="brand">
        <div class="logo-flag" aria-hidden="true"></div>
        <div class="name">AquiVivo</div>
      </div>

      <div class="nav-actions">
        <a class="btn" id="btnBackCourse" href="#">‚¨ÖÔ∏è ATR√ÅS</a>
        <a class="btn" id="btnHome" href="index.html">üè† INICIO</a>
<button class="btn btn-red" id="btnLogout" type="button" style="display:none;">Wyloguj</button>
</div>
    </div>
  </nav>
<main class="page">
    <div class="container">
      <h1>AquiVivo ‚Äî Lekcja</h1>
      <p class="subtitle" id="subTitle">Cargando‚Ä¶</p>

      <div class="card">
        <div class="metaRow">
          <span class="pill" id="pillLevel">Nivel ‚Äî</span>
          <span class="pill" id="pillTopic">Tema ‚Äî</span>
          <span class="pill" id="pillDoc">docId ‚Äî</span>
          <span class="pill pill-red" id="pillPub" style="display:none;">No publicado</span>
          <span class="pill pill-green" id="pillPubOk" style="display:none;">Publicado</span>
        </div>

        <div class="sectionTitle">üìò Contenido de la lecci√≥n</div>
        <div id="errorBox" class="errorBox"></div>
        <div id="lessonContent" class="lessonHtml" style="display:none;"></div>
        <div id="lessonEmpty" class="empty" style="display:none;"></div>

        <div class="hintSmall" id="studentHint" style="display:none;">
          Esta lecci√≥n todav√≠a no est√° publicada. Vuelve m√°s tarde.
        </div>
      </div>

      <div class="adminWrap" id="adminWrap">
        <div class="card">
          <div class="adminHead">
            <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
              <div class="badge">üõ† Admin ‚Äî edici√≥n de lecci√≥n</div>
              <div class="badge" id="dirtyBadge" style="display:none;">‚ö†Ô∏è Cambios sin guardar</div>
              <div class="badge" id="savedBadge" style="display:none;">‚úÖ Guardado</div>
            </div>

            <div class="adminRight">
              <label class="toggle" title="Publicar / Borrador">
                <input type="checkbox" id="publishedToggle" />
                <span id="publishedLabel">Borrador</span>
              </label>
              <button class="mini" id="btnPreview" type="button">üëÅÔ∏è PodglƒÖd</button>
              <button class="mini mini-yellow" id="btnSaveDraft" type="button">üíæ Guardar</button>
              <button class="mini" id="btnPublish" type="button">üöÄ Publicar</button>
              <button class="mini mini-red" id="btnUnpublish" type="button">‚Ü©Ô∏è Ocultar</button>
            </div>
          </div>

          <div class="twoCols">
            <div>
              <div class="sectionTitle">üß© Meta</div>
              <div class="formGrid">
                <div class="field">
                  <label for="titleInput">T√≠tulo</label>
                  <input class="input" id="titleInput" placeholder="np. Caso nominativo ‚Äî podstawy" />
                </div>
                <div class="field">
                  <label for="typeSelect">Tipo</label>
                  <select class="select" id="typeSelect">
                    <option value="">‚Äî</option>
                    <option value="grammar">Gram√°tica</option>
                    <option value="vocab">Vocabulario</option>
                    <option value="practice">Pr√°ctica</option>
                    <option value="mixed">Mixto</option>
                  </select>
                </div>

                <div class="field" style="grid-column: 1 / -1;">
                  <label for="descInput">Descripci√≥n corta</label>
                  <input class="input" id="descInput" placeholder="1‚Äì2 zdania: co ucze≈Ñ umie po tej lekcji" />
                </div>

                <div class="field">
                  <label for="orderInput">Order</label>
                  <input class="input" id="orderInput" type="number" min="0" step="1" placeholder="np. 10" />
                </div>
                <div class="field">
                  <label for="tagsInput">Tags (comma)</label>
                  <input class="input" id="tagsInput" placeholder="np. casos, A1, di√°logo" />
                </div>
              </div>

              <div class="sectionTitle">üñºÔ∏è Imagen</div>
              <div class="formGrid">
                <div class="field" style="grid-column: 1 / -1;">
                  <label for="imgUrl">URL obrazu</label>
                  <input class="input" id="imgUrl" placeholder="https://..." />
                </div>
                <div class="field">
                  <label for="imgAlt">Alt</label>
                  <input class="input" id="imgAlt" placeholder="opis obrazka" />
                </div>
                <div class="field" style="display:flex; align-items:end;">
                  <button class="mini mini-yellow" id="btnInsertImg" type="button" style="width:100%;">‚ûï Wstaw do HTML</button>
                </div>
              </div>

              <div class="editorTools">
                <div class="toolRow">
                  
<select id="templateSelect" class="mini">
  <option value="">‚Äî Elegir plantilla ‚Äî</option>
  <option value="grammar">üìò Gram√°tica</option>
  <option value="vocab">üìó Vocabulario</option>
  <option value="dialog">üó£Ô∏è Di√°logo</option>
  <option value="review">üìù Repaso / Test</option>
</select>
<button class="mini" id="btnInsertTemplate" type="button">‚ûï Insertar plantilla</button>
<button class="mini" id="btnTemplate" type="button">‚ú® Szablon</button>
                  <button class="mini" id="btnLoadDraft" type="button">üß† Wczytaj draft</button>
                  <button class="mini mini-red" id="btnClearDraft" type="button">üßπ Usu≈Ñ draft</button>
                </div>
                <div class="toolRow">
                  <span class="muted" id="docInfo">docId: ‚Äî</span>
                </div>
              </div>

              <div class="hintSmall">
                ‚Ä¢ Ka≈ºdy zapis tworzy snapshot w <code>course_meta/{docId}/history</code> (ostatnie 10 wy≈õwietlane po prawej).<br>
                ‚Ä¢ Draft jest te≈º auto-zapisywany lokalnie (localStorage).
              </div>
            </div>

            <div>
              <div class="sectionTitle">‚úçÔ∏è HTML</div>
              <textarea id="htmlArea" placeholder="<h2>...</h2>"></textarea>

              <div class="editorTools">
                <div class="toolRow">
                  <button class="mini" id="btnFormatHint" type="button">‚ÑπÔ∏è Format</button>
                  <button class="mini" id="btnCopyLink" type="button">üîó Kopiuj link</button>
                </div>
                <div class="toolRow">
                  <span class="muted" id="updatedInfo">‚Äî</span>
                </div>
              </div>

              <div class="sectionTitle">üïò Historia wersji</div>
              <div id="historyList" class="historyList"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="toast"></div>
    </div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc,
      collection, addDoc, getDocs, query, orderBy, limit, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM",
      authDomain: "aquivivo-platform.firebaseapp.com",
      projectId: "aquivivo-platform",
      storageBucket: "aquivivo-platform.firebasestorage.app",
      messagingSenderId: "116115622011",
      appId: "1:116115622011:web:33a4a583eba4368071bade"
    };

    const ADMIN_EMAILS = ["aquivivo.pl@gmail.com"];
    const isAdmin = (email) => ADMIN_EMAILS.some(a => (a||"").toLowerCase() === (email||"").toLowerCase());

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const $ = (id) => document.getElementById(id);

    // Elements
const subTitleEl = $("subTitle");
    const pillLevel = $("pillLevel");
    const pillTopic = $("pillTopic");
    const pillDoc = $("pillDoc");
    const pillPub = $("pillPub");
    const pillPubOk = $("pillPubOk");
    const btnLogout = $("btnLogout");
    const btnBackCourse = $("btnBackCourse");
const errorBox = $("errorBox");
    const lessonContent = $("lessonContent");
    const lessonEmpty = $("lessonEmpty");
    const studentHint = $("studentHint");

    const adminWrap = $("adminWrap");
    const dirtyBadge = $("dirtyBadge");
    const savedBadge = $("savedBadge");
    const publishedToggle = $("publishedToggle");
    const publishedLabel = $("publishedLabel");
    const btnPreview = $("btnPreview");
    const btnSaveDraft = $("btnSaveDraft");
    const btnPublish = $("btnPublish");
    const btnUnpublish = $("btnUnpublish");

    const titleInput = $("titleInput");
    const typeSelect = $("typeSelect");
    const descInput = $("descInput");
    const orderInput = $("orderInput");
    const tagsInput = $("tagsInput");
    const imgUrl = $("imgUrl");
    const imgAlt = $("imgAlt");
    const btnInsertImg = $("btnInsertImg");

    const btnTemplate = $("btnTemplate");
    const btnLoadDraft = $("btnLoadDraft");
    const btnClearDraft = $("btnClearDraft");
    const docInfo = $("docInfo");

    const htmlArea = $("htmlArea");
    const btnFormatHint = $("btnFormatHint");
    const btnCopyLink = $("btnCopyLink");
    const updatedInfo = $("updatedInfo");
    const historyList = $("historyList");
    const toast = $("toast");

    // State
    const params = new URLSearchParams(location.search);
    const LEVEL = (params.get("level") || "").toUpperCase();
    const TOPIC_ID = (params.get("id") || "").trim();
    const DOC_ID = `${LEVEL}__${TOPIC_ID}`;

    // Links (navigation)
    const btnHome = $("btnHome");
    btnBackCourse.href = `course.html?level=${encodeURIComponent(LEVEL)}`;
    if(btnHome) btnHome.href = "index.html";

    // Some browsers/extensions block dynamic href updates on cached pages; this makes it bulletproof.
    btnBackCourse.addEventListener("click", (e)=>{
      e.preventDefault();
      location.href = `course.html?level=${encodeURIComponent(LEVEL)}`;
    });
let currentUser = null;
    let adminMode = false;
    let previewOn = false;
    let dirty = false;

    // Links + meta
pillLevel.textContent = `Nivel ${LEVEL || "‚Äî"}`;
    pillTopic.textContent = `Tema: ${TOPIC_ID || "‚Äî"}`;
    pillDoc.textContent = `docId: ${DOC_ID}`;
    docInfo.textContent = `docId: ${DOC_ID}`;
    subTitleEl.textContent = `Nivel ${LEVEL || "‚Äî"} ‚Ä¢ Tema: ${TOPIC_ID || "‚Äî"}`;

    function showToast(type, msg){
      toast.className = "";
      toast.style.display = "block";
      toast.textContent = msg;
      toast.classList.add(type);
      setTimeout(()=>{ toast.style.display = "none"; }, 2600);
    }

    function setDirty(v){
      dirty = v;
      dirtyBadge.style.display = dirty ? "inline-flex" : "none";
      if(dirty) savedBadge.style.display = "none";
    }

    function setError(msg){
      errorBox.style.display = "block";
      errorBox.textContent = msg;
    }

    function escapeHtml(s){
      return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function parseTags(s){
      return (s||"").split(",").map(x=>x.trim()).filter(Boolean).slice(0, 20);
    }

    function toIntOrNull(v){
      const n = Number(v);
      return Number.isFinite(n) ? n : null;
    }

    function draftKey(){ return `aquivivo_lessonpage_draft__${DOC_ID}`; }

    function collectForm(forcePublished){
      return {
        level: LEVEL || null,
        topicSlug: TOPIC_ID || null,
        title: (titleInput.value||"").trim() || null,
        description: (descInput.value||"").trim() || null,
        type: (typeSelect.value||"").trim() || null,
        order: toIntOrNull(orderInput.value),
        tags: parseTags(tagsInput.value),
        html: htmlArea.value || "",
        published: forcePublished ? true : !!publishedToggle.checked,
      };
    }

    function setPublishedUI(isPub){
      publishedToggle.checked = !!isPub;
      publishedLabel.textContent = isPub ? "Publicado" : "Borrador";
    }

    function saveLocalDraft(){
      const data = collectForm(false);
      localStorage.setItem(draftKey(), JSON.stringify({ ts: Date.now(), data }));
    }
    function loadLocalDraft(){
      const raw = localStorage.getItem(draftKey());
      if(!raw) return null;
      try{ return JSON.parse(raw); }catch(e){ return null; }
    }
    function clearLocalDraft(){ localStorage.removeItem(draftKey()); }

    function insertAtCursor(text){
      const start = htmlArea.selectionStart ?? htmlArea.value.length;
      const end = htmlArea.selectionEnd ?? htmlArea.value.length;
      htmlArea.value = htmlArea.value.slice(0, start) + text + htmlArea.value.slice(end);
      const pos = start + text.length;
      htmlArea.setSelectionRange(pos, pos);
      htmlArea.focus();
      setDirty(true);
    }

    function renderLesson(docData){
      errorBox.style.display = "none";
      const pub = !!docData?.published;

      pillPubOk.style.display = pub ? "inline-flex" : "none";
      pillPub.style.display = pub ? "none" : "inline-flex";

      if(!adminMode && !pub){
        lessonContent.style.display = "none";
        lessonEmpty.style.display = "none";
        studentHint.style.display = "block";
        return;
      }
      studentHint.style.display = "none";

      const html = (docData?.html || "").trim();
      if(!html){
        lessonContent.style.display = "none";
        lessonEmpty.style.display = "block";
        lessonEmpty.textContent = "Brak tre≈õci lekcji. (Admin mo≈ºe jƒÖ dodaƒá poni≈ºej.)";
        return;
      }
      lessonEmpty.style.display = "none";
      lessonContent.style.display = "block";
      lessonContent.innerHTML = html;
    }

    async function saveSnapshot(data){
      try{
        await addDoc(collection(db, "course_meta", DOC_ID, "history"), {
          ...data,
          savedAt: serverTimestamp(),
          savedBy: currentUser?.email || null
        });
      }catch(e){ /* snapshot failure shouldn't block save */ }
    }

    async function loadHistory(){
      historyList.innerHTML = `<div class="muted">Cargando‚Ä¶</div>`;
      try{
        const q = query(collection(db, "course_meta", DOC_ID, "history"), orderBy("savedAt", "desc"), limit(10));
        const snap = await getDocs(q);
        if(snap.empty){
          historyList.innerHTML = `<div class="muted">Brak historii.</div>`;
          return;
        }
        const items = [];
        snap.forEach(docu => items.push({ id: docu.id, ...(docu.data()||{}) }));
        historyList.innerHTML = "";
        for(const it of items){
          const ts = it.savedAt?.toDate ? it.savedAt.toDate() : null;
          const when = ts ? ts.toLocaleString() : "‚Äî";
          const pub = it.published ? "Publicado" : "Borrador";
          const title = it.title || "‚Äî";
          const by = it.savedBy || "‚Äî";
          const row = document.createElement("div");
          row.className = "historyItem";
          row.innerHTML = `
            <div class="historyMeta">
              <div><b>${escapeHtml(title)}</b> <span class="muted">(${escapeHtml(pub)})</span></div>
              <div class="muted">üïò ${escapeHtml(when)} ‚Ä¢ üë§ ${escapeHtml(by)}</div>
            </div>
            <div class="historyActions">
              <button class="mini" type="button" data-restore="${escapeHtml(it.id)}">‚Ü©Ô∏è Przywr√≥ƒá</button>
            </div>
          `;
          historyList.appendChild(row);
        }
        historyList.querySelectorAll("button[data-restore]").forEach(btn=>{
          btn.addEventListener("click", async ()=>{
            const id = btn.getAttribute("data-restore");
            if(!id) return;
            try{
              const hRef = doc(db, "course_meta", DOC_ID, "history", id);
              const s = await getDoc(hRef);
              if(!s.exists()){
                showToast("toast-bad", "Nie znaleziono wersji.");
                return;
              }
              const d = s.data() || {};
              titleInput.value = d.title || "";
              descInput.value = d.description || "";
              typeSelect.value = d.type || "";
              orderInput.value = (d.order ?? "") === null ? "" : (d.order ?? "");
              tagsInput.value = Array.isArray(d.tags) ? d.tags.join(", ") : "";
              htmlArea.value = d.html || "";
              setPublishedUI(!!d.published);
              setDirty(true);
              showToast("toast-warn", "Wersja wczytana do edytora (nie zapisana).");
              if(previewOn) renderLesson({ ...d, html: htmlArea.value, published: publishedToggle.checked });
            }catch(e){
              showToast("toast-bad", "Nie uda≈Ço siƒô przywr√≥ciƒá wersji.");
            }
          });
        });
      }catch(e){
        historyList.innerHTML = `<div class="muted">Nie uda≈Ço siƒô wczytaƒá historii.</div>`;
      }
    }

    async function saveLesson({ forcePublished=false } = {}){
      if(!LEVEL || !TOPIC_ID){
        setError("Brakuje parametr√≥w w URL. Otw√≥rz np. lessonpage.html?level=A1&id=twojTopicSlug");
        return;
      }
      const data = collectForm(forcePublished);
      data.html = ensureCompletionFooter(data.html || "");

      const ref = doc(db, "course_meta", DOC_ID);
      const now = new Date();

      const payload = { ...data, updatedAt: serverTimestamp() };
      if(payload.published) payload.publishedAt = serverTimestamp();

      try{
        await setDoc(ref, payload, { merge: true });
        await saveSnapshot(payload);

        setDirty(false);
        savedBadge.style.display = "inline-flex";
        updatedInfo.textContent = `Zapisano: ${now.toLocaleString()}`;
        showToast("toast-ok", payload.published ? "Opublikowano ‚úÖ" : "Zapisano ‚úÖ");

        renderLesson(payload);
        await loadHistory();
      }catch(e){
        showToast("toast-bad", "B≈ÇƒÖd zapisu: " + (e?.message || String(e)));
      }
    }

    async function unpublish(){
      try{
        await updateDoc(doc(db, "course_meta", DOC_ID), { published: false, updatedAt: serverTimestamp() });
        setPublishedUI(false);
        showToast("toast-ok", "Ukryto (draft).");
        await initLoad();
      }catch(e){
        showToast("toast-bad", "Nie uda≈Ço siƒô ukryƒá.");
      }
    }

    function templateHtml(){
      return `
<h2>Cel lekcji</h2>
<ul>
  <li>‚Ä¶</li>
</ul>

<h2>Wyja≈õnienie</h2>
<p>Wyt≈Çumacz kr√≥tko i jasno‚Ä¶</p>

<h3>Przyk≈Çady</h3>
<ul>
  <li><b>Ja</b> ‚Ä¶</li>
  <li><b>Ty</b> ‚Ä¶</li>
</ul>

<h2>Mini-dialog</h2>
<p><b>A:</b> ‚Ä¶<br><b>B:</b> ‚Ä¶</p>

<h2>Podsumowanie</h2>
<ul>
  <li>‚Ä¶</li>
</ul>
      `.trim();
    }

    async function initLoad(){
      // reset
      errorBox.style.display = "none";
      lessonContent.style.display = "none";
      lessonEmpty.style.display = "none";
      studentHint.style.display = "none";

      if(!LEVEL || !TOPIC_ID){
        setError("Brakuje parametr√≥w w URL. Otw√≥rz np. lessonpage.html?level=A1&id=twojTopicSlug");
        return;
      }

      try{
        const snap = await getDoc(doc(db, "course_meta", DOC_ID));

        if(!snap.exists()){
          setPublishedUI(false);
          renderLesson({ published:false, html:"" });
          if(adminMode){
            updatedInfo.textContent = "Brak dokumentu ‚Äî utw√≥rz pierwszƒÖ wersjƒô i kliknij Guardar.";
            await loadHistory();
          }
          // New lesson (no document yet) ‚Äî apply default template if editor is empty and no local draft
          try{
            const ld = loadLocalDraft();
            if(adminMode && !(ld?.data?.html || "").trim() && !htmlArea.value.trim()){
              // Use user-selected default from dropdown/localStorage
              if(typeof applyTemplate === "function") applyTemplate(templateSelectEl?.value || getDefaultTemplateKey());
            }
          }catch(e){}

          return;
        }

        const d = snap.data() || {};
        renderLesson(d);

        if(adminMode){
          titleInput.value = d.title || "";
          descInput.value = d.description || "";
          typeSelect.value = d.type || "";
          orderInput.value = (d.order ?? "") === null ? "" : (d.order ?? "");
          tagsInput.value = Array.isArray(d.tags) ? d.tags.join(", ") : "";
          htmlArea.value = d.html || "";
          setPublishedUI(!!d.published);

          const updated = d.updatedAt?.toDate ? d.updatedAt.toDate().toLocaleString() : "‚Äî";
          updatedInfo.textContent = `Ostatnia aktualizacja: ${updated}`;
          await loadHistory();
        }
      }catch(e){
        setError("Nie uda≈Ço siƒô pobraƒá tre≈õci lekcji. " + (e?.message || String(e)));
      }
    }

    // Events
    btnLogout.addEventListener("click", async ()=>{
      try{ await signOut(auth); location.href = "login.html"; }catch(e){}
    });

    publishedToggle.addEventListener("change", ()=>{
      setPublishedUI(publishedToggle.checked);
      setDirty(true);
      saveLocalDraft();
    });

    btnPreview.addEventListener("click", ()=>{
      previewOn = !previewOn;
      showToast("toast-warn", previewOn ? "PodglƒÖd ON" : "PodglƒÖd OFF");
      if(previewOn) renderLesson({ published: publishedToggle.checked, html: htmlArea.value });
      else initLoad();
    });

    btnSaveDraft.addEventListener("click", ()=> saveLesson({ forcePublished:false }));
    btnPublish.addEventListener("click", ()=> saveLesson({ forcePublished:true }));
    btnUnpublish.addEventListener("click", ()=> unpublish());

    btnTemplate.addEventListener("click", ()=>{
      if(htmlArea.value.trim()){
        if(!confirm("ZastƒÖpiƒá obecnƒÖ tre≈õƒá szablonem?")) return;
      }
      htmlArea.value = templateHtml();
      setDirty(true);
      saveLocalDraft();
      if(previewOn) renderLesson({ published: publishedToggle.checked, html: htmlArea.value });
    });

    btnLoadDraft.addEventListener("click", ()=>{
      const d = loadLocalDraft();
      if(!d?.data){ showToast("toast-bad", "Brak draftu."); return; }
      const x = d.data;
      titleInput.value = x.title || "";
      descInput.value = x.description || "";
      typeSelect.value = x.type || "";
      orderInput.value = (x.order ?? "") === null ? "" : (x.order ?? "");
      tagsInput.value = Array.isArray(x.tags) ? x.tags.join(", ") : "";
      htmlArea.value = x.html || "";
      setPublishedUI(!!x.published);
      setDirty(true);
      showToast("toast-warn", "Draft wczytany.");
      if(previewOn) renderLesson({ published: publishedToggle.checked, html: htmlArea.value });
    });

    btnClearDraft.addEventListener("click", ()=>{
      clearLocalDraft();
      showToast("toast-ok", "Draft usuniƒôty.");
    });

    btnInsertImg.addEventListener("click", ()=>{
      const url = (imgUrl.value || "").trim();
      if(!url){ showToast("toast-bad", "Wklej URL obrazka."); return; }
      const alt = (imgAlt.value || "").trim().replaceAll('"','&quot;');
      insertAtCursor(`\n<img src="${url}" alt="${alt}" />\n`);
      if(previewOn) renderLesson({ published: publishedToggle.checked, html: htmlArea.value });
      saveLocalDraft();
    });

    btnFormatHint.addEventListener("click", ()=>{
      showToast("toast-warn", "Tip: <h2>, <h3>, <p>, <ul><li>. Obrazy: <img src=\"...\" alt=\"...\" />");
    });

    btnCopyLink.addEventListener("click", async ()=>{
      try{ await navigator.clipboard.writeText(location.href); showToast("toast-ok", "Link skopiowany."); }
      catch(e){ showToast("toast-bad", "Nie uda≈Ço siƒô skopiowaƒá linku."); }
    });

    [titleInput, descInput, typeSelect, orderInput, tagsInput, htmlArea].forEach(el=>{
      el.addEventListener("input", ()=>{
        setDirty(true);
        saveLocalDraft();
        if(previewOn && el === htmlArea){
          renderLesson({ published: publishedToggle.checked, html: htmlArea.value });
        }
      });
    });


    // ===== AquiVivo templates (ES) + default template + footer =====
    const DEFAULT_TEMPLATE_KEY = "grammar"; // default for new lessons
    const TEMPLATE_SELECT_KEY = "aquivivo_template_default"; // localStorage key

    const COMPLETION_FOOTER = `
<hr style="border:0;border-top:1px solid rgba(255,255,255,0.18); margin:18px 0;">
<p style="font-size:18px; font-weight:900; color:white; margin:0;">
  ‚úÖ Lecci√≥n completada. ¬°Excelente trabajo! üéâ
</p>
`.trim();

    function ensureCompletionFooter(htmlStr){
      const s = (htmlStr || "").trim();
      if(!s) return s;
      // Prevent duplicates
      if(s.includes("Lecci√≥n completada")) return s;
      return (s + "\n\n" + COMPLETION_FOOTER).trim();
    }

    const TEMPLATES = {
      grammar: `
<div style="color:white; font-size:17px; line-height:1.75;">
<h2 style="font-size:28px;">üìò Gram√°tica ‚Äî Objetivo</h2>
<ul>
  <li>Hoy aprender√°s a: ‚Ä¶</li>
  <li>Usar correctamente: ‚Ä¶</li>
  <li>Evitar el error t√≠pico: ‚Ä¶</li>
</ul>

<h2 style="font-size:28px;">üß† Regla</h2>
<p>Explica la regla en 3‚Äì6 frases. Resalta lo clave con <b>negrita</b>.</p>

<h3 style="font-size:22px;">‚úÖ Estructura</h3>
<ul>
  <li><b>Patr√≥n:</b> ‚Ä¶</li>
  <li><b>Cu√°ndo se usa:</b> ‚Ä¶</li>
  <li><b>Cu√°ndo NO:</b> ‚Ä¶</li>
</ul>

<div style="background: rgba(252,209,22,0.95); color:#0b1b3f; padding:16px 18px; border-radius:14px; margin:18px 0; font-weight:900;">
  ‚ö†Ô∏è <b>Atenci√≥n:</b> ‚Ä¶ (una advertencia corta)
</div>

<h2 style="font-size:28px;">üîé Comparaci√≥n espa√±ol ‚Äì polaco</h2>
<ul>
  <li><b>ES:</b> ‚Ä¶</li>
  <li><b>PL:</b> ‚Ä¶</li>
  <li><b>Clave:</b> ‚Ä¶</li>
</ul>

<h2 style="font-size:28px;">‚úçÔ∏è Pr√°ctica</h2>
<h3 style="font-size:22px;">1) Completa</h3>
<ul><li>‚Ä¶</li></ul>
<h3 style="font-size:22px;">2) Elige la opci√≥n correcta</h3>
<ul><li>‚Ä¶</li></ul>

<h2 style="font-size:28px;">üèÖ Resumen</h2>
<ul>
  <li>Regla clave: ‚Ä¶</li>
  <li>Ejemplo modelo: ‚Ä¶</li>
</ul>
</div>`.trim(),

      vocab: `
<div style="color:white; font-size:17px; line-height:1.75;">
<h2 style="font-size:28px;">üìó Vocabulario ‚Äî Objetivo</h2>
<ul>
  <li>Aprender√°s: ‚Ä¶</li>
  <li>Podr√°s usarlo en: ‚Ä¶</li>
</ul>

<h2 style="font-size:28px;">üìå Lista de vocabulario</h2>
<ul>
  <li><b>palabra</b> ‚Äî traducci√≥n / explicaci√≥n breve</li>
  <li><b>expresi√≥n</b> ‚Äî ejemplo breve</li>
</ul>

<h2 style="font-size:28px;">‚úÖ Ejemplos</h2>
<ul>
  <li><b>Frase 1:</b> ‚Ä¶</li>
  <li><b>Frase 2:</b> ‚Ä¶</li>
</ul>

<h2 style="font-size:28px;">üéØ Pr√°ctica</h2>
<h3 style="font-size:22px;">1) Empareja</h3>
<ul><li>‚Ä¶</li></ul>
<h3 style="font-size:22px;">2) Completa</h3>
<ul><li>‚Ä¶</li></ul>

<h2 style="font-size:28px;">üèÖ Resumen</h2>
<ul>
  <li>Palabras clave: ‚Ä¶</li>
  <li>Expresi√≥n √∫til: ‚Ä¶</li>
</ul>
</div>`.trim(),

      dialog: `
<div style="color:white; font-size:17px; line-height:1.75;">
<h2 style="font-size:28px;">üó£Ô∏è Comunicaci√≥n ‚Äî Objetivo</h2>
<ul>
  <li>Hoy aprender√°s a comunicarte en: ‚Ä¶</li>
  <li>Podr√°s pedir, preguntar y responder.</li>
</ul>

<h2 style="font-size:28px;">üß≠ Situaci√≥n</h2>
<p>Contexto: ‚Ä¶</p>

<h2 style="font-size:28px;">üó®Ô∏è Di√°logo principal</h2>
<p>
  <b>A:</b> ‚Ä¶<br/>
  <b>B:</b> ‚Ä¶<br/>
  <b>A:</b> ‚Ä¶<br/>
  <b>B:</b> ‚Ä¶
</p>

<div style="background: rgba(252,209,22,0.95); color:#0b1b3f; padding:16px 18px; border-radius:14px; margin:18px 0; font-weight:900;">
  ‚≠ê <b>Frase clave:</b> ‚Ä¶
</div>

<h2 style="font-size:28px;">üé≠ Pr√°ctica (role-play)</h2>
<ul>
  <li>Responde: ‚Ä¶</li>
  <li>Cambia una palabra: ‚Ä¶</li>
</ul>

<h2 style="font-size:28px;">üèÖ Resumen</h2>
<ul>
  <li>Situaci√≥n: ‚Ä¶</li>
  <li>Frase clave: ‚Ä¶</li>
</ul>
</div>`.trim(),

      review: `
<div style="color:white; font-size:17px; line-height:1.75;">
<h2 style="font-size:28px;">üìù Repaso / Mini-test ‚Äî Objetivo</h2>
<ul>
  <li>Repasar lo aprendido en esta unidad.</li>
  <li>Comprobar tu progreso con un mini-examen.</li>
</ul>

<h2 style="font-size:28px;">üìå Recordatorio r√°pido</h2>
<ul>
  <li><b>Regla 1:</b> ‚Ä¶</li>
  <li><b>Regla 2:</b> ‚Ä¶</li>
  <li><b>Vocabulario clave:</b> ‚Ä¶</li>
</ul>

<h2 style="font-size:28px;">‚úÖ Parte A ‚Äî Opci√≥n m√∫ltiple (5)</h2>
<ol>
  <li>‚Ä¶ (A / B / C)</li>
  <li>‚Ä¶ (A / B / C)</li>
  <li>‚Ä¶ (A / B / C)</li>
  <li>‚Ä¶ (A / B / C)</li>
  <li>‚Ä¶ (A / B / C)</li>
</ol>

<h2 style="font-size:28px;">‚úçÔ∏è Parte B ‚Äî Completa (5)</h2>
<ol>
  <li>Yo ____ ‚Ä¶</li>
  <li>Ella ____ ‚Ä¶</li>
  <li>Nosotros ____ ‚Ä¶</li>
  <li>‚Ä¶</li>
  <li>‚Ä¶</li>
</ol>

<h2 style="font-size:28px;">üó£Ô∏è Parte C ‚Äî Producci√≥n (2)</h2>
<ul>
  <li>Escribe 5‚Äì7 frases sobre: ‚Ä¶</li>
  <li>Escribe un mini-di√°logo (6 l√≠neas) en la situaci√≥n: ‚Ä¶</li>
</ul>

<h2 style="font-size:28px;">üéØ Autoevaluaci√≥n</h2>
<ul>
  <li>‚òê Lo entiendo</li>
  <li>‚òê Lo puedo usar</li>
  <li>‚òê Necesito m√°s pr√°ctica</li>
</ul>
</div>`.trim()
    };

    const templateSelectEl = document.getElementById("templateSelect");
    const btnInsertTemplateEl = document.getElementById("btnInsertTemplate");

    function getDefaultTemplateKey(){
      return (localStorage.getItem(TEMPLATE_SELECT_KEY) || "").trim() || DEFAULT_TEMPLATE_KEY;
    }
    function setDefaultTemplateKey(k){
      localStorage.setItem(TEMPLATE_SELECT_KEY, k);
    }

    if(templateSelectEl){
      // Set default selection
      templateSelectEl.value = getDefaultTemplateKey();
      templateSelectEl.addEventListener("change", ()=>{
        if(templateSelectEl.value) setDefaultTemplateKey(templateSelectEl.value);
      });
    }

    function applyTemplate(key){
      const k = key || getDefaultTemplateKey();
      const tpl = TEMPLATES[k] || TEMPLATES[DEFAULT_TEMPLATE_KEY];
      htmlArea.value = ensureCompletionFooter(tpl);
      setDirty(true);
      saveLocalDraft();
      if(previewOn) renderLesson({ published: publishedToggle.checked, html: htmlArea.value });
    }

    if(btnInsertTemplateEl){
      btnInsertTemplateEl.addEventListener("click", ()=>{
        const key = templateSelectEl?.value || getDefaultTemplateKey();
        if(htmlArea.value.trim() !== ""){
          if(!confirm("¬øReemplazar el contenido actual con la plantilla?")) return;
        }
        applyTemplate(key);
      });
    }


    onAuthStateChanged(auth, async (user)=>{
      currentUser = user || null;
      const email = user?.email || "‚Äî";
adminMode = isAdmin(email);
      adminWrap.style.display = adminMode ? "block" : "none";
      btnLogout.style.display = user ? "inline-flex" : "none";

      if(adminMode && loadLocalDraft()?.ts){
        showToast("toast-warn", "Masz draft zapisany lokalnie (üß† Wczytaj draft).");
      }
      await initLoad();
    });
if(htmlArea.value.trim() !== ""){
          if(!confirm("¬øReemplazar el contenido actual con la plantilla?")) return;
        }
        htmlArea.value = TEMPLATES[key].trim();
      });
    }

</script>
</body>
</html>
