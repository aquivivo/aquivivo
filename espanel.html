<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel del estudiante | AquiVivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
  <!-- ‚úÖ consistente con login/admin -->
  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    .panel-grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap: 16px; margin-bottom: 16px; }
    @media (max-width: 860px){ .panel-grid{ grid-template-columns: 1fr; } }

    .courses-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 12px; }
    @media (max-width: 860px){ .courses-grid{ grid-template-columns: 1fr; } }

    .course-card{ display:flex; flex-direction:column; gap: 10px; min-height: 140px; }
    .course-actions{ margin-top:auto; display:flex; gap:10px; flex-wrap:wrap; }

    .pill{ display:inline-flex; align-items:center; gap: 8px; padding: 8px 12px; border-radius: 999px; font-weight: 900; font-size: 12px; letter-spacing: .2px; }
    .pill-ok{ background: rgba(252, 209, 22, .22); border: 1px solid rgba(252, 209, 22, .45); color: #111827; }
    
    .pill-warn{ background: rgba(206, 17, 38, .18); border: 1px solid rgba(206, 17, 38, .35); color: #fff; }
    .pill-neutral{ background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.18); color: #fff; }

    .pill-lock{ background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.18); color: white; backdrop-filter: blur(10px); }

    .small-muted{ margin: 0; font-size: 13px; color: #6b7280; line-height:1.35; }

    .glass-card{ background: rgba(255,255,255,.10); color:white; border: 1px solid rgba(255,255,255,.18); backdrop-filter: blur(12px); }

    .adminLinkWrap{ margin-top: 10px; display:none; }
    .adminLinkWrap.show{ display:block; }
  </style>
</head>

<body>

  <header class="nav-glass">
    <div class="container nav-inner">
      <div class="brand">
        <div class="logo-flag" aria-hidden="true"></div>
        <div class="name">Aqui vivo</div>
      </div>

      <div class="nav-actions">
        <a class="btn-white-outline" href="index.html">Inicio</a>
        <button class="btn-white-outline" type="button" onclick="goBack()">Atr√°s</button>
        <button class="btn-red" onclick="logout()">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="container">

      <section class="panel-grid">
        <div class="hero-card">
          <h1 class="hero-title glow-text">Panel del estudiante üéì</h1>
          <p class="hero-subtitle">Mis cursos</p>

          <div style="margin-top:12px; display:inline-flex; gap:10px; align-items:center; padding:10px 14px; border-radius:16px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.18); backdrop-filter: blur(10px);">
            <div style="font-weight:900;">üë§</div>
            <div style="font-weight:800;">Iniciada sesi√≥n como: <span id="userEmail" style="font-weight:700; opacity:.95;">...</span></div>
          </div>

          <div id="adminLinkWrap" class="adminLinkWrap">
            <div style="margin-top:12px;">
              <a class="btn-white-outline" href="esadmin.html">‚öôÔ∏è Admin</a>
            </div>
            <p class="small-muted" style="margin-top:8px; color: rgba(255,255,255,.8);">Solo visible para administradores.</p>
          </div>
        </div>

        <div class="stats">
          <div class="stat"><div class="big">üìò</div><div class="label">Cursos</div></div>
          <div class="stat"><div class="big">‚è≥</div><div class="label">Acceso</div></div>
          <div class="stat"><div class="big">üéì</div><div class="label">Aprendizaje</div></div>
        </div>
      </section>

      <div class="sectionTitle">üìò Mis cursos</div>
      <div id="coursesCards" class="courses-grid"></div>

    </div>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs }
  from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM",
  authDomain: "aquivivo-platform.firebaseapp.com",
  projectId: "aquivivo-platform",
  storageBucket: "aquivivo-platform.firebasestorage.app",
  messagingSenderId: "116115622011",
  appId: "1:116115622011:web:33a4a583eba4368071bade"
};

const ADMIN_EMAILS = ["aquivivo.pl@gmail.com", "DODAJ_DRUGI_EMAIL_TUTAJ@example.com"]; // <- wpisz tu drugi email (ucze≈Ñ-test)

function isAdminEmail(email){
  const e = (email || "").toLowerCase();
  return ADMIN_EMAILS.some(a => (a||"").toLowerCase() === e);
}


const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userEmailEl = document.getElementById("userEmail");
const coursesCardsEl = document.getElementById("coursesCards");
const adminLinkWrap = document.getElementById("adminLinkWrap");

function parseIso(s){
  if(!s) return null;
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}


function daysLeft(accessObj, level){
  if (!accessObj || !accessObj[level] || !accessObj[level].freeUntil) return null;
  const exp = parseIso(accessObj[level].freeUntil);
  if(!exp) return null;
  const ms = exp.getTime() - Date.now();
  return Math.ceil(ms / (1000*60*60*24));
}

function formatLeft(accessObj, level){
  const d = daysLeft(accessObj, level);
  if(d === null) return "‚Äî";
  if(d <= 0) return "expirado";
  if(d === 1) return "1 d√≠a";
  return `${d} d√≠as`;
}

function hasAccess(accessObj, level){
  if (!accessObj || !accessObj[level] || !accessObj[level].freeUntil) return false;
  const exp = parseIso(accessObj[level].freeUntil);
  if(!exp) return false;
  return exp > new Date();
}

function renderCourseCards(accessObj, metaData){
  coursesCardsEl.innerHTML = "";
  const levels = ["A1","A2","B1","B2"];

  function activeCard(lvl){
    const meta = metaData[lvl] || {};
    const title = meta.title || `Polaco ${lvl}`;
    const subtitle = meta.subtitle || "Haz clic para acceder al curso.";
    
    // Mapear nivel a archivo de curso
    const courseFile = `course.html?level=${encodeURIComponent(lvl)}`;
    
    return `
      <div class="card course-card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div class="pill pill-ok">‚úÖ acceso activo</div>
          <div class="pill pill-neutral">‚è≥ <span id="exp_${lvl}">‚Äî</span></div>
          <div style="font-weight:900; opacity:.9;">PL ${lvl}</div>
        </div>

        <div style="font-size:20px; font-weight:900; margin-top:4px;">${title}</div>
        <p class="small-muted">${subtitle}</p>

        <div class="course-actions">
          <a class="btn-yellow" href="${courseFile}">Acceder ‚Üí</a>
        </div>
      </div>
    `;
  }

  function lockedCard(lvl){
    const meta = metaData[lvl] || {};
    const title = meta.title || `Polaco ${lvl}`;
    
    return `
      <div class="card course-card glass-card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div class="pill pill-lock">üîí bloqueado</div>
          <div style="font-weight:900; opacity:.9;">PL ${lvl}</div>
        </div>

        <div style="font-size:20px; font-weight:900; margin-top:4px;">${title}</div>
        <p style="margin:0; font-size:13px; opacity:.9;">Bloqueado. Puedes activar una prueba de 7 d√≠as (una vez por nivel).</p>

        <div class="course-actions">
          <button class="btn-yellow" type="button" onclick="activateTrial('${lvl}')">Activar 7 d√≠as</button>
          <a class="btn-white-outline" href="Contacto.html">Comprar acceso</a>
        </div>
      </div>
    `;
  }

  levels.forEach(lvl => {
    const active = hasAccess(accessObj, lvl);
    coursesCardsEl.innerHTML += active ? activeCard(lvl) : lockedCard(lvl);
  });

  // Rellenar expiraci√≥n en tarjetas activas
  levels.forEach(lvl => {
    const el = document.getElementById(`exp_${lvl}`);
    if(!el) return;
    const left = daysLeft(accessObj, lvl);
    el.textContent = formatLeft(accessObj, lvl);
    const pill = el.parentElement;
    if(left !== null && left <= 2){
      pill.classList.add('pill-warn');
      pill.classList.remove('pill-neutral');
    }
  });
}


let CURRENT_UID = null;

function activateTrial(level){
  if(!CURRENT_UID) return;
  const ref = doc(db, "users", CURRENT_UID);
  const snap = getDoc(ref);
  const data = snap.data() || {};

  const trialUsed = data.trialUsed || {};
  if(trialUsed[level]){
    alert("La prueba ya fue usada para este nivel.");
    return;
  }

  const now = new Date();
  const trialEnd = new Date(now.getTime() + 7*24*60*60*1000);

  const newAccess = { ...(data.access || {}) };
  newAccess[level] = { freeUntil: trialEnd.toISOString() };

  setDoc(ref, {
    access: newAccess,
    trialUsed: { ...trialUsed, [level]: true },
    updatedAt: serverTimestamp()
  }, { merge: true });

  const refreshed = getDoc(ref);

  // Cargar metadata otra vez
  const metaData = {};
  const levels = ["A1","A2","B1","B2"];
  for (const lvl of levels) {
    try {
      const metaRef = doc(db, "course_meta", lvl);
      const metaSnap = getDoc(metaRef);
      if (metaSnap.exists()) metaData[lvl] = metaSnap.data();
    } catch {}
  }

  renderCourseCards(refreshed.data()?.access || {}, metaData);
  alert(`‚úÖ Activado: ${level} por 7 d√≠as`);
}



onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "eslogin.html";
    return;
  }

  userEmailEl.textContent = user.email || "(sin correo)";
  CURRENT_UID = user.uid;

  // mostrar enlace al administrador (si es email de admin)
  if (isAdminEmail(user.email)){
    adminLinkWrap.classList.add("show");
  }

  const ref = doc(db, "users", user.uid);
  let snap = getDoc(ref);

  // si el usuario no existe en la colecci√≥n users -> establecer A1 prueba = 7 d√≠as
  if (!snap.exists()) {
    const isAdmin = isAdminEmail(user.email);
    const now = new Date();
    const trialEnd = new Date();
    
    if (isAdmin) {
      // Admin: acceso ilimitado a todos los cursos (hasta a√±o 2099)
      trialEnd.setFullYear(2099);
    } else {
      // Usuario regular: A1 por 7 d√≠as
      trialEnd.setDate(now.getDate() + 7);
    }

    setDoc(ref, {
      email: user.email || null,
      createdAt: serverTimestamp(),
      access: isAdmin ? {
        A1: { freeUntil: trialEnd.toISOString() },
        A2: { freeUntil: trialEnd.toISOString() },
        B1: { freeUntil: trialEnd.toISOString() },
        B2: { freeUntil: trialEnd.toISOString() }
      } : {
        A1: { freeUntil: trialEnd.toISOString() },
        A2: null,
        B1: null,
        B2: null
      }
    });

    snap = getDoc(ref);
  }

  // Si es admin, asegurarse de que tiene acceso a todos los cursos
  if (isAdminEmail(user.email)) {
    const trialEnd = new Date();
    trialEnd.setFullYear(2099);
    
    setDoc(ref, {
      ...snap.data(),
      access: {
        A1: { freeUntil: trialEnd.toISOString() },
        A2: { freeUntil: trialEnd.toISOString() },
        B1: { freeUntil: trialEnd.toISOString() },
        B2: { freeUntil: trialEnd.toISOString() }
      }
    }, { merge: true });

    snap = getDoc(ref);
  }
  const metaData = {};
  const levels = ["A1", "A2", "B1", "B2"];
  for (const level of levels) {
    try {
      const metaRef = doc(db, "course_meta", level);
      const metaSnap = getDoc(metaRef);
      if (metaSnap.exists()) {
        metaData[level] = metaSnap.data();
      }
    } catch (e) {
      console.log(`No metadata for ${level}`);
    }
  }

  const data = snap.data();
  renderCourseCards(data?.access || {}, metaData);
});

window.logout = function() {
  signOut(auth).then(() => window.location.href = "eslogin.html");
};
</script>


<script>
  // Enlazar el banner amarillo a course.html
  const banner = document.querySelector('.yellow-banner');
  if (banner) {
    banner.style.cursor = 'pointer';
    banner.addEventListener('click', () => {
      window.location.href = 'course.html';
    });
  }
</script>


<script>
function goBack(){
  if (window.history.length > 1) window.history.back();
  else window.location.href = 'index.html';
}

// ‚úÖ HOTFIX: renderAccess (prevents ReferenceError if original function is missing)
function renderAccess(access) {
  const el =
    document.getElementById('accessInfo') ||
    document.getElementById('accessStatus') ||
    document.querySelector('[data-access]') ||
    document.querySelector('#accesoBox .content') ||
    null;

  if (!el) return;

  const a = (access && access.access) ? access.access : (access || {});
  const trialUntil = a.trialUntil || a.trialEnd || a.expiresAt || a.validUntil;

  el.innerHTML = trialUntil
    ? `‚úÖ Acceso activo hasta: <b>${String(trialUntil).slice(0, 10)}</b>`
    : `‚ö†Ô∏è Sin acceso activo.`;
}

</script>
</body>
</html>
