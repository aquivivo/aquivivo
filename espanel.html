<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Panel del estudiante | AquiVivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
  <!-- ‚úÖ consistente con login/admin -->
  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    .panel-grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap: 16px; margin-bottom: 16px; }
    @media (max-width: 860px){ .panel-grid{ grid-template-columns: 1fr; } }

    .courses-grid{ display:grid; grid-template-columns: repeat(2, 1fr); gap: 14px; margin-top: 12px; }
    @media (max-width: 860px){ .courses-grid{ grid-template-columns: 1fr; } }

    .course-card{ display:flex; flex-direction:column; gap: 10px; min-height: 140px; }
    .course-actions{ margin-top:auto; display:flex; gap:10px; flex-wrap:wrap; }

    .pill{ display:inline-flex; align-items:center; gap: 8px; padding: 8px 12px; border-radius: 999px; font-weight: 900; font-size: 12px; letter-spacing: .2px; }
    .pill-ok{ background: rgba(252, 209, 22, .22); border: 1px solid rgba(252, 209, 22, .45); color: #111827; }
    .pill-lock{ background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.18); color: white; backdrop-filter: blur(10px); }

    .small-muted{ margin: 0; font-size: 13px; color: #6b7280; line-height:1.35; }

    .glass-card{ background: rgba(255,255,255,.10); color:white; border: 1px solid rgba(255,255,255,.18); backdrop-filter: blur(12px); }

    .adminLinkWrap{ margin-top: 10px; display:none; }
    .adminLinkWrap.show{ display:block; }
  </style>
</head>

<body>

  <header class="nav-glass">
    <div class="container nav-inner">
      <div class="brand">
        <div class="logo-flag" aria-hidden="true"></div>
        <div class="name">Aqui vivo</div>
      </div>

      <div class="nav-actions">
        <a class="btn-white-outline" href="index.html">Inicio</a>
        <button class="btn-red" onclick="logout()">Cerrar sesi√≥n</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="container">

      <section class="panel-grid">
        <div class="hero-card">
          <h1 class="hero-title glow-text">Panel del estudiante üéì</h1>
          <p class="hero-subtitle">Mis cursos</p>

          <div style="margin-top:12px; display:inline-flex; gap:10px; align-items:center; padding:10px 14px; border-radius:16px; background: rgba(255,255,255,.10); border: 1px solid rgba(255,255,255,.18); backdrop-filter: blur(10px);">
            <div style="font-weight:900;">üë§</div>
            <div style="font-weight:800;">Iniciada sesi√≥n como: <span id="userEmail" style="font-weight:700; opacity:.95;">...</span></div>
          </div>

          <div id="adminLinkWrap" class="adminLinkWrap">
            <div style="margin-top:12px;">
              <a class="btn-white-outline" href="esadmin.html">‚öôÔ∏è Admin</a>
            </div>
            <p class="small-muted" style="margin-top:8px; color: rgba(255,255,255,.8);">Solo visible para administradores.</p>
          </div>
        </div>

        <div class="stats">
          <div class="stat"><div class="big">üìò</div><div class="label">Cursos</div></div>
          <div class="stat"><div class="big">‚è≥</div><div class="label">Acceso</div></div>
          <div class="stat"><div class="big">üéì</div><div class="label">Aprendizaje</div></div>
        </div>
      </section>

      <div class="sectionTitle">üìò Mis cursos</div>
      <div id="coursesCards" class="courses-grid"></div>

    </div>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc, serverTimestamp, collection, getDocs }
  from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM",
  authDomain: "aquivivo-platform.firebaseapp.com",
  projectId: "aquivivo-platform",
  storageBucket: "aquivivo-platform.firebasestorage.app",
  messagingSenderId: "116115622011",
  appId: "1:116115622011:web:33a4a583eba4368071bade"
};

const ADMIN_EMAIL = "aquivivo.pl@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const userEmailEl = document.getElementById("userEmail");
const coursesCardsEl = document.getElementById("coursesCards");
const adminLinkWrap = document.getElementById("adminLinkWrap");

function parseIso(s){
  if(!s) return null;
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}

function hasAccess(accessObj, level){
  if (!accessObj || !accessObj[level] || !accessObj[level].freeUntil) return false;
  const exp = parseIso(accessObj[level].freeUntil);
  if(!exp) return false;
  return exp > new Date();
}

function renderCourseCards(accessObj, metaData){
  coursesCardsEl.innerHTML = "";
  const levels = ["A1","A2","B1","B2"];

  function activeCard(lvl){
    const meta = metaData[lvl] || {};
    const title = meta.title || `Polaco ${lvl}`;
    const subtitle = meta.subtitle || "Haz clic para acceder al curso.";
    
    // Mapear nivel a archivo de curso
    const courseFile = {
      "A1": "courseA2.html",
      "A2": "courseA2.html",
      "B1": "courseB1.html",
      "B2": "courseB2.html"
    }[lvl];
    
    return `
      <div class="card course-card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div class="pill pill-ok">‚úÖ acceso activo</div>
          <div style="font-weight:900; opacity:.9;">PL ${lvl}</div>
        </div>

        <div style="font-size:20px; font-weight:900; margin-top:4px;">${title}</div>
        <p class="small-muted">${subtitle}</p>

        <div class="course-actions">
          <a class="btn-yellow" href="${courseFile}">Acceder ‚Üí</a>
        </div>
      </div>
    `;
  }

  function lockedCard(lvl){
    const meta = metaData[lvl] || {};
    const title = meta.title || `Polaco ${lvl}`;
    
    return `
      <div class="card course-card glass-card">
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
          <div class="pill pill-lock">üîí bloqueado</div>
          <div style="font-weight:900; opacity:.9;">PL ${lvl}</div>
        </div>

        <div style="font-size:20px; font-weight:900; margin-top:4px;">${title}</div>
        <p style="margin:0; font-size:13px; opacity:.9;">Pr√≥ximamente / a activar.</p>

        <div class="course-actions">
          <a class="btn-white-outline" href="Contacto.html">Activar</a>
        </div>
      </div>
    `;
  }

  levels.forEach(lvl => {
    const active = hasAccess(accessObj, lvl);
    coursesCardsEl.innerHTML += active ? activeCard(lvl) : lockedCard(lvl);
  });
}

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "eslogin.html";
    return;
  }

  userEmailEl.textContent = user.email || "(sin correo)";

  // mostrar enlace al administrador (si es email de admin)
  if ((user.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase()){
    adminLinkWrap.classList.add("show");
  }

  const ref = doc(db, "users", user.uid);
  let snap = await getDoc(ref);

  // si el usuario no existe en la colecci√≥n users -> establecer A1 prueba = 7 d√≠as
  if (!snap.exists()) {
    const isAdmin = (user.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase();
    const now = new Date();
    const trialEnd = new Date();
    
    if (isAdmin) {
      // Admin: acceso ilimitado a todos los cursos (hasta a√±o 2099)
      trialEnd.setFullYear(2099);
    } else {
      // Usuario regular: A1 por 7 d√≠as
      trialEnd.setDate(now.getDate() + 7);
    }

    await setDoc(ref, {
      email: user.email || null,
      createdAt: serverTimestamp(),
      access: isAdmin ? {
        A1: { freeUntil: trialEnd.toISOString() },
        A2: { freeUntil: trialEnd.toISOString() },
        B1: { freeUntil: trialEnd.toISOString() },
        B2: { freeUntil: trialEnd.toISOString() }
      } : {
        A1: { freeUntil: trialEnd.toISOString() },
        A2: null,
        B1: null,
        B2: null
      }
    });

    snap = await getDoc(ref);
  }

  // Si es admin, asegurarse de que tiene acceso a todos los cursos
  if ((user.email || "").toLowerCase() === ADMIN_EMAIL.toLowerCase()) {
    const trialEnd = new Date();
    trialEnd.setFullYear(2099);
    
    await setDoc(ref, {
      ...snap.data(),
      access: {
        A1: { freeUntil: trialEnd.toISOString() },
        A2: { freeUntil: trialEnd.toISOString() },
        B1: { freeUntil: trialEnd.toISOString() },
        B2: { freeUntil: trialEnd.toISOString() }
      }
    }, { merge: true });

    snap = await getDoc(ref);
  }
  const metaData = {};
  const levels = ["A1", "A2", "B1", "B2"];
  for (const level of levels) {
    try {
      const metaRef = doc(db, "course_meta", level);
      const metaSnap = await getDoc(metaRef);
      if (metaSnap.exists()) {
        metaData[level] = metaSnap.data();
      }
    } catch (e) {
      console.log(`No metadata for ${level}`);
    }
  }

  const data = snap.data();
  renderCourseCards(data?.access || {}, metaData);
});

window.logout = function() {
  signOut(auth).then(() => window.location.href = "eslogin.html");
};
</script>


<script>
  // Enlazar el banner amarillo a course.html
  const banner = document.querySelector('.yellow-banner');
  if (banner) {
    banner.style.cursor = 'pointer';
    banner.addEventListener('click', () => {
      window.location.href = 'course.html';
    });
  }
</script>

</body>
</html>
