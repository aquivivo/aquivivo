<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Admin | AquiVivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/css/styles.css" />
  <script src="assets/js/layout.js" type="module"></script>
</head>
<body data-page="esadmin">
  <div id="appHeader"></div>

  <main class="page">
    <div class="container">

      <section class="heroBanner">
        <div class="heroTitleRow">
          <div class="heroIcon">ğŸ›¡ï¸</div>
          <div>
            <h1 class="sectionTitle">Admin</h1>
            <p class="subtitle">Usuarios, accesos y ajustes de la plataforma.</p>
          </div>
        </div>
      </section>

      <!-- âœ… Quick actions (always visible) -->
      <section class="card" id="quickActions">
        <h2 class="sectionTitle">âš¡ Acciones rÃ¡pidas</h2>
        <p class="subtitle">Lo esencial, sin buscar en el dashboard.</p>

        <div class="metaRow" style="flex-wrap:wrap; gap:10px;">
          <a href="admin-select.html?type=lesson" class="btn-yellow">âœï¸ Admin lecciones</a>
          <a href="admin-select.html?type=exercise" class="btn-white-outline">ğŸ§ª Admin ejercicios</a>
          <a href="#accUsers" class="btn-white-outline">ğŸ‘¤ Usuarios</a>
          <a href="#accPromo" class="btn-white-outline">ğŸ·ï¸ CÃ³digos promo</a>
          <a href="#accSegments" class="btn-white-outline">ğŸ¯ SegmentaciÃ³n</a>
        </div>

        <div class="hr"></div>

        <div class="hintSmall">
          Tip: el dashboard es para ver datos; las acciones rÃ¡pidas son para trabajar.
        </div>
      </section>

      <!-- âœ… Dashboard (accordion â€“ open by default) -->
      <details class="card" id="accDashboard" open>
        <summary class="sectionTitle" style="cursor:pointer; list-style:none;">
          ğŸ“Š Dashboard <span class="hintSmall" style="font-weight:600; margin-left:8px;">(clic para abrir/cerrar)</span>
        </summary>
        <div style="margin-top:10px;">
          <p class="subtitle">Resumen rÃ¡pido (conteos en Firestore). Haz clic en una tarjeta para ver detalles.</p>

          <div class="metaRow" style="flex-wrap:wrap; gap:10px;">
            <button id="btnRefreshStats" class="btn-white-outline" type="button">ğŸ”„ Actualizar</button>
            <span id="statsStatus" class="hintSmall"></span>
          </div>

          <div class="panelGrid" style="margin-top:12px;">
            <div class="card statCard" data-expand="users" data-details="statUsersDetails">
              <div class="muted" style="font-weight:900;">ğŸ‘¤ Usuarios</div>
              <div id="statUsers" style="font-size:34px; font-weight:900; margin-top:6px;">â€”</div>
              <div class="hintSmall">Total en users</div>
              <div id="statUsersDetails" class="statDetails" style="display:none; margin-top:12px;"></div>
            </div>

            <div class="card statCard" data-expand="premium" data-details="statPremiumPlanDetails">
              <div class="muted" style="font-weight:900;">ğŸ’ Plan premium</div>
              <div id="statPremiumPlan" style="font-size:34px; font-weight:900; margin-top:6px;">â€”</div>
              <div class="hintSmall">users donde plan == "premium"</div>
              <div id="statPremiumPlanDetails" class="statDetails" style="display:none; margin-top:12px;"></div>
            </div>

            <div class="card statCard" data-expand="access" data-details="statAccessTrueDetails">
              <div class="muted" style="font-weight:900;">ğŸ”“ access=true</div>
              <div id="statAccessTrue" style="font-size:34px; font-weight:900; margin-top:6px;">â€”</div>
              <div class="hintSmall">users donde access == true</div>
              <div id="statAccessTrueDetails" class="statDetails" style="display:none; margin-top:12px;"></div>
            </div>

            <div class="card statCard" data-expand="blocked" data-details="statBlockedDetails">
              <div class="muted" style="font-weight:900;">â›” Bloqueados</div>
              <div id="statBlocked" style="font-size:34px; font-weight:900; margin-top:6px;">â€”</div>
              <div class="hintSmall">users donde blocked == true</div>
              <div id="statBlockedDetails" class="statDetails" style="display:none; margin-top:12px;"></div>
            </div>

            <div class="card statCard" data-expand="oneTopic" data-details="statOneTopicDetails">
              <div class="muted" style="font-weight:900;">ğŸ¯ 1 tema abierto</div>
              <div id="statOneTopic" style="font-size:34px; font-weight:900; margin-top:6px;">â€”</div>
              <div class="hintSmall">users donde openedTopicsCount == 1</div>
              <div id="statOneTopicDetails" class="statDetails" style="display:none; margin-top:12px;"></div>
            </div>

            <div class="card statCard" data-expand="courses" data-details="statCoursesDetails">
              <div class="muted" style="font-weight:900;">ğŸ“š Temas</div>
              <div id="statCourses" style="font-size:34px; font-weight:900; margin-top:6px;">â€”</div>
              <div class="hintSmall">docs en courses</div>
              <div id="statCoursesDetails" class="statDetails" style="display:none; margin-top:12px;"></div>
            </div>

            <div class="card statCard" data-expand="exercises" data-details="statExercisesDetails">
              <div class="muted" style="font-weight:900;">ğŸ§© Ejercicios</div>
              <div id="statExercises" style="font-size:34px; font-weight:900; margin-top:6px;">â€”</div>
              <div class="hintSmall">docs en exercises</div>
              <div id="statExercisesDetails" class="statDetails" style="display:none; margin-top:12px;"></div>
            </div>
          </div>
        </div>
      </details>

      <!-- âœ… SegmentaciÃ³n (accordion â€“ closed by default) -->
      <details class="card" id="accSegments">
        <summary class="sectionTitle" style="cursor:pointer; list-style:none;">
          ğŸ¯ SegmentaciÃ³n (marketing) <span class="hintSmall" style="font-weight:600; margin-left:8px;">(clic para abrir/cerrar)</span>
        </summary>
        <div style="margin-top:10px;">
          <p class="subtitle">Listas rÃ¡pidas: expirando pronto, premium activo, sin acceso (aprox.). Puedes exportar CSV.</p>

          <div class="metaRow" style="flex-wrap:wrap; gap:10px;">
            <button id="btnLoadExp0" class="btn-white-outline" type="button">â³ Expira hoy</button>
            <button id="btnLoadExp3" class="btn-white-outline" type="button">â³ Expira en 3 dÃ­as</button>
            <button id="btnLoadExp7" class="btn-white-outline" type="button">â³ Expiran en 7 dÃ­as</button>
            <button id="btnLoadExp14" class="btn-white-outline" type="button">â³ Expiran en 14 dÃ­as</button>
            <button id="btnLoadPremiumActive" class="btn-white-outline" type="button">ğŸ’ Premium activo (accessUntil)</button>
            <button id="btnLoadFreeUsers" class="btn-white-outline" type="button">ğŸ”’ Sin acceso (aprox.)</button>
            <button id="btnLoadOneTopic" class="btn-white-outline" type="button">ğŸ¯ Solo 1 tema</button>
            <button id="btnLoadOneTopicInactive" class="btn-white-outline" type="button">ğŸš¶ 1 tema Â· inactivo 7 dÃ­as</button>
            <button id="btnExportSegment" class="btn-yellow" type="button">â¬‡ï¸ Exportar CSV</button>

            <span id="segmentStatus" class="hintSmall" style="margin-left:auto;"></span>
          </div>

          <div class="hr"></div>

          <div class="sectionTitle" style="margin-top:0;">Resultados</div>
          <div id="segmentList" class="list"></div>
        </div>
      </details>

      <!-- âœ… Promo codes (accordion â€“ closed by default) -->
      <details class="card" id="accPromo">
        <summary class="sectionTitle" style="cursor:pointer; list-style:none;">
          ğŸ·ï¸ CÃ³digos promo <span class="hintSmall" style="font-weight:600; margin-left:8px;">(clic para abrir/cerrar)</span>
        </summary>
        <div style="margin-top:10px;">
          <p class="subtitle">Crea, activa y desactiva cÃ³digos. Los usuarios los aplican en el panel.</p>

          <div class="metaRow" style="flex-wrap:wrap; gap:10px; align-items:flex-end;">
            <div style="min-width:220px;">
              <label class="muted" style="font-weight:900;">CÃ³digo (ID)</label>
              <input id="promoCode" class="input" placeholder="Ej. START2026" />
            </div>

            <div style="min-width:160px;">
              <label class="muted" style="font-weight:900;">DÃ­as</label>
              <input id="promoDays" class="input" type="number" min="0" step="1" placeholder="Ej. 30" />
            </div>

            <div style="min-width:180px;">
              <label class="muted" style="font-weight:900;">Plan</label>
              <select id="promoPlan" class="select">
                <option value="premium" selected>premium</option>
                <option value="free">free</option>
              </select>
            </div>

            <label class="pill" style="gap:10px; align-items:center;">
              <input id="promoActive" type="checkbox" style="width:18px; height:18px; margin:0;" checked />
              Activo
            </label>

            <button id="btnSavePromoCode" class="btn-yellow" type="button">ğŸ’¾ Guardar</button>
            <button id="btnClearPromoForm" class="btn-white-outline" type="button">ğŸ§¹ Limpiar</button>

            <span id="promoStatus" class="hintSmall" style="margin-left:auto;"></span>
          </div>

          <div class="hr"></div>

          <div class="sectionTitle" style="margin-top:0;">Lista de cÃ³digos</div>
          <div id="promoListAdmin" class="list"></div>
        </div>
      </details>

      <!-- âœ… Users (accordion â€“ closed by default) -->
      <details class="card" id="accUsers">
        <summary class="sectionTitle" style="cursor:pointer; list-style:none;">
          ğŸ‘¤ Usuarios <span class="hintSmall" style="font-weight:600; margin-left:8px;">(clic para abrir/cerrar)</span>
        </summary>
        <div style="margin-top:10px;">
          <p class="subtitle">Busca por email, abre el editor y gestiona acceso/plan/fechas.</p>

          <div class="metaRow" style="flex-wrap:wrap; gap:10px;">
            <button id="btnLoadUsers" class="btn-white-outline" type="button">Cargar usuarios</button>

            <select id="roleFilter" class="select" style="min-width:200px;">
              <option value="all">Todos</option>
              <option value="admins">Solo admin</option>
              <option value="premium">Con acceso</option>
              <option value="free">Sin acceso</option>
            </select>

            <input id="userSearch" class="input" placeholder="Buscar por email..." style="min-width:260px;" />
            <button id="btnSearch" class="btn-white-outline" type="button">Buscar</button>
            <button id="btnClear" class="btn-white-outline" type="button">Limpiar</button>

            <span class="hintSmall" style="margin-left:auto;">Tip: click en usuario â†’ editar acceso</span>
          </div>

          <div id="usersSection" style="display:none; margin-top:16px;">
            <div id="usersList" class="list"></div>
            <button id="btnLoadMore" class="btn-white-outline" style="margin-top:12px;">Cargar mÃ¡s</button>
          </div>
        </div>
      </details>

    </div>
  </main>

  <!-- Modal: Edit user access -->
  <div id="userModal" class="modalOverlay" aria-hidden="true" style="display:none;">
    <div class="modalCard">
      <div class="modalHead">
        <div class="modalTitle">Editar usuario</div>
        <button id="userModalClose" class="btn-white-outline" type="button">âœ–</button>
      </div>
      <div class="hr"></div>

      <div class="panelGrid">
        <div class="card">
          <div class="sectionTitle" style="margin-top:0;">Datos</div>
          <div class="muted" style="font-weight:900; margin-top:8px;">Email</div>
          <div id="um_email" class="pill" style="width:fit-content;">â€”</div>

          <div class="muted" style="font-weight:900; margin-top:12px;">UID</div>
          <div id="um_uid" class="hintSmall">â€”</div>

          <div class="metaRow" style="margin-top:14px; flex-wrap:wrap; gap:10px;">
            <label class="pill" style="gap:10px;">
              <input id="um_admin" type="checkbox" style="width:18px; height:18px; margin:0;" />
              Admin
            </label>
            <label class="pill" style="gap:10px;">
              <input id="um_access" type="checkbox" style="width:18px; height:18px; margin:0;" />
              Acceso
            </label>
            <label class="pill" style="gap:10px;">
              <input id="um_blocked" type="checkbox" style="width:18px; height:18px; margin:0;" />
              Bloqueado
            </label>
          </div>

          <div class="metaRow" style="margin-top:12px; flex-wrap:wrap; gap:10px;">
            <button id="um_openPanelAs" class="btn-white-outline" type="button">ğŸ‘€ Ver panel como usuario</button>
            <span class="hintSmall">Solo vista (no cambia tu login).</span>
          </div>
        </div>

        <div class="card">
          <div class="sectionTitle" style="margin-top:0;">Plan y fecha</div>

          <div class="muted" style="font-weight:900; margin-top:8px;">Plan</div>
          <select id="um_plan" class="select">
            <option value="free">free</option>
            <option value="premium">premium</option>
          </select>

          <div class="muted" style="font-weight:900; margin-top:12px;">Acceso hasta</div>
          <input id="um_until" class="input" type="datetime-local" />

          <div class="hintSmall" style="margin-top:10px;">
            Reglas: acceso = admin OR access=true OR plan=premium OR accessUntil en el futuro.
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="metaRow" style="flex-wrap:wrap; gap:10px;">
        <button id="um_grant30" class="btn-yellow" type="button">â• Premium +30 dÃ­as</button>
        <button id="um_extend30" class="btn-white-outline" type="button">â³ Extender +30 dÃ­as</button>
        <button id="um_revoke" class="btn-red" type="button">ğŸ”’ Quitar acceso</button>

        <span id="um_status" class="hintSmall" style="margin-left:auto;"></span>
      </div>

      <div class="metaRow" style="margin-top:12px; justify-content:flex-end; gap:10px;">
        <button id="um_save" class="btn-yellow" type="button">ğŸ’¾ Guardar cambios</button>
        <button id="um_cancel" class="btn-white-outline" type="button">Cancelar</button>
      </div>

      <div class="hr"></div>
      <div class="sectionTitle" style="margin-top:0;">ğŸ“ Nota del admin</div>
      <textarea id="um_note" class="input" rows="3" placeholder="Nota interna (solo admin)â€¦"></textarea>

      <div class="hr"></div>
      <div class="sectionTitle" style="margin-top:0;">ğŸ“œ Historial de acceso</div>
      <div id="um_logs" class="list"></div>
      <div class="hintSmall" style="margin-top:10px;">
        Se guarda automÃ¡ticamente cuando cambias acceso/plan/fechas o usas botones rÃ¡pidos.
      </div>
    </div>
  </div>

  <script type="module" src="assets/js/pages/esadmin-page.js"></script>
</body>
</html>
