<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Admin | AquiVivo</title>
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link href="assets/css/styles.css" rel="stylesheet" />
    <script src="assets/js/layout.js" type="module"></script>
  </head>
  <body data-page="esadmin">
    <div id="appHeader"></div>
    <main class="page">
      <div class="container">
        <section class="heroBanner">
          <div class="heroTitleRow">
            <div class="heroIcon">ğŸ›¡ï¸</div>
            <div>
              <h1 class="sectionTitle">Admin</h1>
              <p class="subtitle">
                Usuarios, accesos y ajustes de la plataforma.
              </p>
            </div>
          </div>
        </section>
        <!-- âœ… Quick actions (always visible) -->
        <section class="card" id="quickActions">
          <h2 class="sectionTitle">âš¡ Acciones rÃ¡pidas</h2>
          <p class="subtitle">Lo esencial, sin buscar en el dashboard.</p>
          <div class="metaRow" style="flex-wrap: wrap; gap: 10px">
            <a class="btn-yellow" href="admin-select.html?type=lesson"
              >âœï¸ Admin lecciones</a
            >
            <a class="btn-white-outline" href="admin-select.html?type=exercise"
              >ğŸ§ª Admin ejercicios</a
            >
            <a class="btn-white-outline" href="#accUsers">ğŸ‘¤ Usuarios</a>
            <a class="btn-white-outline" href="#accPromo">ğŸ·ï¸ CÃ³digos promo</a>
            <a class="btn-white-outline" href="#accSegments">ğŸ¯ SegmentaciÃ³n</a>
          </div>
          <div class="hr"></div>
          <div class="hintSmall">
            Tip: el dashboard es para ver datos; las acciones rÃ¡pidas son para
            trabajar.
          </div>
        </section>
        <!-- âœ… Dashboard (accordion â€“ open by default) -->
        <details class="card" id="accDashboard">
          <summary
            class="sectionTitle"
            style="cursor: pointer; list-style: none"
          >
            ğŸ“Š Dashboard
            <span class="hintSmall" style="font-weight: 600; margin-left: 8px"
              >(clic para abrir/cerrar)</span
            >
          </summary>
          <div style="margin-top: 10px">
            <p class="subtitle">
              Resumen rÃ¡pido (conteos en Firestore). Haz clic en una tarjeta
              para ver detalles.
            </p>
            <div class="metaRow" style="flex-wrap: wrap; gap: 10px">
              <button
                class="btn-white-outline"
                id="btnRefreshStats"
                type="button"
              >
                ğŸ”„ Actualizar
              </button>
              <span class="hintSmall" id="statsStatus"></span>
            </div>
            <div class="panelGrid" style="margin-top: 12px">
              <div
                class="card statCard"
                data-details="statUsersDetails"
                data-expand="users"
              >
                <div class="muted" style="font-weight: 900">ğŸ‘¤ Usuarios</div>
                <div
                  id="statUsers"
                  style="font-size: 34px; font-weight: 900; margin-top: 6px"
                >
                  â€”
                </div>
                <div class="hintSmall">Total en users</div>
                <div
                  class="statDetails"
                  id="statUsersDetails"
                  style="display: none; margin-top: 12px"
                ></div>
              </div>
              <div
                class="card statCard"
                data-details="statPremiumPlanDetails"
                data-expand="premium"
              >
                <div class="muted" style="font-weight: 900">
                  ğŸ’ Plan premium
                </div>
                <div
                  id="statPremiumPlan"
                  style="font-size: 34px; font-weight: 900; margin-top: 6px"
                >
                  â€”
                </div>
                <div class="hintSmall">users donde plan == "premium"</div>
                <div
                  class="statDetails"
                  id="statPremiumPlanDetails"
                  style="display: none; margin-top: 12px"
                ></div>
              </div>
              <div
                class="card statCard"
                data-details="statAccessTrueDetails"
                data-expand="access"
              >
                <div class="muted" style="font-weight: 900">ğŸ”“ access=true</div>
                <div
                  id="statAccessTrue"
                  style="font-size: 34px; font-weight: 900; margin-top: 6px"
                >
                  â€”
                </div>
                <div class="hintSmall">users donde access == true</div>
                <div
                  class="statDetails"
                  id="statAccessTrueDetails"
                  style="display: none; margin-top: 12px"
                ></div>
              </div>
              <div
                class="card statCard"
                data-details="statBlockedDetails"
                data-expand="blocked"
              >
                <div class="muted" style="font-weight: 900">â›” Bloqueados</div>
                <div
                  id="statBlocked"
                  style="font-size: 34px; font-weight: 900; margin-top: 6px"
                >
                  â€”
                </div>
                <div class="hintSmall">users donde blocked == true</div>
                <div
                  class="statDetails"
                  id="statBlockedDetails"
                  style="display: none; margin-top: 12px"
                ></div>
              </div>
              <div
                class="card statCard"
                data-details="statOneTopicDetails"
                data-expand="oneTopic"
              >
                <div class="muted" style="font-weight: 900">
                  ğŸ¯ 1 tema abierto
                </div>
                <div
                  id="statOneTopic"
                  style="font-size: 34px; font-weight: 900; margin-top: 6px"
                >
                  â€”
                </div>
                <div class="hintSmall">users donde openedTopicsCount == 1</div>
                <div
                  class="statDetails"
                  id="statOneTopicDetails"
                  style="display: none; margin-top: 12px"
                ></div>
              </div>
              <div
                class="card statCard"
                data-details="statCoursesDetails"
                data-expand="courses"
              >
                <div class="muted" style="font-weight: 900">ğŸ“š Temas</div>
                <div
                  id="statCourses"
                  style="font-size: 34px; font-weight: 900; margin-top: 6px"
                >
                  â€”
                </div>
                <div class="hintSmall">docs en courses</div>
                <div
                  class="statDetails"
                  id="statCoursesDetails"
                  style="display: none; margin-top: 12px"
                ></div>
              </div>
              <div
                class="card statCard"
                data-details="statExercisesDetails"
                data-expand="exercises"
              >
                <div class="muted" style="font-weight: 900">ğŸ§© Ejercicios</div>
                <div
                  id="statExercises"
                  style="font-size: 34px; font-weight: 900; margin-top: 6px"
                >
                  â€”
                </div>
                <div class="hintSmall">docs en exercises</div>
                <div
                  class="statDetails"
                  id="statExercisesDetails"
                  style="display: none; margin-top: 12px"
                ></div>
              </div>
            </div>
          </div>
        </details>
        <!-- âœ… SegmentaciÃ³n (accordion â€“ closed by default) -->
        <details class="card" id="accSegments">
          <summary
            class="sectionTitle"
            style="cursor: pointer; list-style: none"
          >
            ğŸ¯ SegmentaciÃ³n (marketing)
            <span class="hintSmall" style="font-weight: 600; margin-left: 8px"
              >(clic para abrir/cerrar)</span
            >
          </summary>
          <div style="margin-top: 10px">
            <p class="subtitle">
              Listas rÃ¡pidas: expirando pronto, premium activo, sin acceso
              (aprox.). Puedes exportar CSV.
            </p>
            <div class="metaRow" style="flex-wrap: wrap; gap: 10px">
              <button class="btn-white-outline" id="btnLoadExp0" type="button">
                â³ Expira hoy
              </button>
              <button class="btn-white-outline" id="btnLoadExp3" type="button">
                â³ Expira en 3 dÃ­as
              </button>
              <button class="btn-white-outline" id="btnLoadExp7" type="button">
                â³ Expiran en 7 dÃ­as
              </button>
              <button class="btn-white-outline" id="btnLoadExp14" type="button">
                â³ Expiran en 14 dÃ­as
              </button>
              <button
                class="btn-white-outline"
                id="btnLoadPremiumActive"
                type="button"
              >
                ğŸ’ Premium activo (accessUntil)
              </button>
              <button
                class="btn-white-outline"
                id="btnLoadFreeUsers"
                type="button"
              >
                ğŸ”’ Sin acceso (aprox.)
              </button>
              <button
                class="btn-white-outline"
                id="btnLoadOneTopic"
                type="button"
              >
                ğŸ¯ Solo 1 tema
              </button>
              <button
                class="btn-white-outline"
                id="btnLoadOneTopicInactive"
                type="button"
              >
                ğŸš¶ 1 tema Â· inactivo 7 dÃ­as
              </button>
              <button class="btn-yellow" id="btnExportSegment" type="button">
                â¬‡ï¸ Exportar CSV
              </button>
              <span
                class="hintSmall"
                id="segmentStatus"
                style="margin-left: auto"
              ></span>
            </div>
            <div class="hr"></div>
            <div class="sectionTitle" style="margin-top: 0">Resultados</div>
            <div class="list" id="segmentList"></div>
          </div>
        </details>
        <!-- âœ… Promo codes (accordion â€“ closed by default) -->
        <details class="card" id="accPromo">
          <summary
            class="sectionTitle"
            style="cursor: pointer; list-style: none"
          >
            ğŸ·ï¸ CÃ³digos promo
            <span class="hintSmall" style="font-weight: 600; margin-left: 8px"
              >(clic para abrir/cerrar)</span
            >
          </summary>
          <div class="hr"></div>
          <div class="sectionTitle" style="margin-top: 0">
            ğŸ Referral settings
          </div>
          <div
            class="metaRow"
            style="flex-wrap: wrap; gap: 10px; align-items: flex-end"
          >
            <div style="min-width: 220px">
              <label class="muted" style="font-weight: 900">% descuento</label>
              <input
                class="input"
                id="refOwnerPercent"
                max="100"
                min="0"
                placeholder="np. 20"
                step="1"
                type="number"
              />
            </div>
            <div style="min-width: 320px; flex: 1">
              <label class="muted" style="font-weight: 900"
                >Opis / zakres</label
              >
              <input
                class="input"
                id="refRewardScope"
                placeholder="np. 20% en otros servicios"
              />
            </div>
            <button
              class="btn-yellow"
              id="btnSaveReferralSettings"
              type="button"
            >
              ğŸ’¾ Guardar
            </button>
            <span
              class="hintSmall"
              id="refSettingsStatus"
              style="margin-left: auto"
            ></span>
          </div>
          <div class="hintSmall" style="margin-top: 10px">
            Guardado en: <b>promo_codes/_REFERRAL_SETTINGS</b>
          </div>

          <div style="margin-top: 10px">
            <p class="subtitle">
              Crea, activa y desactiva cÃ³digos. Los usuarios los aplican en el
              panel.
            </p>
            <div
              class="metaRow"
              style="flex-wrap: wrap; gap: 10px; align-items: flex-end"
            >
              <div style="min-width: 220px">
                <label class="muted" style="font-weight: 900"
                  >CÃ³digo (ID)</label
                >
                <input
                  class="input"
                  id="promoCode"
                  placeholder="Ej. START2026"
                />
              </div>
              <div style="min-width: 160px">
                <label class="muted" style="font-weight: 900">DÃ­as</label>
                <input
                  class="input"
                  id="promoDays"
                  min="0"
                  placeholder="Ej. 30"
                  step="1"
                  type="number"
                />
              </div>
              <div style="min-width: 180px">
                <label class="muted" style="font-weight: 900">Plan</label>
                <select class="select" id="promoPlan">
                  <option selected="" value="premium">premium</option>
                  <option value="free">free</option>
                </select>
              </div>
              <label class="pill" style="gap: 10px; align-items: center">
                <input
                  checked=""
                  id="promoActive"
                  style="width: 18px; height: 18px; margin: 0"
                  type="checkbox"
                />
                Activo
              </label>
              <button class="btn-yellow" id="btnSavePromoCode" type="button">
                ğŸ’¾ Guardar
              </button>
              <button
                class="btn-white-outline"
                id="btnClearPromoForm"
                type="button"
              >
                ğŸ§¹ Limpiar
              </button>
              <span
                class="hintSmall"
                id="promoStatus"
                style="margin-left: auto"
              ></span>
            </div>
            <div class="hr"></div>
            <div class="sectionTitle" style="margin-top: 0">
              Lista de cÃ³digos
            </div>
            <div class="list" id="promoListAdmin"></div>
          </div>
        </details>
        <details class="card" id="accServices">
          <summary class="sectionTitle">
            ğŸ›ï¸ Servicios (oferta)
            <span class="hintSmall" style="font-weight: 600; margin-left: 8px"
              >(CRUD)</span
            >
          </summary>
          <div style="margin-top: 12px">
            <div class="rowBetween" style="gap: 10px; flex-wrap: wrap">
              <div class="subtitle" style="margin: 0">
                Dodaj / edytuj usÅ‚ugi widoczne na <b>services.html</b>.
              </div>
              <button
                class="btn-white-outline"
                id="btnReloadServicesAdmin"
                type="button"
              >
                ğŸ”„ Actualizar
              </button>
            </div>
            <div class="hr"></div>
            <div
              class="metaRow"
              style="flex-wrap: wrap; gap: 10px; align-items: flex-end"
            >
              <div style="min-width: 240px; flex: 1">
                <label class="muted" style="font-weight: 900">SKU (ID)</label>
                <input class="input" id="svcSku" placeholder="np. CONSULT_60" />
              </div>
              <div style="min-width: 220px">
                <label class="muted" style="font-weight: 900">CategorÃ­a</label>
                <select class="select" id="svcCategory">
                  <option value="plans">planes</option>
                  <option value="consultas">consultas</option>
                  <option value="servicios">servicios</option>
                  <option value="extras" selected="">extras</option>
                  <option value="ebooks">ebooks</option>
                </select>
              </div>
              <div style="min-width: 240px; flex: 1">
                <label class="muted" style="font-weight: 900">TÃ­tulo</label>
                <input
                  class="input"
                  id="svcTitle"
                  placeholder="np. Consulta 60 min"
                />
              </div>
              <div style="min-width: 260px; flex: 1">
                <label class="muted" style="font-weight: 900"
                  >DescripciÃ³n</label
                >
                <input class="input" id="svcDesc" placeholder="KrÃ³tki opisâ€¦" />
              </div>
              <div style="min-width: 160px">
                <label class="muted" style="font-weight: 900">Precio</label>
                <input class="input" id="svcPrice" placeholder="np. 49â‚¬" />
              </div>
              <div style="min-width: 160px">
                <label class="muted" style="font-weight: 900">Badge</label>
                <input class="input" id="svcBadge" placeholder="np. Popular" />
              </div>
              <div style="min-width: 120px">
                <label class="muted" style="font-weight: 900">Order</label>
                <input
                  class="input"
                  id="svcOrder"
                  min="0"
                  placeholder="0"
                  step="1"
                  type="number"
                />
              </div>
              <div style="min-width: 160px">
                <label class="muted" style="font-weight: 900">CTA type</label>
                <select class="select" id="svcCtaType">
                  <option selected="" value="info">info</option>
                  <option value="link">link</option>
                  <option value="payhip">payhip</option>
                  <option value="stripe">stripe</option>
                </select>
              </div>
              <div style="min-width: 260px; flex: 1">
                <label class="muted" style="font-weight: 900"
                  >CTA url / Payhip code (stripe: vacÃ­o)</label
                >
                <input
                  class="input"
                  id="svcCtaUrl"
                  placeholder="link/payhip: https://... lub kod Â· stripe: zostaw puste"
                />
              </div>
              <div style="min-width: 180px">
                <label class="muted" style="font-weight: 900">CTA label</label>
                <input
                  class="input"
                  id="svcCtaLabel"
                  placeholder="np. Comprar / Reservar"
                />
              </div>
              <div style="min-width: 140px">
                <label class="muted" style="font-weight: 900">Activo</label>
                <select class="select" id="svcActive">
                  <option selected="" value="true">true</option>
                  <option value="false">false</option>
                </select>
              </div>
              <button class="btn-yellow" id="btnSaveService" type="button">
                ğŸ’¾ Guardar
              </button>
              <button
                class="btn-white-outline"
                id="btnClearService"
                type="button"
              >
                Limpiar
              </button>
              <span
                class="hintSmall"
                id="svcStatus"
                style="margin-left: auto"
              ></span>
            </div>
            <div class="hr"></div>
            <div class="list" id="servicesAdminList"></div>
          </div>
        </details>

        <!-- âœ… Users (accordion â€“ closed by default) -->
        <details class="card" id="accUsers">
          <summary
            class="sectionTitle"
            style="cursor: pointer; list-style: none"
          >
            ğŸ‘¤ Usuarios
            <span class="hintSmall" style="font-weight: 600; margin-left: 8px"
              >(clic para abrir/cerrar)</span
            >
          </summary>
          <div style="margin-top: 10px">
            <p class="subtitle">
              Busca por email, abre el editor y gestiona acceso/plan/fechas.
            </p>
            <div class="metaRow" style="flex-wrap: wrap; gap: 10px">
              <button class="btn-white-outline" id="btnLoadUsers" type="button">
                Cargar usuarios
              </button>
              <select class="select" id="roleFilter" style="min-width: 200px">
                <option value="all">Todos</option>
                <option value="admins">Solo admin</option>
                <option value="premium">Con acceso</option>
                <option value="free">Sin acceso</option>
              </select>
              <input
                class="input"
                id="userSearch"
                placeholder="Buscar por email..."
                style="min-width: 260px"
              />
              <button class="btn-white-outline" id="btnSearch" type="button">
                Buscar
              </button>
              <button class="btn-white-outline" id="btnClear" type="button">
                Limpiar
              </button>
              <span class="hintSmall" style="margin-left: auto"
                >Tip: click en usuario â†’ editar acceso</span
              >
            </div>
            <div id="usersSection" style="display: none; margin-top: 16px">
              <div class="list" id="usersList"></div>
              <button
                class="btn-white-outline"
                id="btnLoadMore"
                style="margin-top: 12px"
              >
                Cargar mÃ¡s
              </button>
            </div>
          </div>
        </details>
      </div>
    </main>
    <!-- Modal: Edit user access -->
    <div
      aria-hidden="true"
      class="modalOverlay"
      id="userModal"
      style="display: none"
    >
      <div class="modalCard">
        <div class="modalHead">
          <div class="modalTitle">Editar usuario</div>
          <button class="btn-white-outline" id="userModalClose" type="button">
            âœ–
          </button>
        </div>
        <div class="hr"></div>
        <div class="panelGrid">
          <div class="card">
            <div class="sectionTitle" style="margin-top: 0">Datos</div>
            <div class="muted" style="font-weight: 900; margin-top: 8px">
              Email
            </div>
            <div class="pill" id="um_email" style="width: fit-content">â€”</div>
            <div class="muted" style="font-weight: 900; margin-top: 12px">
              UID
            </div>
            <div class="hintSmall" id="um_uid">â€”</div>
            <div class="muted" style="font-weight: 900; margin-top: 12px">
              GÃ©nero
            </div>
            <select class="select" id="um_gender">
              <option value="">â€”</option>
              <option value="Papi">Papi</option>
              <option value="Mami">Mami</option>
            </select>
            <div
              class="metaRow"
              style="margin-top: 14px; flex-wrap: wrap; gap: 10px"
            >
              <label class="pill" style="gap: 10px">
                <input
                  id="um_admin"
                  style="width: 18px; height: 18px; margin: 0"
                  type="checkbox"
                />
                Admin
              </label>
              <label class="pill" style="gap: 10px">
                <input
                  id="um_access"
                  style="width: 18px; height: 18px; margin: 0"
                  type="checkbox"
                />
                Acceso
              </label>
              <label class="pill" style="gap: 10px">
                <input
                  id="um_blocked"
                  style="width: 18px; height: 18px; margin: 0"
                  type="checkbox"
                />
                Bloqueado
              </label>
            </div>
            <div
              class="metaRow"
              style="margin-top: 12px; flex-wrap: wrap; gap: 10px"
            >
              <button
                class="btn-white-outline"
                id="um_openPanelAs"
                type="button"
              >
                ğŸ‘€ Ver panel como usuario
              </button>
              <span class="hintSmall">Solo vista (no cambia tu login).</span>
            </div>
          </div>
          <div class="card">
            <div class="sectionTitle" style="margin-top: 0">Plan y fecha</div>
            <div class="muted" style="font-weight: 900; margin-top: 8px">
              Plan
            </div>
            <select class="select" id="um_plan">
              <option value="free">free (7 dÃ­as A1)</option>
              <option value="a1">A1</option>
              <option value="a2">A2</option>
              <option value="b1">B1</option>
              <option value="b2">B2</option>
              <option value="premium_a1">Premium A1 (A1+A2)</option>
              <option value="premium_b1">Premium B1 (B1+A1)</option>
              <option value="premium_b2">Premium B2 (B2+A1)</option>
            </select>
            <div class="muted" style="font-weight: 900; margin-top: 12px">
              Acceso hasta
            </div>
            <input class="input" id="um_until" type="datetime-local" />
            <div class="hintSmall" style="margin-top: 10px">
              Reglas: acceso = admin OR access=true OR plan=premium OR
              accessUntil en el futuro.
            </div>
          </div>
        </div>
        <div class="hr"></div>
        <div class="metaRow" style="flex-wrap: wrap; gap: 10px">
          <button class="btn-yellow" id="um_grant30" type="button">
            â• Premium +30 dÃ­as
          </button>
          <button class="btn-white-outline" id="um_extend30" type="button">
            â³ Extender +30 dÃ­as
          </button>
          <button class="btn-red" id="um_revoke" type="button">
            ğŸ”’ Quitar acceso
          </button>
          <span
            class="hintSmall"
            id="um_status"
            style="margin-left: auto"
          ></span>
        </div>
        <div
          class="metaRow"
          style="margin-top: 12px; justify-content: flex-end; gap: 10px"
        >
          <button class="btn-yellow" id="um_save" type="button">
            ğŸ’¾ Guardar cambios
          </button>
          <button class="btn-white-outline" id="um_cancel" type="button">
            Cancelar
          </button>
        </div>
        <div class="hr"></div>
        <div class="sectionTitle" style="margin-top: 0">ğŸ“ Nota del admin</div>
        <textarea
          class="input"
          id="um_note"
          placeholder="Nota interna (solo admin)â€¦"
          rows="3"
        ></textarea>
        <div class="hr"></div>
        <div class="sectionTitle" style="margin-top: 0">
          ğŸ“œ Historial de acceso
        </div>
        <div class="list" id="um_logs"></div>
        <div class="hintSmall" style="margin-top: 10px">
          Se guarda automÃ¡ticamente cuando cambias acceso/plan/fechas o usas
          botones rÃ¡pidos.
        </div>
      </div>
    </div>
    <script src="assets/js/firebase-init.js" type="module"></script>
    <script src="assets/js/pages/esadmin-page.js" type="module"></script>
  </body>
</html>
