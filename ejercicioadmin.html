<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Admin | Ejercicios | AquiVivo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap"
      rel="stylesheet"
    />

    
    <style id="coffeeFloatStyle">
/* â˜• Floating coffee (global) */
#coffeeFloat{
  position: absolute;
  right: -40px;
  top: 360px;
  width: 420px;
  height: 420px;
  pointer-events: none;
  opacity: 0.9;
  filter: drop-shadow(0 20px 40px rgba(0,0,0,0.35));
  animation: coffeeFloat 7s ease-in-out infinite;
  transform-origin: 50% 60%;
  z-index: 1;
}
#coffeeFloat svg{ width:100%; height:100%; display:block; }
@keyframes coffeeFloat{
  0%   { transform: translateY(0px) translateX(0px) rotate(-1deg) scale(1); }
  50%  { transform: translateY(-18px) translateX(-6px) rotate(1deg) scale(1.02); }
  100% { transform: translateY(0px) translateX(0px) rotate(-1deg) scale(1); }
}
@media (max-width: 980px){
  #coffeeFloat{ display:none; }
}
</style>
<link rel="stylesheet" href="assets/css/styles.css">
</head>

  <body data-page="ejercicioadmin">
    <div id="appHeader"></div>
<div
            aria-hidden="true"
            id="coffeeFloat"
           
          >
            <svg
              class="w-72 h-72 mx-auto drop-shadow-2xl"
              viewbox="0 0 200 200"
              xmlns="http://www.w3.org/2000/svg"
            >
              <defs>
                <lineargradient
                  id="cupGradient"
                  x1="0%"
                  x2="0%"
                  y1="0%"
                  y2="100%"
                >
                  <stop
                    offset="0%"
                    style="stop-color: #8b4513; stop-opacity: 1"
                  ></stop>
                  <stop
                    offset="100%"
                    style="stop-color: #654321; stop-opacity: 1"
                  ></stop>
                </lineargradient>
                <lineargradient
                  id="coffeeGradient"
                  x1="0%"
                  x2="0%"
                  y1="0%"
                  y2="100%"
                >
                  <stop
                    offset="0%"
                    style="stop-color: #6f4e37; stop-opacity: 1"
                  ></stop>
                  <stop
                    offset="100%"
                    style="stop-color: #3e2723; stop-opacity: 1"
                  ></stop>
                </lineargradient>
              </defs>
              <ellipse
                cx="100"
                cy="55"
                fill="#FCD116"
                opacity="0.3"
                rx="70"
                ry="15"
              ></ellipse>
              <ellipse
                cx="100"
                cy="55"
                fill="#003893"
                opacity="0.3"
                rx="60"
                ry="12"
              ></ellipse>
              <ellipse
                cx="100"
                cy="55"
                fill="#FCD116"
                opacity="0.3"
                rx="50"
                ry="10"
              ></ellipse>
              <rect
                fill="#FCD116"
                height="25"
                opacity="0.3"
                rx="5"
                width="30"
                x="85"
                y="55"
              ></rect>
              <path
                d="M 60 120 L 65 160 Q 65 170 75 170 L 125 170 Q 135 170 135 160 L 140 120 Z"
                fill="url(#cupGradient)"
                stroke="#654321"
                stroke-width="2"
              ></path>
              <ellipse
                cx="100"
                cy="120"
                fill="url(#coffeeGradient)"
                rx="35"
                ry="8"
              ></ellipse>
              <path
                d="M 140 130 Q 155 130 155 145 Q 155 160 140 160"
                fill="none"
                stroke="url(#cupGradient)"
                stroke-linecap="round"
                stroke-width="8"
              ></path>
              <rect
                fill="#FCD116"
                height="8"
                opacity="0.6"
                rx="2"
                width="60"
                x="70"
                y="135"
              ></rect>
              <rect
                fill="#003893"
                height="5"
                opacity="0.6"
                rx="1"
                width="60"
                x="70"
                y="145"
              ></rect>
              <rect
                fill="#CE1126"
                height="5"
                opacity="0.6"
                rx="1"
                width="60"
                x="70"
                y="152"
              ></rect>
              <path
                d="M 85 110 Q 80 95 85 85"
                fill="none"
                opacity="0.7"
                stroke="#FCD116"
                stroke-linecap="round"
                stroke-width="3"
              >
                <animate
                  attributename="opacity"
                  dur="2s"
                  repeatcount="indefinite"
                  values="0.7;0.3;0.7"
                ></animate>
                <animate
                  attributename="d"
                  dur="2s"
                  repeatcount="indefinite"
                  values="M 85 110 Q 80 95 85 85;M 85 110 Q 90 95 85 85;M 85 110 Q 80 95 85 85"
                ></animate>
              </path>
              <path
                d="M 100 108 Q 100 90 105 80"
                fill="none"
                opacity="0.8"
                stroke="#FCD116"
                stroke-linecap="round"
                stroke-width="4"
              >
                <animate
                  attributename="opacity"
                  dur="2.5s"
                  repeatcount="indefinite"
                  values="0.8;0.4;0.8"
                ></animate>
                <animate
                  attributename="d"
                  dur="2.5s"
                  repeatcount="indefinite"
                  values="M 100 108 Q 100 90 105 80;M 100 108 Q 105 90 100 80;M 100 108 Q 100 90 105 80"
                ></animate>
              </path>
              <path
                d="M 115 110 Q 120 95 115 85"
                fill="none"
                opacity="0.7"
                stroke="#FCD116"
                stroke-linecap="round"
                stroke-width="3"
              >
                <animate
                  attributename="opacity"
                  dur="2.2s"
                  repeatcount="indefinite"
                  values="0.7;0.3;0.7"
                ></animate>
                <animate
                  attributename="d"
                  dur="2.2s"
                  repeatcount="indefinite"
                  values="M 115 110 Q 120 95 115 85;M 115 110 Q 110 95 115 85;M 115 110 Q 120 95 115 85"
                ></animate>
              </path>
              <ellipse
                cx="50"
                cy="140"
                fill="#3E2723"
                rx="8"
                ry="10"
                transform="rotate(-20 50 140)"
              >
                <animate
                  attributename="opacity"
                  dur="3s"
                  repeatcount="indefinite"
                  values="1;0.7;1"
                ></animate>
              </ellipse>
              <path
                d="M 50 135 Q 50 140 50 145"
                stroke="#654321"
                stroke-width="1.5"
              ></path>
              <ellipse
                cx="150"
                cy="135"
                fill="#3E2723"
                rx="8"
                ry="10"
                transform="rotate(20 150 135)"
              >
                <animate
                  attributename="opacity"
                  dur="3s"
                  repeatcount="indefinite"
                  values="0.7;1;0.7"
                ></animate>
              </ellipse>
              <path
                d="M 150 130 Q 150 135 150 140"
                stroke="#654321"
                stroke-width="1.5"
              ></path>
              <rect
                fill="#FCD116"
                height="8"
                opacity="0.9"
                rx="1"
                width="60"
                x="70"
                y="175"
              ></rect>
              <rect
                fill="#FFFFFF"
                height="8"
                opacity="0.8"
                rx="1"
                width="50"
                x="75"
                y="178"
              ></rect>
              <rect
                fill="#FCD116"
                height="8"
                opacity="0.7"
                rx="1"
                width="40"
                x="80"
                y="181"
              ></rect>
              <path
                d="M 100 100 L 95 95 Q 90 90 90 95 Q 90 100 95 105 L 100 110 L 105 105 Q 110 100 110 95 Q 110 90 105 95 Z"
                fill="#CE1126"
                opacity="0.8"
              >
                <animate
                  attributename="transform"
                  dur="1.5s"
                  repeatcount="indefinite"
                  values="translate(0,0) scale(1);translate(0,-3) scale(1.1);translate(0,0) scale(1)"
                ></animate>
              </path>
            </svg>
          </div>

    <div class="sessionBar">
      SesiÃ³n activa: <strong id="sessionEmail">Cargando...</strong>
    </div>

    <main class="container">
      <div id="toast"></div>

      <div class="card">
        <div class="metaRow">
          <span class="pill pill-yellow" id="pillLevel">Nivel</span>
          <span class="pill pill-blue" id="pillType">Tipo</span>
          <span class="pill" id="pillSlug">slug</span>
          <span class="pill" id="pillCount">Ejercicios: 0</span
          ><span class="pill pill-yellow">ADMIN</span>
          <span
            class="pill"
            id="pillProgress"
            style="
              background: rgba(252, 209, 22, 0.16);
              border-color: rgba(252, 209, 22, 0.35);
            "
            >Progreso: 0%</span
          >
        </div>
        <div class="progressWrap" style="margin-top: 10px">
          <div class="progressBar">
            <div class="progressFill" id="progressFill" style="width: 0%"></div>
          </div>
          <div class="progressText" id="progressText">0 / 0 completados</div>
        </div>

        <h1 id="topicTitle">Cargandoâ€¦</h1>
        <p class="subtitle" id="topicDesc">Cargandoâ€¦</p>

        <div class="metaRow" id="taskChips"></div>
      </div>

      <!-- Lesson content (from course_meta docId: LEVEL__topicSlug) -->
      <div
        id="lessonContentCard"
        class="lessonContentCard"
        style="display: none"
      >
        <div class="lessonContentTitle">
          <h3>ðŸ“˜ LecciÃ³n â€” materiales del tema</h3>
          <div
            style="
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              align-items: center;
            "
          >
            <a class="btn" id="btnOpenLessonPage" href="#"
              >ðŸ“– Abrir lecciÃ³n (pÃ¡gina)</a
            >
          </div>
        </div>

        <div id="lessonContentBody" class="lessonText"></div>
        <div id="lessonContentEmpty" class="lessonEmpty" style="display: none">
          TodavÃ­a no hay contenido de lecciÃ³n para este tema.
        </div>
      </div>

      <div class="sectionTitle">ðŸ§© Ejercicios</div>

      <div
        class="card"
        id="filtersCard"
        style="padding: 14px 14px 12px; margin-bottom: 14px"
      >
        <div
          style="
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
          "
        >
          <div style="flex: 1; min-width: 220px">
            <label style="display: block; font-weight: 700; margin-bottom: 6px"
              >Buscar</label
            >
            <input
              id="filterSearch"
              placeholder="Szukaj po treÅ›ci / odpowiedziâ€¦"
            />
          </div>

          <div style="min-width: 190px">
            <label style="display: block; font-weight: 700; margin-bottom: 6px"
              >Typ</label
            >
            <select id="filterType"></select>
          </div>

          <div style="min-width: 190px">
            <label style="display: block; font-weight: 700; margin-bottom: 6px"
              >Kategoria</label
            >
            <select id="filterCategory">
              <option value="">Wszystko</option>
              <option value="grammar">GramÃ¡tica</option>
              <option value="vocab">Vocabulario</option>
              <option value="both">GramÃ¡tica + vocabulario</option>
            </select>
          </div>

          <button class="btn" id="btnClearFilters" type="button">
            ðŸ§¹ WyczyÅ›Ä‡
          </button>

          <div
            style="
              margin-left: auto;
              display: flex;
              gap: 10px;
              align-items: center;
              flex-wrap: wrap;
            "
          >
            <label
              style="
                display: flex;
                gap: 8px;
                align-items: center;
                user-select: none;
                font-weight: 700;
              "
            >
              <input
                id="toggleReorder"
                type="checkbox"
                style="transform: scale(1.15)"
              />
              Tryb sortowania (drag&drop)
            </label>
            <button
              class="btn btn-yellow"
              id="btnSaveOrder"
              type="button"
              style="display: none"
            >
              ðŸ’¾ Zapisz kolejnoÅ›Ä‡
            </button>
          </div>
        </div>

        <div class="smallNote" style="margin-top: 8px; opacity: 0.95">
          Tip: w trybie sortowania przeciÄ…gaj kafelki. Zapis kolejnoÅ›ci
          aktualizuje pole <b>order</b> w Firestore.
        </div>
      </div>

      <div id="exerciseList"></div>

      <div
        id="emptyExercises"
        class="card"
        style="display: none; opacity: 0.95"
      >
        <div class="muted">TodavÃ­a no hay ejercicios para este tema.</div>
        <div class="smallNote" style="margin-top: 10px">
          Si eres admin, agrega el primero abajo ðŸ‘‡
        </div>
      </div>

      <!-- Admin -->
      <div id="noAdminCard" class="card" style="display: none">
        <div class="sectionTitle">â›” Acceso restringido</div>
        <div class="muted">Esta pÃ¡gina es solo para admin.</div>
      </div>
      <div id="adminWrap" class="card adminWrap">
        <div class="sectionTitle">ðŸ‘‘ Admin â€“ agregar ejercicio</div>

        <div class="card" style="margin-top: 10px">
          <div class="sectionTitle" style="margin-top: 0">
            âš¡ ProducciÃ³n rÃ¡pida
          </div>

          <div
            style="
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
              align-items: center;
            "
          >
            <button class="btn" id="btnTplFill" type="button">
              + Plantilla: rellenar
            </button>
            <button class="btn" id="btnTplChoice" type="button">
              + Plantilla: choice
            </button>
            <button class="btn" id="btnTplTF" type="button">
              + Plantilla: true/false
            </button>
          </div>

          <div style="margin-top: 12px">
            <label style="display: block; font-weight: 800; margin-bottom: 6px"
              >Import JSON (array de ejercicios)</label
            >
            <textarea
              id="importJsonArea"
              placeholder='[
  {"type":"OpciÃ³n mÃºltiple","prompt":"...","options":["A) ...","B) ..."],"answer":"A","category":"grammar","order":1},
  {"type":"Rellenar los espacios","prompt":"...","answer":"...","category":"vocab"}
]'
            ></textarea>
            <div class="smallNote" style="margin-top: 8px">
              - Wklej <b>tablicÄ™</b> Ä‡wiczeÅ„. JeÅ›li element nie ma <b>order</b>,
              dostanie automatycznie kolejny numer.<br />
              - ObsÅ‚ugiwane pola:
              <b
                >type, prompt, options[], answer, category, tags, notes,
                imageUrl, order</b
              >.
            </div>

            <div class="adminActions" style="margin-top: 10px">
              <button class="btn btn-yellow" id="btnImportJson" type="button">
                ðŸ“¥ Importuj i zapisz
              </button>
              <button class="btn" id="btnClearImport" type="button">
                ðŸ§½ WyczyÅ›Ä‡
              </button>
              <span
                class="smallNote"
                id="importStatus"
                style="margin-left: auto"
              ></span>
            </div>
          </div>
        </div>

        <div class="adminGrid">
          <div>
            <label>Tipo de ejercicio</label>
            <select id="exType"></select>
          </div>

          <div>
            <label>Pregunta / enunciado</label>
            <input id="exPrompt" placeholder="Escribe el enunciado..." />
          </div>

          <div>
            <label>Imagen (URL) â€” opcional</label>
            <input id="exImageUrl" placeholder="https://.../imagen.png" />
            <div class="smallNote">
              JeÅ›li dodasz obrazek, pokaÅ¼e siÄ™ nad odpowiedziami.
            </div>
          </div>

          <div>
            <label>Opciones (solo si aplica)</label>
            <textarea
              id="exOptions"
              placeholder="Una opciÃ³n por lÃ­nea&#10;Ej:&#10;A) ...&#10;B) ...&#10;C) ..."
            ></textarea>
            <div class="smallNote">
              Para ejercicios de selecciÃ³n, aÃ±ade al menos 2 opciones (una por
              lÃ­nea).
            </div>
          </div>

          <div>
            <label>Respuesta correcta</label>
            <input
              id="exAnswer"
              placeholder="Ej: B   |   true   |   palabra_correcta"
            />
            <div class="smallNote">
              - OpciÃ³n mÃºltiple: letra (A/B/C/D) o texto exacto.<br />
              - Verdadero o falso: <b>true</b> / <b>false</b>.<br />
              - Campo abierto: wpisz poprawne sÅ‚owo/odpowiedÅº (dokÅ‚adnie).
            </div>
          </div>

          <div>
            <label>Kategoria</label>
            <select id="exCategory">
              <option value="grammar">GramÃ¡tica</option>
              <option value="vocab">Vocabulario</option>
              <option value="both">GramÃ¡tica + vocabulario</option>
            </select>
          </div>

          <div>
            <label>Tagi (opcjonalnie)</label>
            <input
              id="exTags"
              placeholder="np. przypadki, czasowniki, kolokacje (oddziel przecinkami)"
            />
          </div>

          <div>
            <label>Orden</label>
            <input id="exOrder" type="number" min="1" placeholder="np. 1" />
          </div>

          <div>
            <label>Notas (opcjonalnie)</label>
            <input id="exNotes" placeholder="np. wskazÃ³wka / komentarz" />
          </div>
        </div>

        <div class="adminActions">
          <button class="btn btn-yellow" id="btnAddExercise" type="button">
            âž• Guardar ejercicio
          </button>
          <button class="btn" id="btnAutoOrder" type="button">
            âœ¨ Ustaw kolejny numer
          </button>

          <label
            class="smallNote"
            style="
              display: flex;
              align-items: center;
              gap: 8px;
              margin-left: auto;
            "
          >
            <input type="checkbox" id="tplOverwrite" />
            <span>Sobrescribir</span>
          </label>
          <button class="btn" id="btnApplyTemplate" type="button">
            ðŸ§© Plantilla (tipo)
          </button>
        </div>

        <div class="smallNote" style="margin-top: 10px">
          Zapis trafia do Firestore kolekcja: <b>exercises</b> z polami: level,
          topicSlug, order, type, prompt, options[], answer, notes.
        </div>
      </div>
    </main>

    <!-- Preview modal -->
    <div id="previewModal" class="modal" style="display: none">
      <div class="modalBackdrop" id="previewBackdrop"></div>
      <div class="modalBox card">
        <div
          style="
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: space-between;
          "
        >
          <div class="sectionTitle" style="margin: 0">ðŸ‘€ PodglÄ…d (uczeÅ„)</div>
          <button class="btn" id="btnClosePreview" type="button">âœ–</button>
        </div>

        <div id="previewBody" style="margin-top: 10px"></div>

        <div
          style="
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 12px;
            align-items: center;
          "
        >
          <button class="btn btn-yellow" id="btnCheckPreview" type="button">
            âœ… SprawdÅº
          </button>
          <span id="previewResult" class="pill" style="display: none"></span>
        </div>

        <div class="smallNote" style="margin-top: 10px; opacity: 0.95">
          Ten podglÄ…d jest po to, Å¼eby szybko sprawdziÄ‡ czy treÅ›Ä‡ i odpowiedÅº sÄ…
          spÃ³jne.
        </div>
      </div>
    </div>

    <script type="module" src="assets/js/pages/ejercicioadmin-page.js"></script>
    <script src="assets/js/layout.js"></script>
  
<script>
(function(){
  const GLOBAL_KEY = "AV_COFFEE_CFG_GLOBAL";
  const PREFIX = "AV_COFFEE_CFG::";

  const el = document.getElementById("coffeeFloat");
  if(!el) return;

  const defaults = {
    enabled: true,
    anchor: "right",     // "right" or "left"
    x: -40,              // right/left (px)
    y: 360,              // top (px)
    size: 420,           // px
    opacity: 0.9,        // 0..1
    z: 1,                // z-index
    hideMobile: true
  };

  function clamp(n,min,max){ n=Number(n); if(Number.isNaN(n)) return min; return Math.min(max, Math.max(min, n)); }
  function safePath(){
    try{
      const p = (location && location.pathname) ? location.pathname : "";
      return p.replace(/[^a-z0-9_\-./]/gi,"_");
    }catch(e){ return ""; }
  }
  function pageKey(){ return PREFIX + safePath(); }

  function readJSON(key){
    try{
      const raw = localStorage.getItem(key);
      if(!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }

  function loadCfg(){
    const g = readJSON(GLOBAL_KEY) || {};
    const p = readJSON(pageKey()) || {};
    return { ...defaults, ...g, ...p };
  }

  function applyCfg(cfg){
    cfg = { ...defaults, ...cfg };

    if(!cfg.enabled){
      el.style.display = "none";
      return;
    }else{
      el.style.display = "";
    }

    el.style.top = (Number(cfg.y)||defaults.y) + "px";

    const x = Number(cfg.x);
    if(cfg.anchor === "left"){
      el.style.left = (Number.isFinite(x)?x:defaults.x) + "px";
      el.style.right = "auto";
    }else{
      el.style.right = (Number.isFinite(x)?x:defaults.x) + "px";
      el.style.left = "auto";
    }

    const size = clamp(cfg.size, 120, 900);
    el.style.width = size + "px";
    el.style.height = size + "px";
    el.style.opacity = clamp(cfg.opacity, 0.05, 1);
    el.style.zIndex = String(Number(cfg.z)||defaults.z);

    // hide mobile toggle (overrides CSS media query)
    if(cfg.hideMobile === false){
      el.style.setProperty("display","", "important");
    }
  }

  function saveCfg(cfg, scope){
    const key = (scope === "page") ? pageKey() : GLOBAL_KEY;
    localStorage.setItem(key, JSON.stringify(cfg));
  }

  function clearCfg(scope){
    const key = (scope === "page") ? pageKey() : GLOBAL_KEY;
    localStorage.removeItem(key);
  }

  // expose for admin page
  window.AV_Coffee = {
    GLOBAL_KEY,
    PREFIX,
    defaults,
    safePath,
    pageKey,
    load: loadCfg,
    apply: applyCfg,
    save: saveCfg,
    clear: clearCfg
  };

  applyCfg(loadCfg());

  window.addEventListener("storage", (e)=>{
    if(!e || !e.key) return;
    if(e.key === GLOBAL_KEY || e.key === pageKey()) applyCfg(loadCfg());
  });
})();
</script>
</body>
</html>
