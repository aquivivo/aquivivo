<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Lecci√≥n | AquiVivo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --yellow: #fcd116;
        --blue: #003893;
        --red: #ce1126;
        --ink: #0b1b3f;
      }

      * { box-sizing: border-box; }

      body {
        margin: 0;
        font-family: Montserrat, Arial, sans-serif;
        min-height: 100vh;
        background: linear-gradient(180deg, #001a4d, #003893, #001a4d);
        color: white;
      }

      .container {
        max-width: 1100px;
        margin: 0 auto;
        padding: 22px 16px 60px;
      }

      .nav-glass {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(0, 56, 147, 0.78);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.14);
      }
      .nav-glass::after {
        content: "";
        display: block;
        height: 3px;
        background: linear-gradient(90deg, var(--yellow), var(--blue), var(--red));
        opacity: 0.85;
      }
      .nav-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        padding: 14px 16px;
        max-width: 1100px;
        margin: 0 auto;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
        min-width: 180px;
      }
      .logo-flag {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          var(--yellow) 0 33.33%,
          var(--blue) 33.33% 66.66%,
          var(--red) 66.66% 100%
        );
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.25);
      }
      .name {
        font-family: "Playfair Display", serif;
        font-weight: 900;
        font-size: 24px;
        color: white;
        letter-spacing: 0.2px;
      }

      .btn {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        padding: 12px 16px;
        border-radius: 999px;
        font-weight: 900;
        cursor: pointer;
        text-decoration: none;
        border: 1px solid rgba(255, 255, 255, 0.18);
        user-select: none;
        transition: transform 0.12s ease, filter 0.12s ease;
        background: rgba(255, 255, 255, 0.12);
        color: white;
        white-space: nowrap;
      }
      .btn:hover { transform: translateY(-2px); filter: brightness(1.03); }
      .btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

      .btn-yellow {
        background: rgba(252, 209, 22, 0.95);
        border-color: rgba(252, 209, 22, 0.7);
        color: var(--ink);
      }
      .btn-red {
        background: rgba(206, 17, 38, 0.92);
        border-color: rgba(206, 17, 38, 0.8);
        color: white;
      }

      .sessionBar {
        background: var(--yellow);
        padding: 8px 0;
        text-align: center;
        font-size: 12px;
        color: var(--blue);
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .sessionBar strong { font-weight: 900; }

      h1 {
        font-family: "Playfair Display", serif;
        font-weight: 900;
        font-size: 44px;
        margin: 18px 0 6px 0;
        line-height: 1.05;
        color: var(--yellow);
      }
      .subtitle {
        opacity: 0.9;
        margin: 0 0 16px 0;
        max-width: 900px;
        line-height: 1.6;
      }

      .card {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.18);
        backdrop-filter: blur(12px);
        border-radius: 16px;
        padding: 16px;
        margin: 14px 0;
      }

      .metaRow {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin-top: 10px;
      }
      .pill {
        font-size: 12px;
        font-weight: 900;
        border-radius: 999px;
        padding: 6px 10px;
        border: 1px solid rgba(255, 255, 255, 0.18);
        background: rgba(255, 255, 255, 0.12);
        color: white;
      }
      .pill-blue { border-color: rgba(0, 56, 147, 0.35); }
      .pill-yellow {
        background: rgba(252, 209, 22, 0.95);
        color: var(--ink);
        border-color: rgba(252, 209, 22, 0.7);
      }

      .sectionTitle {
        margin: 22px 0 12px;
        font-size: 16px;
        font-weight: 900;
        letter-spacing: 0.3px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      /* Exercises */
      .exercise {
        background: white;
        color: var(--ink);
        border-radius: 16px;
        padding: 16px;
        margin: 10px 0;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.22);
        position: relative;
      }
      .exercise h3 {
        margin: 0 0 8px;
        font-size: 16px;
        font-weight: 900;
        color: var(--blue);
      }
      .exercise .type {
        display: inline-flex;
        font-size: 12px;
        font-weight: 900;
        padding: 6px 10px;
        border-radius: 999px;
        background: rgba(0, 56, 147, 0.08);
        color: var(--blue);
        border: 1px solid rgba(0, 56, 147, 0.16);
        margin-bottom: 10px;
      }
      .exercise .prompt { margin: 0 0 12px; color: #374151; line-height: 1.55; }
      .opts { display: grid; gap: 10px; }
      .optBtn {
        text-align: left;
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        background: #f9fafb;
        cursor: pointer;
        font-weight: 800;
        transition: transform 0.08s ease, filter 0.08s ease;
      }
      .optBtn:hover { filter: brightness(0.99); transform: translateY(-1px); }
      .optBtn[disabled] { opacity: 0.75; cursor: not-allowed; transform: none; }

      .inputRow {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
      }
      .textInput {
        width: min(520px, 100%);
        padding: 12px 12px;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
        font-size: 14px;
      }
      .smallNote { font-size: 12px; color: #6b7280; margin-top: 8px; }
      .result { margin-top: 10px; font-weight: 900; }
      .ok { color: #065f46; }
      .bad { color: #b91c1c; }

      /* Admin */
      .adminWrap { display: none; }
      .adminGrid {
        display: grid;
        gap: 10px;
        grid-template-columns: 180px 1fr;
        align-items: start;
      }
      @media (max-width: 860px) {
        .nav-inner { flex-wrap: wrap; }
        .adminGrid { grid-template-columns: 1fr; }
        h1 { font-size: 36px; }
      }
      .adminGrid label {
        font-size: 12px;
        opacity: 0.9;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .adminGrid input, .adminGrid textarea, .adminGrid select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.25);
        background: rgba(255, 255, 255, 0.12);
        color: white;
        padding: 10px 12px;
        font-size: 14px;
        outline: none;
      }
      .adminGrid textarea { min-height: 92px; resize: vertical; }
      .adminGrid input::placeholder, .adminGrid textarea::placeholder { color: rgba(255, 255, 255, 0.55); }
      .adminGrid option { background: var(--blue); color: white; }

      .adminActions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }

      .dangerMini {
        position: absolute;
        top: 10px;
        right: 10px;
        border: none;
        border-radius: 10px;
        padding: 8px 10px;
        font-weight: 900;
        cursor: pointer;
        background: var(--red);
        color: white;
      }

      /* Toast + validation */
      #toast {
        display: none;
        position: fixed;
        left: 50%;
        bottom: 18px;
        transform: translateX(-50%);
        z-index: 999;
        padding: 12px 14px;
        border-radius: 999px;
        font-weight: 900;
        letter-spacing: 0.2px;
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.28);
        border: 1px solid rgba(255,255,255,0.18);
        backdrop-filter: blur(10px);
      }
      .toast-ok { background: rgba(6, 95, 70, 0.92); color: white; }
      .toast-bad { background: rgba(185, 28, 28, 0.92); color: white; }
      .toast-warn { background: rgba(252, 209, 22, 0.94); color: var(--ink); border-color: rgba(252, 209, 22, 0.7); }

      .field-bad { outline: 2px solid rgba(206, 17, 38, 0.95); outline-offset: 2px; }
      .muted { opacity: 0.9; }
    
      .modal { position: fixed; inset: 0; z-index: 200; }
      .modalBackdrop { position: absolute; inset: 0; background: rgba(0,0,0,.55); }
      .modalBox {
        position: relative;
        width: min(760px, calc(100vw - 28px));
        max-height: calc(100vh - 28px);
        overflow: auto;
        margin: 14px auto;
        padding: 16px 16px 14px;
        border: 1px solid rgba(255,255,255,.16);
      }
      .dragHint { cursor: grab; }
      .dragging { opacity: .6; transform: scale(.99); }


      /* --- Lesson navigation + completion --- */
      .lessonTopTools{
        display:flex;
        gap:10px;
        flex-wrap: wrap;
        align-items:center;
        justify-content: space-between;
        margin: 10px 0 14px;
      }
      .lessonNavRow{
        display:flex;
        gap:10px;
        flex-wrap: wrap;
        align-items:center;
      }
      .btnGhost{
        background: rgba(255,255,255,0.10);
        border: 1px solid rgba(255,255,255,0.18);
        color: white;
        border-radius: 999px;
        padding: 10px 12px;
        font-weight: 800;
        cursor: pointer;
      }
      .btnGhost:hover{ filter: brightness(1.05); transform: translateY(-1px); }
      .btnPrimary{
        background: var(--yellow);
        border: none;
        color: #111827;
        border-radius: 999px;
        padding: 10px 12px;
        font-weight: 900;
        cursor: pointer;
      }
      .btnPrimary:hover{ filter: brightness(1.02); transform: translateY(-1px); }
      .pillDone{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 10px 12px;
        border-radius: 999px;
        background: rgba(34,197,94,.14);
        border: 1px solid rgba(34,197,94,.25);
        color: #eafff1;
        font-weight: 900;
      }
      .pillNotDone{
        display:inline-flex;
        align-items:center;
        gap:8px;
        padding: 10px 12px;
        border-radius: 999px;
        background: rgba(239,68,68,.12);
        border: 1px solid rgba(239,68,68,.22);
        color: #ffecec;
        font-weight: 900;
      }
      .hintSmall{ font-size: 12px; opacity: .78; margin-top: 8px; }

    </style>
  </head>

  <body>
    <header class="nav-glass">
      <div class="nav-inner">
        <div class="brand">
          <div class="logo-flag" aria-hidden="true"></div>
          <div class="name">Aqui vivo</div>
        </div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <a id="backToCourse" class="btn" href="course.html?level=A1">‚¨ÖÔ∏è Volver al curso</a>
          <a class="btn" id="levelsBtn" href="course.html?level=A1">üìö Niveles</a>
          <button class="btn btn-yellow" id="btnCopyLink" type="button">üîó Copiar enlace</button>
          <button class="btn" id="btnReload" type="button">üîÑ Recargar</button>
        </div>
      </div>
    </header>

    <div class="sessionBar">
      Sesi√≥n activa: <strong id="sessionEmail">Cargando...</strong>
    </div>

    <main class="container">
      <div id="toast"></div>

      <div class="card">
        <div class="metaRow">
          <span class="pill pill-yellow" id="pillLevel">Nivel</span>
          <span class="pill pill-blue" id="pillType">Tipo</span>
          <span class="pill" id="pillSlug">slug</span>
          <span class="pill" id="pillCount">Ejercicios: 0</span>
        </div>

        <h1 id="topicTitle">Cargando‚Ä¶</h1>
        <p class="subtitle" id="topicDesc">Cargando‚Ä¶</p>

        <div class="metaRow" id="taskChips"></div>
      </div>

      <div class="sectionTitle">üß© Ejercicios</div>

      <div class="card" id="filtersCard" style="padding:14px 14px 12px; margin-bottom:14px">
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end">
          <div style="flex:1; min-width:220px">
            <label style="display:block; font-weight:700; margin-bottom:6px">Buscar</label>
            <input id="filterSearch" placeholder="Szukaj po tre≈õci / odpowiedzi‚Ä¶" />
          </div>

          <div style="min-width:190px">
            <label style="display:block; font-weight:700; margin-bottom:6px">Typ</label>
            <select id="filterType"></select>
          </div>

          <div style="min-width:190px">
            <label style="display:block; font-weight:700; margin-bottom:6px">Kategoria</label>
            <select id="filterCategory">
              <option value="">Wszystko</option>
              <option value="grammar">Gramatyka</option>
              <option value="vocab">S≈Çownictwo</option>
              <option value="both">Gramatyka + s≈Çownictwo</option>
            </select>
          </div>

          <button class="btn" id="btnClearFilters" type="button">üßπ Wyczy≈õƒá</button>

          <div style="margin-left:auto; display:flex; gap:10px; align-items:center; flex-wrap:wrap">
            <label style="display:flex; gap:8px; align-items:center; user-select:none; font-weight:700">
              <input id="toggleReorder" type="checkbox" style="transform:scale(1.15)" />
              Tryb sortowania (drag&drop)
            </label>
            <button class="btn btn-yellow" id="btnSaveOrder" type="button" style="display:none">üíæ Zapisz kolejno≈õƒá</button>
          </div>
        </div>

        <div class="smallNote" style="margin-top:8px; opacity:.95">
          Tip: w trybie sortowania przeciƒÖgaj kafelki. Zapis kolejno≈õci aktualizuje pole <b>order</b> w Firestore.
        </div>
      </div>

      <div id="exerciseList"></div>

      <div id="emptyExercises" class="card" style="display:none; opacity:0.95">
        <div class="muted">
          Todav√≠a no hay ejercicios para este tema.
        </div>
        <div class="smallNote" style="margin-top:10px">
          Si eres admin, agrega el primero abajo üëá
        </div>
      </div>

      <!-- Admin -->
      <div id="adminWrap" class="card adminWrap">
        <div class="sectionTitle">üëë Admin ‚Äì agregar ejercicio</div>

        <div class="adminGrid">
          <div>
            <label>Tipo de ejercicio</label>
            <select id="exType"></select>
          </div>

          <div>
            <label>Pregunta / enunciado</label>
            <input id="exPrompt" placeholder="Escribe el enunciado..." />
          </div>

          <div>
            <label>Opciones (solo si aplica)</label>
            <textarea
              id="exOptions"
              placeholder="Una opci√≥n por l√≠nea&#10;Ej:&#10;A) ...&#10;B) ...&#10;C) ..."
            ></textarea>
            <div class="smallNote">
              Para ejercicios de selecci√≥n, a√±ade al menos 2 opciones (una por l√≠nea).
            </div>
          </div>

          <div>
            <label>Respuesta correcta</label>
            <input id="exAnswer" placeholder="Ej: B   |   true   |   palabra_correcta" />
            <div class="smallNote">
              - Opci√≥n m√∫ltiple: letra (A/B/C/D) o texto exacto.<br />
              - Verdadero o falso: <b>true</b> / <b>false</b>.<br />
              - Campo abierto: wpisz poprawne s≈Çowo/odpowied≈∫ (dok≈Çadnie).
            </div>
          </div>

          <div>
            <label>Kategoria</label>
            <select id="exCategory">
              <option value="grammar">Gramatyka</option>
              <option value="vocab">S≈Çownictwo</option>
              <option value="both">Gramatyka + s≈Çownictwo</option>
            </select>
          </div>

          <div>
            <label>Tagi (opcjonalnie)</label>
            <input id="exTags" placeholder="np. przypadki, czasowniki, kolokacje (oddziel przecinkami)" />
          </div>

          <div>
            <label>Orden</label>
            <input id="exOrder" type="number" min="1" placeholder="np. 1" />
          </div>

          <div>
            <label>Notas (opcjonalnie)</label>
            <input id="exNotes" placeholder="np. wskaz√≥wka / komentarz" />
          </div>
        </div>

        <div class="adminActions">
          <button class="btn btn-yellow" id="btnAddExercise" type="button">‚ûï Guardar ejercicio</button>
          <button class="btn" id="btnAutoOrder" type="button">‚ú® Ustaw kolejny numer</button>
        </div>

        <div class="smallNote" style="margin-top:10px">
          Zapis trafia do Firestore kolekcja: <b>exercises</b> z polami: level, topicSlug, order, type, prompt, options[], answer, notes.
        </div>
      </div>
    </main>

    
    <!-- Preview modal -->
    <div id="previewModal" class="modal" style="display:none">
      <div class="modalBackdrop" id="previewBackdrop"></div>
      <div class="modalBox card">
        <div style="display:flex; gap:10px; align-items:center; justify-content:space-between">
          <div class="sectionTitle" style="margin:0">üëÄ PodglƒÖd (ucze≈Ñ)</div>
          <button class="btn" id="btnClosePreview" type="button">‚úñ</button>
        </div>

        <div id="previewBody" style="margin-top:10px"></div>

        <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:12px; align-items:center">
          <button class="btn btn-yellow" id="btnCheckPreview" type="button">‚úÖ Sprawd≈∫</button>
          <span id="previewResult" class="pill" style="display:none"></span>
        </div>

        <div class="smallNote" style="margin-top:10px; opacity:.95">
          Ten podglƒÖd jest po to, ≈ºeby szybko sprawdziƒá czy tre≈õƒá i odpowied≈∫ sƒÖ sp√≥jne.
        </div>
      </div>
    </div>

<script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
      import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        addDoc,
        deleteDoc,
        doc,
        getDoc,
        orderBy,
        serverTimestamp,
        updateDoc,
      } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

      // ‚úÖ Firebase config (Twoje)
      const firebaseConfig = {
        apiKey: "AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM",
        authDomain: "aquivivo-platform.firebaseapp.com",
        projectId: "aquivivo-platform",
        storageBucket: "aquivivo-platform.firebasestorage.app",
        messagingSenderId: "116115622011",
        appId: "1:116115622011:web:33a4a583eba4368071bade",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const ADMIN_EMAIL = "aquivivo.pl@gmail.com";

      // URL params
      const params = new URLSearchParams(window.location.search);
      const LEVEL = (params.get("level") || "A1").toUpperCase();
      const slugParam = params.get("slug") || "";
      const idParam = params.get("id") || "";

      // UI refs
      const toast = document.getElementById("toast");
      const sessionEmail = document.getElementById("sessionEmail");
      const backToCourse = document.getElementById("backToCourse");
      const levelsBtn = document.getElementById("levelsBtn");
      const btnCopyLink = document.getElementById("btnCopyLink");
      const btnReload = document.getElementById("btnReload");

      const pillLevel = document.getElementById("pillLevel");
      const pillType = document.getElementById("pillType");
      const pillSlug = document.getElementById("pillSlug");
      const pillCount = document.getElementById("pillCount");

      const topicTitle = document.getElementById("topicTitle");
      const topicDesc = document.getElementById("topicDesc");
      const taskChips = document.getElementById("taskChips");

      const exerciseList = document.getElementById("exerciseList");
      const emptyExercises = document.getElementById("emptyExercises");
      const adminWrap = document.getElementById("adminWrap");

      // admin fields
      const exType = document.getElementById("exType");
      const exPrompt = document.getElementById("exPrompt");
      const exOptions = document.getElementById("exOptions");
      const exAnswer = document.getElementById("exAnswer");
      const exCategory = document.getElementById("exCategory");
      const exTags = document.getElementById("exTags");
      const exOrder = document.getElementById("exOrder");
      const exNotes = document.getElementById("exNotes");
      const btnAddExercise = document.getElementById("btnAddExercise");
      const btnAutoOrder = document.getElementById("btnAutoOrder");

      // Filters + reorder
      const filterSearch = document.getElementById("filterSearch");
      const filterType = document.getElementById("filterType");
      const filterCategory = document.getElementById("filterCategory");
      const btnClearFilters = document.getElementById("btnClearFilters");
      const toggleReorder = document.getElementById("toggleReorder");
      const btnSaveOrder = document.getElementById("btnSaveOrder");

      // Preview modal
      const previewModal = document.getElementById("previewModal");
      const previewBackdrop = document.getElementById("previewBackdrop");
      const btnClosePreview = document.getElementById("btnClosePreview");
      const previewBody = document.getElementById("previewBody");
      const btnCheckPreview = document.getElementById("btnCheckPreview");
      const previewResult = document.getElementById("previewResult");

      // ===== helpers =====
      function escapeHtml(s) {
        return String(s ?? "")
          .replaceAll("&", "&amp;")
          .replaceAll("<", "&lt;")
          .replaceAll(">", "&gt;")
          .replaceAll('"', "&quot;")
          .replaceAll("'", "&#039;");
      }

      function normalizeAnswer(a) {
        return String(a ?? "").trim();
      }

      function parseOptions(raw) {
        return String(raw ?? "")
          .split("\n")
          .map((x) => x.trim())
          .filter(Boolean);
      }

      function showToast(msg, kind = "ok", ms = 2200) {
        toast.className = "";
        toast.style.display = "block";
        toast.textContent = msg;

        if (kind === "ok") toast.classList.add("toast-ok");
        if (kind === "bad") toast.classList.add("toast-bad");
        if (kind === "warn") toast.classList.add("toast-warn");

        clearTimeout(showToast._t);
        showToast._t = setTimeout(() => {
          toast.style.display = "none";
        }, ms);
      }

      function markBad(el, bad) {
        if (!el) return;
        if (bad) el.classList.add("field-bad");
        else el.classList.remove("field-bad");
      }

      function setSaving(isSaving) {
        btnAddExercise.disabled = isSaving;
        btnAutoOrder.disabled = isSaving;
        btnAddExercise.textContent = isSaving ? "‚è≥ Guardando..." : "‚ûï Guardar ejercicio";
      }

      // ===== UX buttons =====
      backToCourse.href = `course.html?level=${encodeURIComponent(LEVEL)}`;
      levelsBtn.href = `course.html?level=${encodeURIComponent(LEVEL)}`;
      pillLevel.textContent = `Nivel ${LEVEL}`;

      btnCopyLink.onclick = async () => {
        try {
          await navigator.clipboard.writeText(window.location.href);
          showToast("‚úÖ Enlace copiado", "ok", 1800);
        } catch {
          showToast("‚ö†Ô∏è No se pudo copiar (bloqueado por navegador)", "warn", 2600);
        }
      };
      btnReload.onclick = () => window.location.reload();

      // ===== Exercise types (Twoja lista) =====
      const TASK_OPTIONS = [
        "Rellenar los espacios",
        "Relacionar palabra con imagen",
        "Relacionar palabra con traducci√≥n",
        "Elegir la palabra correcta",
        "Tarjetas interactivas",
        "Agrupar palabras",
        "Verdadero o falso",
        "Completar la frase con una imagen",
        "Juego de memoria (pares)",
        "Opci√≥n m√∫ltiple",
        "Completar la forma correcta",
        "Elegir la forma correcta",
        "Transformaciones",
        "Relacionar pregunta con respuesta",
        "Ordenar palabras para formar una frase",
        "Corregir errores",
        "Unir dos partes de la frase",
        "Completar con preposici√≥n o terminaci√≥n",
        "Opci√≥n √∫nica",
        "Escribir tu propia respuesta",
        "Repetir despu√©s del narrador",
        "Completar la frase con tu voz",
        "Responder a una pregunta",
        "Describir una imagen",
        "Juego de roles",
        "Mini-mon√≥logo",
        "Di√°logo semiabierto",
        "Decirlo de otra manera",
        "Escuchar y elegir la respuesta",
        "Escuchar y completar los espacios",
        "Escuchar y marcar verdadero o falso",
        "Escuchar y relacionar personas",
        "Escuchar y ordenar la secuencia",
        "Dictado con audio",
        "Escuchar y repetir",
        "Di√°logo interactivo",
        "Misi√≥n del d√≠a",
        "Quiz situacional",
        "Video con preguntas",
        "Test final del tema",
        "Debate grabado",
        "Contar una historia",
        "Simulaci√≥n de entrevista de trabajo",
        "Retroalimentaci√≥n por voz",
      ];

      function fillExerciseTypes() {
        exType.innerHTML = TASK_OPTIONS.map((t) => `<option value="${escapeHtml(t)}">${escapeHtml(t)}</option>`).join("");
        const saved = localStorage.getItem("lastExerciseType");
        if (saved && TASK_OPTIONS.includes(saved)) exType.value = saved;
        exType.addEventListener("change", () => localStorage.setItem("lastExerciseType", exType.value));
      }

      // ===== Safe "no params" screen =====
      if (!params.get("level") && !params.get("id") && !params.get("slug")) {
        topicTitle.textContent = "Brak wybranego tematu";
        topicDesc.textContent =
          "Otw√≥rz najpierw course.html i kliknij temat (lesson otworzy siƒô automatycznie z parametrami).";
        pillType.textContent = "‚Äî";
        pillSlug.textContent = "slug: ‚Äî";
        pillCount.textContent = "Ejercicios: ‚Äî";
        exerciseList.innerHTML = "";
        emptyExercises.style.display = "block";
      }

      // ===== Topic loading =====
      let currentTopic = null;
      let isAdmin = false;
      let cachedExercises = [];

      function normalizeTopic(t) {
        return {
          id: t.id,
          level: (t.level || "").toString().toUpperCase(),
          type: (t.type || "").toString(),
          title: t.title || "",
          desc: t.desc || "",
          slug: (t.slug || slugParam || t.id || "").toString(),
          tasks: Array.isArray(t.tasks) ? t.tasks : [],
        };
      }

      function renderTopic(t) {
        pillType.textContent = t.type === "grammar" ? "Gram√°tica" : "Vocabulario";
        const eff = (t.slug || t.id) ? String(t.slug || t.id) : "";
        pillSlug.textContent = eff ? `slug: ${eff}` : "slug: ‚Äî";
        topicTitle.textContent = t.title || "Tema";
        topicDesc.textContent = t.desc || "";

        taskChips.innerHTML = "";
        if (t.tasks && t.tasks.length) {
          t.tasks.slice(0, 14).forEach((x) => {
            const span = document.createElement("span");
            span.className = "pill";
            span.textContent = x;
            taskChips.appendChild(span);
          });
        }
      }

      async function loadTopic() {
        // 1) by id
        if (idParam) {
          const ref = doc(db, "courses", idParam);
          const snap = await getDoc(ref);
          if (!snap.exists()) return null;
          const data = snap.data();
          currentTopic = normalizeTopic({ id: snap.id, ...data });
          renderTopic(currentTopic);
          return currentTopic;
        }

        // 2) by slug + level
        if (!slugParam) return null;

        const q = query(collection(db, "courses"), where("level", "==", LEVEL), where("slug", "==", slugParam));
        const snap = await getDocs(q);
        if (snap.empty) return null;

        const d = snap.docs[0];
        currentTopic = normalizeTopic({ id: d.id, ...d.data() });
        renderTopic(currentTopic);
        return currentTopic;
      }

      // ===== Exercises loading/render =====

      function renderExerciseList() {
        exerciseList.innerHTML = "";

        const list = Array.isArray(VIEW_EXERCISES) ? VIEW_EXERCISES : [];
        const total = Array.isArray(ALL_EXERCISES) ? ALL_EXERCISES.length : 0;
        const shown = list.length;

        pillCount.textContent = qLabel(total, shown);

        if (!shown) {
          emptyExercises.style.display = "block";
          return;
        }

        emptyExercises.style.display = "none";

        // Ensure visual order label is consistent with current array order in reorder mode
        list.forEach((ex, idx) => {
          // For display only; actual "order" is saved to Firestore when you click "Zapisz kolejno≈õƒá"
          if (REORDER_MODE && IS_ADMIN) ex.__tmpOrder = idx + 1;
        });

        list.forEach((ex, idx) => {
          const x = { ...ex, order: (REORDER_MODE && IS_ADMIN) ? (ex.__tmpOrder || (idx + 1)) : ex.order };
          exerciseList.insertAdjacentHTML("beforeend", renderExerciseCard(x, idx));
        });

        list.forEach((ex) => attachExerciseHandlers(ex));
      }

      function qLabel(total, shown) {
        if (!filterSearch && !filterType && !filterCategory) return `Ejercicios: ${total}`;
        if (shown === total) return `Ejercicios: ${total}`;
        return `Ejercicios: ${shown} / ${total}`;
      }
      function getNextOrder() {
        if (!cachedExercises.length) return 1;
        const max = Math.max(...cachedExercises.map((x) => Number(x.order || 0)));
        return (max || 0) + 1;
      }

      function renderExerciseCard(ex, idx) {
        const type = ex.type || "Ejercicio";
        const prompt = ex.prompt || "";
        const options = Array.isArray(ex.options) ? ex.options : [];
        const order = Number(ex.order || idx + 1);

        const isChoice = options.length >= 2;
        const isFill = type === "Rellenar los espacios" || !isChoice;

        const optionsHtml = isFill
          ? `
            <div class="inputRow">
              <input class="textInput" id="inp-${ex.id}" placeholder="Escribe tu respuesta..." />
              <button class="btn btn-yellow" id="chk-${ex.id}" type="button">Comprobar</button>
            </div>
          `
          : `
            <div class="opts" id="opts-${ex.id}">
              ${options
                .map((o) => `<button class="optBtn" type="button" data-ex="${ex.id}" data-opt="${escapeHtml(o)}">${escapeHtml(o)}</button>`)
                .join("")}
            </div>
          `;

        const adminControls = isAdmin
          ? `
              <div style="display:flex; gap:8px; align-items:center">
                <button class="btn" id="pv-${ex.id}" type="button" title="PodglƒÖd (ucze≈Ñ)">üëÄ</button>
                <button class="dangerMini" id="del-${ex.id}" type="button" title="Eliminar">üóë</button>
              </div>
            `
          : "";

        return `
          <div class="exercise ${REORDER_MODE && IS_ADMIN ? "dragHint" : ""}" id="ex-${ex.id}" data-id="${ex.id}" ${REORDER_MODE && IS_ADMIN ? "draggable=\"true\"" : ""}>
            ${adminControls}
            <div class="type">${escapeHtml(type)} ¬∑ #${order} ${ex.category ? ` ¬∑ <span class="pill pill-blue" style="padding:2px 8px; font-size:12px">${escapeHtml(ex.category)}</span>` : ""}</div>
            <h3>${escapeHtml(prompt)}</h3>
            ${optionsHtml}
            <div class="result" id="res-${ex.id}"></div>
            ${ex.notes ? `<div class="smallNote">${escapeHtml(ex.notes)}</div>` : ""}
          </div>
        `;
      }

      function disableChoiceButtons(exId) {
        const wrap = document.getElementById(`opts-${exId}`);
        if (!wrap) return;
        wrap.querySelectorAll("button.optBtn").forEach((b) => (b.disabled = true));
      }

      function attachExerciseHandlers(ex) {
        const correct = String(ex.answer || "").trim();
        const res = document.getElementById(`res-${ex.id}`);

        // delete
        if (isAdmin) {
        document.getElementById('btnStudentPreview')?.addEventListener('click', ()=>{
          const url = `lesson.html?level=${encodeURIComponent(LEVEL)}&id=${encodeURIComponent(TOPIC_ID)}&preview=1`;
          window.open(url, '_blank', 'noopener,noreferrer');
        });
          const delBtn = document.getElementById(`del-${ex.id}`);
          if (delBtn) {
            delBtn.onclick = async (ev) => {
              ev.stopPropagation();
              if (!confirm("UsunƒÖƒá to zadanie?")) return;
              try {
                await deleteDoc(doc(db, "exercises", ex.id));
                showToast("üóë Usuniƒôto", "ok", 1600);
                await loadExercises(currentTopic);
              } catch (e) {
                console.error(e);
                showToast("‚ùå B≈ÇƒÖd usuwania (sprawd≈∫ konsolƒô)", "bad", 3200);
              }
            };
          }
        }

        // preview (admin)
        if (isAdmin) {
          const pvBtn = document.getElementById(`pv-${ex.id}`);
          if (pvBtn) {
            pvBtn.onclick = (ev) => {
              ev.stopPropagation();
              openPreview(ex);
            };
          }
        }

        // drag&drop reorder (admin)
        const card = document.getElementById(`ex-${ex.id}`);
        if (card && isAdmin && REORDER_MODE) {
          card.addEventListener("dragstart", (e) => {
            DRAG_ID = ex.id;
            card.classList.add("dragging");
            e.dataTransfer.effectAllowed = "move";
          });
          card.addEventListener("dragend", () => {
            card.classList.remove("dragging");
          });
          card.addEventListener("dragover", (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
          });
          card.addEventListener("drop", (e) => {
            e.preventDefault();
            const targetId = card.getAttribute("data-id");
            if (!DRAG_ID || !targetId || DRAG_ID === targetId) return;

            const fromIdx = ALL_EXERCISES.findIndex((x) => x.id === DRAG_ID);
            const toIdx = ALL_EXERCISES.findIndex((x) => x.id === targetId);
            if (fromIdx < 0 || toIdx < 0) return;

            const [moved] = ALL_EXERCISES.splice(fromIdx, 1);
            ALL_EXERCISES.splice(toIdx, 0, moved);
            HAS_ORDER_CHANGES = true;
            applyFilters();
          });
        }


        // text input mode
        const inp = document.getElementById(`inp-${ex.id}`);
        const chk = document.getElementById(`chk-${ex.id}`);
        if (inp && chk && res) {
          const check = () => {
            const user = String(inp.value || "").trim();
            if (!user) return;

            const ok = user.toLowerCase() === correct.toLowerCase();
            res.innerHTML = ok
              ? `<span class="ok">‚úÖ Correcto</span>`
              : `<span class="bad">‚ùå Incorrecto</span> <span class="smallNote">Correcta: ${escapeHtml(correct)}</span>`;
          };

          chk.onclick = check;
          inp.addEventListener("keydown", (e) => {
            if (e.key === "Enter") check();
          });
          return;
        }

        // choice mode
        const wrap = document.getElementById(`opts-${ex.id}`);
        if (!wrap || !res) return;

        wrap.querySelectorAll("button.optBtn").forEach((btn) => {
          btn.onclick = () => {
            const picked = btn.getAttribute("data-opt") || "";
            const ok = picked.trim().toLowerCase() === correct.trim().toLowerCase();

            res.innerHTML = ok
              ? `<span class="ok">‚úÖ Correcto</span>`
              : `<span class="bad">‚ùå Incorrecto</span> <span class="smallNote">Correcta: ${escapeHtml(correct)}</span>`;

            if (ok) disableChoiceButtons(ex.id);
          };
        });
      }

      async function loadExercises(topic) {
        exerciseList.innerHTML = "";
        emptyExercises.style.display = "none";
        cachedExercises = [];

        const effectiveSlug = (topic && (topic.slug || topic.id)) ? String(topic.slug || topic.id) : "";

        if (!effectiveSlug) {
          emptyExercises.style.display = "block";
          pillCount.textContent = "Ejercicios: ‚Äî";
          return;
        }

        const qx = query(
          collection(db, "exercises"),
          where("level", "==", LEVEL),
          where("topicSlug", "==", effectiveSlug),
          orderBy("order", "asc"),
        );

        const snap = await getDocs(qx);
        if (snap.empty) {
          emptyExercises.style.display = "block";
          pillCount.textContent = "Ejercicios: 0";
          return;
        }

        snap.forEach((d) => cachedExercises.push({ id: d.id, ...d.data() }));

        // state for filters/reorder
        ALL_EXERCISES = cachedExercises.slice();
        VIEW_EXERCISES = cachedExercises.slice();
        buildTypeFilterOptions();
        applyFilters();

        // admin conveniences
        if (isAdmin) {
          exOrder.value = getNextOrder();
        }
      }

      // ===== Auth + boot =====
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = "login.html";
          return;
        }

        sessionEmail.textContent = user.email || "(sin correo)";
        isAdmin = (user.email || "") === ADMIN_EMAIL;
        IS_ADMIN = isAdmin;
        adminWrap.style.display = isAdmin ? "block" : "none";

        fillExerciseTypes();

        // UI wiring
        if (filterType) {
          // default options; real types filled after load
          filterType.innerHTML = `<option value="">Wszystko</option>`;
        }
        if (!IS_ADMIN) {
          if (toggleReorder) toggleReorder.disabled = true;
          if (toggleReorder) toggleReorder.checked = false;
        }

        const onFilter = () => applyFilters();
        filterSearch?.addEventListener("input", onFilter);
        filterType?.addEventListener("change", onFilter);
        filterCategory?.addEventListener("change", onFilter);

        btnClearFilters?.addEventListener("click", () => {
          if (filterSearch) filterSearch.value = "";
          if (filterType) filterType.value = "";
          if (filterCategory) filterCategory.value = "";
          applyFilters();
        });

        toggleReorder?.addEventListener("change", () => {
          if (!IS_ADMIN) return;
          setReorderMode(toggleReorder.checked);
        });

        btnSaveOrder?.addEventListener("click", async () => {
          if (!IS_ADMIN) return;
          if (!currentTopic || !currentTopic.slug) return;
          if (!HAS_ORDER_CHANGES) {
            setToast("Brak zmian w kolejno≈õci.", "info");
            return;
          }

          try {
            btnSaveOrder.disabled = true;
            // save sequential order starting at 1
            for (let i = 0; i < ALL_EXERCISES.length; i++) {
              const ex = ALL_EXERCISES[i];
              await updateDoc(doc(db, "exercises", ex.id), { order: i + 1 });
            }
            setToast("üíæ Zapisano kolejno≈õƒá.", "ok");
            HAS_ORDER_CHANGES = false;
            await loadExercises(currentTopic);
          } catch (e) {
            console.error(e);
            setToast("‚ùå Nie uda≈Ço siƒô zapisaƒá kolejno≈õci (konsola).", "error");
          } finally {
            btnSaveOrder.disabled = false;
          }
        });

        // ESC closes preview
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" && previewModal?.style.display === "block") {
            previewModal.style.display = "none";
          }
        });


        // If opened without params, do not try to query Firestore
        if (!params.get("id") && !params.get("slug")) return;

        try {
          showToast("‚è≥ Cargando tema...", "warn", 1200);

          const topic = await loadTopic();
          if (!topic) {
            topicTitle.textContent = "Tema no encontrado";
            topicDesc.textContent = "No se pudo cargar el tema. Verifica el enlace (level/slug/id).";
            pillType.textContent = "‚Äî";
            pillSlug.textContent = "slug: ‚Äî";
            pillCount.textContent = "Ejercicios: ‚Äî";
            emptyExercises.style.display = "block";
            showToast("‚ö†Ô∏è No se encontr√≥ el tema", "warn", 2600);
            return;
          }

          await loadExercises(topic);
          if (isAdmin) {
            exOrder.value = String(getNextOrder());
          }
        } catch (e) {
          console.error(e);
          showToast("‚ùå Error al cargar (mira la consola)", "bad", 3600);
        }
      });

      // ===== Admin actions =====
      btnAutoOrder.onclick = () => {
        exOrder.value = String(getNextOrder());
        showToast("‚ú® Ustawiono order", "ok", 1400);
      };

      btnAddExercise.onclick = async () => {
        if (!isAdmin || !currentTopic) return;

        // reset validation
        [exPrompt, exOptions, exAnswer, exOrder].forEach((el) => markBad(el, false));

        const type = exType.value;
        const prompt = exPrompt.value.trim();
        const notes = exNotes.value.trim();
        const answer = normalizeAnswer(exAnswer.value);
        const order = Number(exOrder.value || 0);

        let ok = true;

        if (!prompt) { markBad(exPrompt, true); ok = false; }
        if (!answer) { markBad(exAnswer, true); ok = false; }
        if (!order || order < 1) { markBad(exOrder, true); ok = false; }

        const options = parseOptions(exOptions.value);
        const needsOptions = (options.length > 0) || type === "Opci√≥n m√∫ltiple" || type === "Verdadero o falso";

        if (needsOptions && options.length < 2) {
          markBad(exOptions, true);
          ok = false;
        }

        if (!ok) {
          showToast("‚ö†Ô∏è Completa los campos marcados.", "warn", 2600);
          return;
        }

        try {
          setSaving(true);
          showToast("‚è≥ Guardando...", "warn", 1200);

          await addDoc(collection(db, "exercises"), {
            level: LEVEL,
            topicSlug: String(currentTopic.slug || currentTopic.id || ""),
            topicId: currentTopic.id || null,
            type,
            prompt,
            options: options.length ? options : [],
            answer,
            notes,
            category: (exCategory?.value || "grammar"),
            tags: toTagsArray(exTags?.value),
            order,
            createdAt: serverTimestamp(),
            updatedAt: serverTimestamp(),
          });

          // reset form
          exPrompt.value = "";
          exOptions.value = "";
          exAnswer.value = "";
          exNotes.value = "";
          if (exTags) exTags.value = "";
          exOrder.value = String(order + 1);

          await loadExercises(currentTopic);
          showToast("‚úÖ Ejercicio guardado", "ok", 2200);
        } catch (e) {
          console.error(e);
          showToast("‚ùå Error al guardar (mira la consola)", "bad", 3600);
        } finally {
          setSaving(false);
        }
      };

      // Enter on answer = save (admin)
      exAnswer.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && isAdmin) btnAddExercise.click();
      });
   

      // ===== state =====
      let ALL_EXERCISES = [];
      let VIEW_EXERCISES = [];
      let IS_ADMIN = false;
      let REORDER_MODE = false;
      let HAS_ORDER_CHANGES = false;
      let DRAG_ID = null;

      function toTagsArray(s) {
        return String(s || "")
          .split(",")
          .map((x) => x.trim())
          .filter(Boolean);
      }

      function setToast(msg, kind = "info") {
        const el = document.getElementById("toast");
        if (!el) return;
        el.textContent = msg;
        el.classList.remove("toast-red", "toast-yellow");
        if (kind === "error") el.classList.add("toast-red");
        if (kind === "ok") el.classList.add("toast-yellow");
        el.style.opacity = "1";
        clearTimeout(window.__toastT);
        window.__toastT = setTimeout(() => (el.style.opacity = "0"), 2500);
      }

      function applyFilters() {
        const q = (filterSearch?.value || "").trim().toLowerCase();
        const t = (filterType?.value || "").trim();
        const c = (filterCategory?.value || "").trim();

        VIEW_EXERCISES = ALL_EXERCISES.filter((ex) => {
          const hay = `${ex.prompt || ""} ${ex.answer || ""} ${(ex.options || []).join(" ")} ${(ex.notes || "")}`.toLowerCase();
          const okQ = !q || hay.includes(q);
          const okT = !t || ex.type === t;
          const okC = !c || (ex.category || "grammar") === c;
          return okQ && okT && okC;
        });

        renderExerciseList();
      }

      function buildTypeFilterOptions() {
        if (!filterType) return;
        const unique = Array.from(new Set(ALL_EXERCISES.map((e) => e.type))).sort();
        filterType.innerHTML =
          `<option value="">Wszystko</option>` +
          unique.map((x) => `<option value="${escapeHtml(x)}">${escapeHtml(x)}</option>`).join("");
      }

      function setReorderMode(on) {
        REORDER_MODE = !!on;
        HAS_ORDER_CHANGES = false;
        if (btnSaveOrder) btnSaveOrder.style.display = (REORDER_MODE && IS_ADMIN) ? "inline-flex" : "none";
        renderExerciseList();
      }

      function openPreview(ex) {
        if (!previewModal) return;
        previewResult.style.display = "none";
        previewResult.textContent = "";
        previewResult.className = "pill";

        const opt = Array.isArray(ex.options) ? ex.options : [];
        const type = ex.type || "open";

        let body = `<div class="card" style="padding:12px; margin:0">
          <div class="smallNote" style="opacity:.9; margin-bottom:8px">Typ: <b>${escapeHtml(type)}</b> ‚Ä¢ Kategoria: <b>${escapeHtml(ex.category || "grammar")}</b></div>
          <div style="font-weight:800; font-size:18px">${escapeHtml(ex.prompt || "")}</div>`;

        if (opt.length) {
          body += `<div style="margin-top:10px; display:grid; gap:8px">` +
            opt.map((o, i) => {
              const letter = String.fromCharCode(65 + i);
              return `<label class="card" style="padding:10px; margin:0; cursor:pointer; display:flex; gap:10px; align-items:flex-start">
                <input type="radio" name="pv" value="${escapeHtml(o)}" style="margin-top:2px" />
                <div><b>${letter})</b> ${escapeHtml(o)}</div>
              </label>`;
            }).join("") + `</div>`;
          body += `<div class="smallNote" style="margin-top:8px; opacity:.9">Wybierz odpowied≈∫ i kliknij ‚ÄûSprawd≈∫‚Äù.</div>`;
        } else {
          body += `<div style="margin-top:10px">
            <input id="pvInput" placeholder="Wpisz odpowied≈∫‚Ä¶" />
          </div>`;
        }

        if (ex.notes) {
          body += `<div class="smallNote" style="margin-top:10px; opacity:.9">Nota: ${escapeHtml(ex.notes)}</div>`;
        }

        body += `</div>`;
        previewBody.innerHTML = body;

        btnCheckPreview.onclick = () => {
          let userAnswer = "";
          const picked = previewBody.querySelector('input[name="pv"]:checked');
          if (picked) userAnswer = picked.value;
          else userAnswer = (document.getElementById("pvInput")?.value || "").trim();

          const correct = normalizeAnswer(ex.answer);
          const given = normalizeAnswer(userAnswer);
          const ok = !!given && given === correct;

          previewResult.style.display = "inline-flex";
          previewResult.classList.toggle("pill-yellow", ok);
          previewResult.classList.toggle("pill-red", !ok);
          previewResult.textContent = ok ? "‚úÖ OK" : `‚ùå Nie. Poprawna: ${ex.answer || ""}`;
        };

        previewBackdrop.onclick = () => (previewModal.style.display = "none");
        btnClosePreview.onclick = () => (previewModal.style.display = "none");
        previewModal.style.display = "block";
      }
 </script>
  </body>
</html>
