<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Curso | AquiVivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    :root{
      --yellow:#fcd116;
      --blue:#003893;
      --red:#ce1126;
    }

    body{
      margin:0;
      font-family: Montserrat, Arial, sans-serif;
      min-height:100vh;
      background: linear-gradient(180deg, #001a4d, #003893, #001a4d);
      color:#fff;
    }

    main.page{ padding: 22px 0 70px; }
    .container{
      max-width: 1180px;
      margin: 0 auto;
      padding: 28px 16px;
    }

    /* Top bar */
    .topActionBar{
      position: sticky;
      top:0;
      z-index:50;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap:14px;
      padding: 14px 18px;
      background: rgba(0,56,147,0.92);
      border-bottom: 1px solid rgba(255,255,255,0.14);
      backdrop-filter: blur(10px);
    }
    .topActionLeft{ display:flex; gap:12px; align-items:center; }
    .btnLogout{
      background: var(--red);
      color:#fff;
      border:none;
      border-radius:999px;
      padding: 12px 22px;
      font-size: 16px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 14px 36px rgba(0,0,0,0.18);
    }
    .btnLogout:hover{ filter: brightness(0.95); transform: translateY(-1px); }

    .btnNav{
      background: rgba(255,255,255,0.15);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.30);
      border-radius:999px;
      padding: 12px 20px;
      font-size: 15px;
      font-weight: 900;
      cursor:pointer;
      backdrop-filter: blur(6px);
      box-shadow: 0 14px 36px rgba(0,0,0,0.12);
    }
    .btnNav:hover{
      background: rgba(255,255,255,0.25);
      transform: translateY(-1px);
    }

    /* Header like "Panel del estudiante" */
    .heroBanner{
      margin: 6px 0 18px;
      padding: 22px 22px;
      border-radius: 22px;
      background: rgba(0, 26, 77, 0.26);
      border: 1px solid rgba(255,255,255,0.16);
      backdrop-filter: blur(10px);
      box-shadow: 0 18px 70px rgba(0,0,0,0.18);
    }
    .heroTitleRow{
      display:flex;
      align-items:center;
      gap:18px;
    }
    .heroIcon{ font-size: 56px; line-height:1; }
    #levelTitle{
      font-family:'Playfair Display', serif !important;
      font-weight: 900 !important;
      font-size: 64px !important;
      line-height: 1.05 !important;
      margin: 0 !important;
      color: #fff !important;
      text-shadow: 0 10px 28px rgba(0,0,0,0.35);
    }
    #levelSubtitle{
      margin: 10px 0 0 0 !important;
      font-size: 18px !important;
      color: rgba(255,255,255,0.90) !important;
      opacity: 1 !important;
    }
    @media (max-width: 720px){
      #levelTitle{ font-size: 44px !important; }
      #levelSubtitle{ font-size: 16px !important; }
      .heroIcon{ font-size: 46px; }
      .heroBanner{ padding: 18px 16px; }
    }

    /* Filters */
    .filtersSection{
      background: rgba(255,255,255,0.10) !important;
      border: 1px solid rgba(255,255,255,0.20) !important;
      backdrop-filter: blur(14px) !important;
      border-radius: 22px !important;
      padding: 18px 18px !important;
      margin: 22px 0 18px !important;
      display:flex !important;
      gap:16px !important;
      flex-wrap:wrap !important;
      align-items:center !important;
      box-shadow: 0 18px 70px rgba(0,0,0,0.18) !important;
    }
    .filterGroup{
      display:flex !important;
      gap:10px !important;
      align-items:center !important;
      min-width: 280px;
    }
    .filterLabel{
      font-size: 14px !important;
      color: rgba(255,255,255,0.92) !important;
      font-weight: 900 !important;
      letter-spacing: 0.2px !important;
      white-space: nowrap !important;
      text-shadow: 0 8px 18px rgba(0,0,0,0.35) !important;
      opacity: 1 !important;
    }

    #searchInput{
      background: rgba(255,255,255,0.14) !important;
      border: 1px solid rgba(255,255,255,0.28) !important;
      border-radius: 14px !important;
      padding: 12px 14px !important;
      color: #fff !important;
      font-size: 14px !important;
      width: 260px !important;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.08);
    }
    #searchInput:focus{
      outline:none !important;
      background: rgba(255,255,255,0.18) !important;
      border-color: rgba(252,209,22,0.55) !important;
      box-shadow: 0 0 0 4px rgba(252,209,22,0.10) !important;
    }
    #searchInput::placeholder{ color: rgba(255,255,255,0.72) !important; }

    #typeFilter, #taskFilter{
      background: rgba(255,255,255,0.14) !important;
      border: 1px solid rgba(255,255,255,0.28) !important;
      border-radius: 14px !important;
      padding: 12px 14px !important;
      color:#fff !important;
      font-size: 14px !important;
      cursor:pointer !important;
      min-width: 220px;
    }
    #typeFilter option, #taskFilter option{
      background: #003893 !important;
      color:#fff !important;
    }

    @media (max-width: 720px){
      .filterGroup{ min-width: 100%; }
      #searchInput{ width: 100% !important; }
      #typeFilter, #taskFilter{ width: 100% !important; }
    }

    /* Course tools */
    .course-tools{ margin: 12px 0 8px; display:grid; gap:12px; }
    .progressCard{
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      backdrop-filter: blur(12px);
      border-radius: 18px;
      padding: 16px;
    }
    .progressTop{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .progressLabel{ font-weight: 900; letter-spacing: 0.2px; }
    .progressText{ opacity: 0.90; font-size: 13px; margin-top: 4px; }
    .progressBar{
      height: 10px;
      border-radius: 999px;
      overflow: hidden;
      background: rgba(255,255,255,0.16);
      margin-top: 10px;
    }
    .progressFill{
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--yellow), var(--red));
      transition: width 0.25s ease;
      width: 0%;
    }
    .progressHint{
      font-size: 12px;
      opacity: 0.75;
      margin-top: 8px;
    }
    .statsRow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .statPill{
      background: rgba(0,0,0,0.15);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      padding: 10px 12px;
      font-size: 13px;
      display:flex;
      gap: 6px;
      align-items:center;
    }
    .statBtn{
      background: rgba(255,255,255,0.12);
      border: 1px solid rgba(255,255,255,0.18);
      color:#fff;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
    }
    .statBtn:hover{ filter: brightness(1.05); transform: translateY(-1px); }

    /* Sections */
    .sectionTitle{
      margin: 26px 0 16px 0;
      font-size: 18px;
      font-weight: 900;
      display:flex;
      align-items:center;
      gap:10px;
      letter-spacing:0.3px;
      color: rgba(255,255,255,0.95) !important;
      text-shadow: 0 10px 26px rgba(0,0,0,0.45);
    }
/* Topic cards */
    .card{
      position: relative;
      background: #ffffff;
      color: #001a4d;
      border-radius: 16px;
      padding: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
      margin: 10px 0;
    }
    .topic{
      position: relative;
      transition: 0.25s ease;
      cursor: pointer;
    }
    .topic:hover{
      transform: translateY(-4px);
      box-shadow: 0 16px 48px rgba(0,0,0,0.28);
    }
    .topic strong{
      display:block;
      margin-bottom: 6px;
      font-size: 18px;
      font-weight: 900;
      color: var(--blue);
      word-break: break-word;
    }
    .topic p{
      margin: 0;
      font-size: 14px;
      color: #445066;
      line-height: 1.5;
      word-break: break-word;
    }
    .topic-head{
      display:flex;
      align-items:flex-start;
      justify-content: space-between;
      gap:10px;
    }
    .topic-title{
      display:flex;
      align-items:center;
      gap:10px;
      min-width: 0;
    }
    .chip{
      font-size: 12px;
      font-weight: 900;
      border-radius: 999px;
      padding: 4px 10px;
      background: rgba(0, 26, 77, 0.08);
      border: 1px solid rgba(0, 26, 77, 0.18);
      color: #001a4d;
      flex: 0 0 auto;
    }
    .chip-muted{ opacity: 0.65; }
    .badge{
      font-size: 12px;
      font-weight: 900;
      border-radius: 999px;
      padding: 6px 10px;
      color: #fff;
      flex: 0 0 auto;
      white-space: nowrap;
    }
    .badge-grammar{ background: rgba(0,56,147,0.92); }
    .badge-vocab{ background: rgba(206,17,38,0.92); }

    /* Admin tools on card */
    .admin-tools{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      gap:6px;
      z-index:2;
    }
    .admin-tools button{
      border:none;
      padding: 6px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-size: 12px;
      font-weight: 900;
    }
    .btn-edit{ background: var(--yellow); color:#111827; }
    .btn-del{ background: var(--red); color:#fff; }

    /* Admin panels */
    .adminBar{ display:none; margin-top: 12px; gap:10px; flex-wrap:wrap; }
    .adminBar button{
      padding: 10px 12px;
      border:none;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 900;
      background: rgba(255,255,255,0.12);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .adminPanel{ display:none; margin-top: 20px; }
    .row{
      display:grid;
      grid-template-columns: 160px 1fr 1fr auto;
      gap:10px;
      align-items:center;
    }
    .row input, .row select{
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #d1d5db;
      width: 100%;
      box-sizing: border-box;
    }
    .row button{
      padding: 10px 14px;
      border:none;
      border-radius: 10px;
      cursor:pointer;
      font-weight: 900;
      background: var(--blue);
      color:#fff;
    }

    .noResults{
      text-align:center;
      padding: 20px;
      opacity: 0.75;
      font-style: italic;
    }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.75);
      color:#fff;
      border: 1px solid rgba(255,255,255,0.18);
      padding: 12px 14px;
      border-radius: 14px;
      max-width: min(720px, calc(100% - 24px));
      box-shadow: 0 18px 44px rgba(0,0,0,0.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.18s ease, transform 0.18s ease;
      z-index: 9999;
      font-weight: 800;
    }
    .toast.show{
      opacity: 1;
      transform: translateX(-50%) translateY(-2px);
    }
  </style>
</head>

<body>
  <div class="topActionBar" id="topActionBar">
    <div class="topActionLeft"></div>

    <div style="display:flex; gap:10px; align-items:center">
      <button class="btnNav" id="btnBack" type="button" onclick="window.location.href='ESPANEL.html'">‚¨ÖÔ∏è ATR√ÅS</button>
      <button class="btnNav" id="btnHome" type="button" onclick="window.location.href='index.html'">üè† INICIO</button>
      <button class="btnLogout" id="btnLogout" type="button">Cerrar sesi√≥n</button>
    </div>
  </div>

  <main class="page">
    <div class="container">

      <div class="heroBanner">
        <div class="heroTitleRow">
          <div class="heroIcon">üéì</div>
          <div style="flex:1">
            <h1 id="levelTitle">Nivel</h1>
            <p id="levelSubtitle">Cargando‚Ä¶</p>

            <!-- ADMIN BUTTONS (hidden for students) -->
            <div class="adminBar" id="adminBar">
              <button type="button" onclick="editCourseMeta()">‚úèÔ∏è Editar descripci√≥n del curso</button>
              <button type="button" onclick="dedupeLevel()">üßπ Eliminar duplicados (nivel actual)</button>
            </div>

            <div class="course-tools" id="courseTools">
              <div class="progressCard">
                <div class="progressTop">
                  <div>
                    <div class="progressLabel">üìà Progreso (local)</div>
                    <div class="progressText">
                      <span id="progressText">0%</span> ¬∑ <span id="progressCount">0/0</span> temas visitados
                    </div>
                  </div>
                  <button class="statBtn" id="btnContinue" style="display:none" type="button">‚ñ∂Ô∏è Continuar</button>
                </div>

                <div class="progressBar" aria-hidden="true">
                  <div class="progressFill" id="progressFill"></div>
                </div>

                <div class="progressHint">
                  Se guarda en tu navegador (localStorage).
                </div>
              </div>

              <div class="statsRow">
                <div class="statPill">üìö Total: <strong id="statTotal">0</strong></div>
                <div class="statPill">üîé Mostrando: <strong id="statShowing">0</strong></div>
                <button class="statBtn" id="btnClearFilters" type="button">üßº Limpiar filtros</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- FILTERS -->
      <div class="filtersSection">
        <div class="filterGroup">
          <span class="filterLabel">üîç Buscar:</span>
          <input id="searchInput" type="text" placeholder="Escribe el nombre del tema..." />
        </div>

        <div class="filterGroup">
          <span class="filterLabel">üìÇ Tipo:</span>
          <select id="typeFilter">
            <option value="">Todos</option>
            <option value="grammar">Gram√°tica</option>
            <option value="vocabulary">Vocabulario</option>
          </select>
        </div>

        <div class="filterGroup">
          <span class="filterLabel">‚úÖ Tarea:</span>
          <select id="taskFilter">
            <option value="">Todas las tareas</option>
            <option value="Rellenar los espacios">Rellenar los espacios</option>
            <option value="Relacionar palabra con imagen">Relacionar palabra con imagen</option>
            <option value="Relacionar palabra con traducci√≥n">Relacionar palabra con traducci√≥n</option>
            <option value="Elegir la palabra correcta">Elegir la palabra correcta</option>
            <option value="Tarjetas interactivas">Tarjetas interactivas</option>
            <option value="Agrupar palabras">Agrupar palabras</option>
            <option value="Verdadero o falso">Verdadero o falso</option>
            <option value="Completar la frase con una imagen">Completar la frase con una imagen</option>
            <option value="Juego de memoria (pares)">Juego de memoria (pares)</option>
            <option value="Opci√≥n m√∫ltiple">Opci√≥n m√∫ltiple</option>
            <option value="Completar la forma correcta">Completar la forma correcta</option>
            <option value="Elegir la forma correcta">Elegir la forma correcta</option>
            <option value="Transformaciones">Transformaciones</option>
            <option value="Relacionar pregunta con respuesta">Relacionar pregunta con respuesta</option>
            <option value="Ordenar palabras para formar una frase">Ordenar palabras para formar una frase</option>
            <option value="Corregir errores">Corregir errores</option>
            <option value="Unir dos partes de la frase">Unir dos partes de la frase</option>
            <option value="Completar con preposici√≥n o terminaci√≥n">Completar con preposici√≥n o terminaci√≥n</option>
            <option value="Opci√≥n √∫nica">Opci√≥n √∫nica</option>
            <option value="Escribir tu propia respuesta">Escribir tu propia respuesta</option>
            <option value="Repetir despu√©s del narrador">Repetir despu√©s del narrador</option>
            <option value="Completar la frase con tu voz">Completar la frase con tu voz</option>
            <option value="Responder a una pregunta">Responder a una pregunta</option>
            <option value="Describir una imagen">Describir una imagen</option>
            <option value="Juego de roles">Juego de roles</option>
            <option value="Mini-mon√≥logo">Mini-mon√≥logo</option>
            <option value="Di√°logo semiabierto">Di√°logo semiabierto</option>
            <option value="Decirlo de otra manera">Decirlo de otra manera</option>
            <option value="Escuchar y elegir la respuesta">Escuchar y elegir la respuesta</option>
            <option value="Escuchar y completar los espacios">Escuchar y completar los espacios</option>
            <option value="Escuchar y marcar verdadero o falso">Escuchar y marcar verdadero o falso</option>
            <option value="Escuchar y relacionar personas">Escuchar y relacionar personas</option>
            <option value="Escuchar y ordenar la secuencia">Escuchar y ordenar la secuencia</option>
            <option value="Dictado con audio">Dictado con audio</option>
            <option value="Escuchar y repetir">Escuchar y repetir</option>
            <option value="Di√°logo interactivo">Di√°logo interactivo</option>
            <option value="Misi√≥n del d√≠a">Misi√≥n del d√≠a</option>
            <option value="Quiz situacional">Quiz situacional</option>
            <option value="Video con preguntas">Video con preguntas</option>
            <option value="Test final del tema">Test final del tema</option>
            <option value="Debate grabado">Debate grabado</option>
            <option value="Contar una historia">Contar una historia</option>
            <option value="Simulaci√≥n de entrevista de trabajo">Simulaci√≥n de entrevista de trabajo</option>
            <option value="Retroalimentaci√≥n por voz">Retroalimentaci√≥n por voz</option>
          </select>
        </div>
      </div>

      <div class="sectionTitle">üìò Gram√°tica</div>
      <div id="grammarList"></div>

      <div class="sectionTitle">üìó Vocabulario</div>
      <div id="vocabList"></div>

      <!-- ADMIN add topic -->
      <div class="card adminPanel" id="adminPanel">
        <h3 style="margin:0 0 10px 0">üëë Panel Admin ‚Äì agregar tema</h3>
        <div class="row">
          <select id="adminType">
            <option value="grammar">gram√°tica</option>
            <option value="vocabulary">vocabulario</option>
          </select>
          <input id="adminTitle" placeholder="T√≠tulo (ES)" />
          <input id="adminDesc" placeholder="Descripci√≥n (ES)" />
          <button type="button" onclick="addTopic()">‚ûï Agregar</button>
        </div>
        <p style="font-size:12px; color:#6b7280; margin:10px 0 0 0">
          Si hiciste clic en importar varias veces ‚Äì usa "Eliminar duplicados". Esto eliminar√° las repeticiones en Firestore.
        </p>
      </div>

    </div>
  </main>

  <div class="toast" id="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
    import { getAuth, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
    import {
      getFirestore, collection, query, where, getDocs, addDoc, deleteDoc, updateDoc,
      doc, getDoc, setDoc
    } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

    const firebaseConfig = {
      apiKey: 'AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM',
      authDomain: 'aquivivo-platform.firebaseapp.com',
      projectId: 'aquivivo-platform',
      storageBucket: 'aquivivo-platform.firebasestorage.app',
      messagingSenderId: '116115622011',
      appId: '1:116115622011:web:33a4a583eba4368071bade',
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = 'aquivivo.pl@gmail.com';
    let isAdmin = false;

    const params = new URLSearchParams(window.location.search);
    const LEVEL = (params.get('level') || 'A1').toUpperCase();

    const levelTitle = document.getElementById('levelTitle');
    const levelSubtitle = document.getElementById('levelSubtitle');
    const grammarList = document.getElementById('grammarList');
    const vocabList = document.getElementById('vocabList');
    const adminPanel = document.getElementById('adminPanel');
    const adminBar = document.getElementById('adminBar');

    const searchInput = document.getElementById('searchInput');
    const typeFilter = document.getElementById('typeFilter');
    const taskFilter = document.getElementById('taskFilter');

    let allTopics = [];

    // --- local progress keys
    const LS_VISITED_KEY = `aquivivo_visited_${LEVEL}`;
    const LS_LAST_KEY = `aquivivo_lastLesson_${LEVEL}`;

    function toast(msg){
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.classList.add('show');
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> el.classList.remove('show'), 2200);
    }

    function getVisitedSet(){
      try{
        const arr = JSON.parse(localStorage.getItem(LS_VISITED_KEY) || '[]');
        return new Set(Array.isArray(arr) ? arr : []);
      }catch{ return new Set(); }
    }
    function setVisitedSet(set){
      try{ localStorage.setItem(LS_VISITED_KEY, JSON.stringify(Array.from(set))); }catch{}
    }

    function escapeHtml(s){
      return String(s || '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }

    function normType(t){
      return String(t || '').toLowerCase().trim();
    }

    function updateStatsAndProgress(showingCount){
      const total = allTopics.length;
      const visited = getVisitedSet();
      const visitedCount = Array.from(visited).filter(id => allTopics.some(t => t.id === id)).length;

      document.getElementById('statTotal').textContent = String(total);
      document.getElementById('statShowing').textContent = String(showingCount);

      const pct = total ? Math.round((visitedCount / total) * 100) : 0;
      document.getElementById('progressText').textContent = `${pct}%`;
      document.getElementById('progressCount').textContent = `${visitedCount}/${total}`;
      document.getElementById('progressFill').style.width = `${pct}%`;

      const last = localStorage.getItem(LS_LAST_KEY);
      const btn = document.getElementById('btnContinue');
      if (last && allTopics.some(t => t.id === last)){
        btn.style.display = 'inline-flex';
        btn.onclick = () => openLesson(last);
      } else {
        btn.style.display = 'none';
      }
    }

    async function loadCourseMeta(){
      const metaRef = doc(db, 'course_meta', LEVEL);
      const metaSnap = await getDoc(metaRef);
      if (metaSnap.exists()){
        const m = metaSnap.data();
        levelTitle.textContent = m.title || `Nivel ${LEVEL}`;
        levelSubtitle.textContent = m.subtitle || '';
      } else {
        levelTitle.textContent = `Nivel ${LEVEL}`;
        levelSubtitle.textContent = '';
      }
    }

    window.editCourseMeta = async function(){
      if (!isAdmin) return;

      const currentTitle = levelTitle.textContent || `Nivel ${LEVEL}`;
      const currentSub = levelSubtitle.textContent || '';

      const newTitle = prompt('Nuevo t√≠tulo del curso (encabezado):', currentTitle);
      if (newTitle === null) return;

      const newSub = prompt('Nueva descripci√≥n del curso (debajo del t√≠tulo):', currentSub);
      if (newSub === null) return;

      const metaRef = doc(db, 'course_meta', LEVEL);
      await setDoc(metaRef, {
        title: newTitle.trim() || `Nivel ${LEVEL}`,
        subtitle: newSub.trim() || ''
      }, { merge: true });

      await loadCourseMeta();
      toast('‚úÖ Descripci√≥n del curso guardada');
    };

    async function loadTopics(){
      grammarList.innerHTML = '';
      vocabList.innerHTML = '';

      const q = query(collection(db, 'courses'), where('level', '==', LEVEL));
      const snap = await getDocs(q);

      allTopics = [];
      snap.forEach((d) => {
        const data = d.data();
        allTopics.push({
          id: d.id,
          title: data.title || '',
          desc: data.desc || '',
          order: Number(data.order ?? 9999),
          type: normType(data.type)
        });
      });

      allTopics.sort((a,b) => {
        if (a.type !== b.type) return a.type === 'grammar' ? -1 : 1;
        return a.order - b.order;
      });

      renderFiltered();
      updateStatsAndProgress(allTopics.length);
    }

    function renderTopicCard(t){
      const adminButtons = isAdmin ? `
        <div class="admin-tools">
          <button class="btn-edit" title="Editar" onclick="event.stopPropagation(); editTopic('${t.id}')">‚úèÔ∏è</button>
          <button class="btn-del" title="Eliminar" onclick="event.stopPropagation(); deleteTopic('${t.id}')">‚ùå</button>
        </div>` : '';

      const badge = t.type === 'grammar'
        ? `<span class="badge badge-grammar">Gram√°tica</span>`
        : `<span class="badge badge-vocab">Vocabulario</span>`;

      const orderChip = Number.isFinite(t.order) && t.order !== 9999
        ? `<span class="chip">#${t.order}</span>`
        : `<span class="chip chip-muted">#‚Äî</span>`;

      return `
        <div class="card topic" role="button" tabindex="0"
          onclick="openLesson('${t.id}')"
          onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault(); openLesson('${t.id}') }">
          ${adminButtons}
          <div class="topic-head">
            <div class="topic-title">
              ${orderChip}
              <strong>${escapeHtml(t.title)}</strong>
            </div>
            ${badge}
          </div>
          <p>${escapeHtml(t.desc)}</p>
        </div>
      `;
    }

    function renderFiltered(){
      const searchTerm = (searchInput.value || '').toLowerCase().trim();
      const selectedType = typeFilter.value;
      const selectedTask = taskFilter.value;

      const grammar = [];
      const vocab = [];

      for (const item of allTopics){
        if (searchTerm){
          const inTitle = item.title.toLowerCase().includes(searchTerm);
          const inDesc = item.desc.toLowerCase().includes(searchTerm);
          if (!inTitle && !inDesc) continue;
        }

        if (selectedType && item.type !== selectedType) continue;

        // task filter: simple "contains" in desc (kept as in your current logic)
        if (selectedTask && !item.desc.toLowerCase().includes(selectedTask.toLowerCase())) continue;

        if (item.type === 'grammar') grammar.push(item);
        if (item.type === 'vocabulary') vocab.push(item);
      }

      grammar.sort((a,b)=>a.order-b.order);
      vocab.sort((a,b)=>a.order-b.order);

      grammarList.innerHTML = grammar.length
        ? grammar.map(renderTopicCard).join('')
        : `<div class="card noResults">No hay resultados en gram√°tica</div>`;

      vocabList.innerHTML = vocab.length
        ? vocab.map(renderTopicCard).join('')
        : `<div class="card noResults">No hay resultados en vocabulario</div>`;

      updateStatsAndProgress(grammar.length + vocab.length);
    }

    window.openLesson = function(id){
      try{
        localStorage.setItem(LS_LAST_KEY, id);
        const visited = getVisitedSet();
        visited.add(id);
        setVisitedSet(visited);
      }catch{}

      const url = `lessonpage.html?level=${encodeURIComponent(LEVEL)}&id=${encodeURIComponent(id)}`;
      window.open(url, '_blank', 'noopener,noreferrer');
    };

    window.addTopic = async function(){
      if (!isAdmin) return;

      const type = document.getElementById('adminType').value;
      const title = document.getElementById('adminTitle').value.trim();
      const desc = document.getElementById('adminDesc').value.trim();

      if (!title || !desc){
        alert('Completa el t√≠tulo y la descripci√≥n');
        return;
      }

      const q = query(collection(db, 'courses'), where('level', '==', LEVEL));
      const snap = await getDocs(q);
      let maxOrder = 0;
      snap.forEach((d)=>{
        const o = Number(d.data().order ?? 0);
        if (o > maxOrder) maxOrder = o;
      });

      await addDoc(collection(db,'courses'), {
        level: LEVEL,
        type,
        title,
        desc,
        order: maxOrder + 1
      });

      document.getElementById('adminTitle').value = '';
      document.getElementById('adminDesc').value = '';

      await loadTopics();
      toast('‚úÖ Tema agregado');
    };

    window.deleteTopic = async function(id){
      if (!isAdmin) return;
      if (!confirm('¬øEliminar este tema?')) return;
      await deleteDoc(doc(db,'courses', id));
      await loadTopics();
    };

    window.editTopic = async function(id){
      if (!isAdmin) return;

      const ref = doc(db,'courses', id);
      const snap = await getDoc(ref);
      if (!snap.exists()){
        alert('Tema no encontrado');
        return;
      }

      const cur = snap.data();
      const newTitle = prompt('Nuevo t√≠tulo:', cur.title || '');
      if (newTitle === null) return;
      const newDesc = prompt('Nueva descripci√≥n:', cur.desc || '');
      if (newDesc === null) return;

      const t = newTitle.trim();
      const d = newDesc.trim();
      if (!t || !d){
        alert('El t√≠tulo y la descripci√≥n no pueden estar vac√≠os');
        return;
      }

      await updateDoc(ref, { title: t, desc: d });
      await loadTopics();
    };

    window.dedupeLevel = async function(){
      if (!isAdmin) return;
      if (!confirm('¬øEliminar temas duplicados para el nivel ' + LEVEL + '?')) return;

      const q = query(collection(db,'courses'), where('level','==', LEVEL));
      const snap = await getDocs(q);

      const seen = new Map();
      const toDelete = [];

      snap.forEach((d)=>{
        const data = d.data();
        const key = [
          (data.level || '').toString().toUpperCase(),
          normType(data.type),
          (data.title || '').trim(),
          (data.desc || '').trim()
        ].join('||');

        if (!seen.has(key)) seen.set(key, d.id);
        else toDelete.push(d.id);
      });

      for (const id of toDelete){
        await deleteDoc(doc(db,'courses', id));
      }

      toast(`‚úÖ Duplicados eliminados: ${toDelete.length}`);
      await loadTopics();
    };

    // auth + init
    onAuthStateChanged(auth, async (user)=>{
      if (!user){
        window.location.href = 'login.html';
        return;
      }

      isAdmin = user.email === ADMIN_EMAIL;

      // show/hide admin UI
      adminPanel.style.display = isAdmin ? 'block' : 'none';
      adminBar.style.display = isAdmin ? 'flex' : 'none';

      // header
      await loadCourseMeta();
      await loadTopics();
    });

    // logout
    document.getElementById('btnLogout').addEventListener('click', async ()=>{
      try{ await signOut(auth); }catch{}
      window.location.href = 'login.html';
    });

    // filters events
    searchInput.addEventListener('input', renderFiltered);
    typeFilter.addEventListener('change', renderFiltered);
    taskFilter.addEventListener('change', renderFiltered);

    // clear filters
    document.getElementById('btnClearFilters').addEventListener('click', ()=>{
      searchInput.value = '';
      typeFilter.value = '';
      taskFilter.value = '';
      renderFiltered();
      toast('üßº Filtros limpiados');
    });

    // shortcuts
    window.addEventListener('keydown', (e)=>{
      if (e.key === '/' && document.activeElement !== searchInput){
        e.preventDefault();
        searchInput.focus();
      }
      if (e.key === 'Escape' && document.activeElement === searchInput){
        searchInput.value = '';
        renderFiltered();
      }
    });
  </script>
</body>
</html>
