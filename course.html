<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Kurs | AquiVivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">
  <!-- ‚úÖ kurs jest w /kursy, wiƒôc wracamy poziom wy≈ºej -->
  <link rel="stylesheet" href="assets/css/styles.css" />

  <style>
    .course-grid{ display:grid; grid-template-columns: 1.2fr .8fr; gap:16px; margin-bottom:16px; }
    @media (max-width: 980px){ .course-grid{ grid-template-columns: 1fr; } }

    .filters{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:14px; }
    .filters .chip{ border:none; border-radius: 999px; padding: 8px 12px; font-weight: 900; cursor:pointer; }
    .chip.secondary{ background: rgba(255,255,255,.12); border: 1px solid rgba(255,255,255,.20); color:white; }
    .chip.active{ background: rgba(252,209,22,.92); color:#111827; }

    .listWrap{ display:grid; gap:14px; margin-top:14px; }
    .topicCard{ display:flex; flex-direction:column; gap:8px; }
    .topicTop{ display:flex; align-items:flex-start; justify-content:space-between; gap:10px; }
    .topicTitle{ font-weight: 900; font-size: 16px; }
    .topicDesc{ margin:0; font-size: 13px; color:#6b7280; line-height:1.35; }
    .topicMeta{ display:flex; flex-wrap:wrap; gap:8px; align-items:center; }

    .pill{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; font-weight:900; font-size:12px; }
    .pill-done{ background: rgba(34,197,94,.14); color:#065f46; border: 1px solid rgba(34,197,94,.25); }
    .pill-type{ background: rgba(56,189,248,.12); color:#075985; border: 1px solid rgba(56,189,248,.18); }

    .adminBar{ display:none; margin-top: 12px; }
    .adminBar.show{ display:block; }

    .adminBox{ background: rgba(255,255,255,.10); color:white; border: 1px solid rgba(255,255,255,.18); backdrop-filter: blur(12px); border-radius: 18px; padding: 14px; }
    .adminBox .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 860px){ .adminBox .row{ grid-template-columns: 1fr; } }
    .adminBox label{ font-size:12px; font-weight:900; opacity:.9; }
    .adminBox input, .adminBox select, .adminBox textarea{
      width:100%; padding:10px 12px; border-radius: 12px; border:1px solid rgba(255,255,255,.20);
      background: rgba(2,6,23,.65); color:white;
    }
    .adminBox textarea{ min-height: 80px; resize: vertical; }

    .sectionTitleSmall{ margin-top: 10px; font-weight: 900; opacity:.95; }
    .mutedWhite{ color: rgba(255,255,255,.82); font-size: 13px; line-height:1.35; }
  </style>
</head>

<body>

  <header class="nav-glass">
    <div class="container nav-inner">
      <div class="brand">
        <div class="logo-flag" aria-hidden="true"></div>
        <div class="name">Aqui vivo</div>
      </div>

      <div class="nav-actions">
        <a class="btn-white-outline" href="panel.html">Panel</a>
        <button class="btn-red" id="logoutBtn" type="button">Wyloguj</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="container">

      <section class="course-grid">
        <div class="hero-card">
          <h1 class="hero-title glow-text" id="courseTitle">Kurs</h1>
          <p class="hero-subtitle" id="courseSubtitle">≈Åadowanie‚Ä¶</p>

          <div class="filters">
            <button class="chip active" id="btnAll" type="button">Wszystko</button>
            <button class="chip secondary" id="btnGrammar" type="button">Gramatyka</button>
            <button class="chip secondary" id="btnVocab" type="button">S≈Çownictwo</button>

            <div style="flex:1 1 220px;"></div>

            <input id="searchInput" placeholder="Szukaj‚Ä¶" style="max-width:260px; padding:10px 12px; border-radius:14px; border:1px solid rgba(255,255,255,.18); background: rgba(2,6,23,.55); color:white; font-weight:800;">
            <select id="taskSelect" style="max-width:220px;">
              <option value="">Wszystkie typy</option>
              <option value="flashcards">Fiszki</option>
              <option value="audio">Audio</option>
              <option value="quiz">Quiz</option>
              <option value="pdf">PDF</option>
              <option value="other">Inne</option>
            </select>
          </div>

          <div class="adminBar" id="adminBar">
            <div class="adminBox">
              <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
                <div style="font-weight:900;">‚öôÔ∏è Admin narzƒôdzia</div>
                <a class="btn-white-outline" href="admin.html" style="text-decoration:none;">ZarzƒÖdzaj dostƒôpami</a>
              </div>

              <div class="sectionTitleSmall">Meta kursu</div>
              <p class="mutedWhite" style="margin-top:6px;">Tytu≈Ç i opis sƒÖ trzymane w Firestore: <code>course_meta/{LEVEL}</code>.</p>
              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <button class="btn-yellow" id="editMetaBtn" type="button">Edytuj tytu≈Ç/opis</button>
              </div>

              <div class="sectionTitleSmall" style="margin-top:14px;">Dodaj temat</div>
              <div class="row" style="margin-top:8px;">
                <div>
                  <label>Tytu≈Ç</label>
                  <input id="newTitle" placeholder="Np. Czas przesz≈Çy (byƒá/mieƒá)">
                </div>
                <div>
                  <label>Typ</label>
                  <select id="newType">
                    <option value="grammar">grammar</option>
                    <option value="vocabulary">vocabulary</option>
                  </select>
                </div>
                <div>
                  <label>Opis</label>
                  <input id="newDesc" placeholder="Kr√≥tki opis‚Ä¶">
                </div>
                <div>
                  <label>Order (liczba)</label>
                  <input id="newOrder" placeholder="np. 10">
                </div>
                <div>
                  <label>TaskType</label>
                  <select id="newTaskType">
                    <option value="flashcards">flashcards</option>
                    <option value="audio">audio</option>
                    <option value="quiz">quiz</option>
                    <option value="pdf">pdf</option>
                    <option value="other">other</option>
                  </select>
                </div>
              </div>

              <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;">
                <button class="btn-yellow" id="addTopicBtn" type="button">‚ûï Dodaj</button>
                <button class="btn-white-outline" id="dedupeBtn" type="button">üßπ Usu≈Ñ duplikaty (level)</button>
              </div>

              <p class="mutedWhite" style="margin:10px 0 0;">‚ö†Ô∏è CRUD dzia≈Ça na kolekcji <code>courses</code>. Dokumenty majƒÖ pola: <code>level, type, title, desc, order, taskType</code>.</p>
            </div>
          </div>

        </div>

        <div class="stats">
          <div class="stat"><div class="big">üÉè</div><div class="label">Fiszki</div></div>
          <div class="stat"><div class="big">üéß</div><div class="label">Audio</div></div>
          <div class="stat"><div class="big">‚úÖ</div><div class="label">Postƒôp</div></div>
        </div>
      </section>

      <div class="sectionTitle">üìö Tematy</div>
      <div class="listWrap" id="topicsList"></div>

    </div>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  query,
  where,
  orderBy,
  getDocs,
  doc,
  getDoc,
  setDoc,
  updateDoc,
  deleteDoc
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM",
  authDomain: "aquivivo-platform.firebaseapp.com",
  projectId: "aquivivo-platform",
  storageBucket: "aquivivo-platform.firebasestorage.app",
  messagingSenderId: "116115622011",
  appId: "1:116115622011:web:33a4a583eba4368071bade"
};

const ADMIN_EMAIL = "aquivivo.pl@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---- UI
const courseTitleEl = document.getElementById("courseTitle");
const courseSubtitleEl = document.getElementById("courseSubtitle");
const topicsListEl = document.getElementById("topicsList");

const btnAll = document.getElementById("btnAll");
const btnGrammar = document.getElementById("btnGrammar");
const btnVocab = document.getElementById("btnVocab");
const searchInput = document.getElementById("searchInput");
const taskSelect = document.getElementById("taskSelect");

const adminBar = document.getElementById("adminBar");
const logoutBtn = document.getElementById("logoutBtn");

// Admin form
const editMetaBtn = document.getElementById("editMetaBtn");
const addTopicBtn = document.getElementById("addTopicBtn");
const dedupeBtn = document.getElementById("dedupeBtn");

const newTitle = document.getElementById("newTitle");
const newType = document.getElementById("newType");
const newDesc = document.getElementById("newDesc");
const newOrder = document.getElementById("newOrder");
const newTaskType = document.getElementById("newTaskType");

// ---- State
const params = new URLSearchParams(window.location.search);
const LEVEL = (params.get("level") || "A1").toUpperCase();

let isAdmin = false;
let allTopics = [];
let filterKind = "all";

// ---- Progress (bez zewnƒôtrznych plik√≥w; trzymamy w localStorage)
const Progress = {
  key(level){ return `aqv_progress_${level}`; },
  load(level){
    try { return JSON.parse(localStorage.getItem(this.key(level)) || "{}"); }
    catch { return {}; }
  },
  save(level, data){ localStorage.setItem(this.key(level), JSON.stringify(data||{})); },
  isDone(level, topicId){
    const data = this.load(level);
    return !!data[topicId];
  },
  toggleDone(level, topicId, title){
    const data = this.load(level);
    if (data[topicId]) delete data[topicId];
    else data[topicId] = { title: title || "", at: new Date().toISOString() };
    this.save(level, data);
  }
};

function esc(s){
  return String(s||"")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function setActiveChip(kind){
  filterKind = kind;
  const map = { all: btnAll, grammar: btnGrammar, vocabulary: btnVocab };
  [btnAll, btnGrammar, btnVocab].forEach(b => { b.classList.remove("active"); b.classList.add("secondary"); });
  map[kind].classList.add("active");
  map[kind].classList.remove("secondary");
}

function prettyLevel(lvl){ return `Polski ${lvl}`; }

async function loadCourseMeta(){
  // course_meta/{LEVEL}: { title, subtitle }
  const ref = doc(db, "course_meta", LEVEL);
  const snap = await getDoc(ref);

  const fallbackTitle = prettyLevel(LEVEL);
  const fallbackSubtitle = "Wybierz temat i ucz siƒô krok po kroku.";

  if (!snap.exists()){
    courseTitleEl.textContent = fallbackTitle;
    courseSubtitleEl.textContent = fallbackSubtitle;
    return;
  }

  const data = snap.data() || {};
  courseTitleEl.textContent = data.title || fallbackTitle;
  courseSubtitleEl.textContent = data.subtitle || fallbackSubtitle;
}

async function editCourseMeta(){
  const currentTitle = courseTitleEl.textContent || "";
  const currentSubtitle = courseSubtitleEl.textContent || "";

  const title = prompt(`Tytu≈Ç kursu (${LEVEL})`, currentTitle);
  if (title === null) return;

  const subtitle = prompt(`Opis kursu (${LEVEL})`, currentSubtitle);
  if (subtitle === null) return;

  const ref = doc(db, "course_meta", LEVEL);
  await setDoc(ref, { title: String(title), subtitle: String(subtitle) }, { merge: true });
  await loadCourseMeta();
  alert("‚úÖ Zapisano meta kursu");
}

async function loadTopicsFromFirestore(){
  // courses: { level, type, title, desc, order, taskType }
  const q = query(
    collection(db, "courses"),
    where("level", "==", LEVEL),
    orderBy("order", "asc")
  );

  const snap = await getDocs(q);
  const out = [];
  snap.forEach(d => {
    const x = d.data() || {};
    out.push({
      id: d.id,
      level: x.level,
      type: x.type || "grammar",
      title: x.title || "(bez tytu≈Çu)",
      desc: x.desc || "",
      order: Number.isFinite(Number(x.order)) ? Number(x.order) : 0,
      taskType: x.taskType || "other"
    });
  });

  allTopics = out;
}

function applyFilters(){
  const q = (searchInput.value || "").toLowerCase().trim();
  const task = (taskSelect.value || "").trim();

  let filtered = [...allTopics];

  if (filterKind !== "all"){
    filtered = filtered.filter(t => t.type === filterKind);
  }

  if (task){
    filtered = filtered.filter(t => (t.taskType || "") === task);
  }

  if (q){
    filtered = filtered.filter(t =>
      (t.title || "").toLowerCase().includes(q) ||
      (t.desc || "").toLowerCase().includes(q)
    );
  }

  renderTopics(filtered);
}

function renderTopics(list){
  if (!list.length){
    topicsListEl.innerHTML = `<div class="card"><b>Brak wynik√≥w.</b></div>`;
    return;
  }

  topicsListEl.innerHTML = list.map(renderTopicCard).join("");
}

function renderTopicCard(t){
  const done = Progress.isDone(LEVEL, t.id);

  const donePill = done ? `<span class="pill pill-done">‚úÖ zrobione</span>` : "";
  const typePill = `<span class="pill pill-type">${esc(t.type)} ¬∑ ${esc(t.taskType || "other")}</span>`;

  const adminBtns = isAdmin ? `
    <div style="display:flex; gap:8px; flex-wrap:wrap;">
      <button class="btn-white-outline" type="button" onclick="editTopic('${esc(t.id)}')">‚úèÔ∏è Edytuj</button>
      <button class="btn-red" type="button" onclick="deleteTopicUI('${esc(t.id)}')">‚ùå Usu≈Ñ</button>
    </div>
  ` : "";

  return `
    <div class="card topicCard">
      <div class="topicTop">
        <div>
          <div class="topicTitle">${esc(t.title)}</div>
          ${t.desc ? `<p class="topicDesc">${esc(t.desc)}</p>` : ``}
          <div class="topicMeta" style="margin-top:8px;">
            ${typePill}
            ${donePill}
          </div>
        </div>

        <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
          <button class="btn-yellow" type="button" onclick="openLesson('${esc(t.id)}','${esc(t.title)}')">Otw√≥rz ‚Üí</button>
          <button class="btn-white-outline" type="button" onclick="toggleDone('${esc(t.id)}','${esc(t.title)}')">${done ? "Cofnij ‚úÖ" : "Zrobione ‚úÖ"}</button>
          ${adminBtns}
        </div>
      </div>
    </div>
  `;
}

// ---- Actions
window.openLesson = function(topicId, title){
  // Tu zostawiamy miejsce na TwojƒÖ docelowƒÖ lekcjƒô (np. lesson.html?id=...)
  // Na razie: zapis ostatnio otwartego tematu i info w alert (≈ºeby nic nie "zniknƒô≈Ço").
  localStorage.setItem("aqv_last_open", JSON.stringify({ level: LEVEL, topicId, title, at: new Date().toISOString() }));
  alert(`üìå Otwieranie: ${title}\n\n(Je≈õli masz osobnƒÖ stronƒô lekcji, podepnƒô to pod prawdziwy link.)`);
};

window.toggleDone = function(topicId, title){
  Progress.toggleDone(LEVEL, topicId, title);
  applyFilters();
};

async function addTopic(){
  const title = (newTitle.value || "").trim();
  const type = (newType.value || "grammar").trim();
  const desc = (newDesc.value || "").trim();
  const order = Number((newOrder.value || "").trim() || "0");
  const taskType = (newTaskType.value || "other").trim();

  if(!title){
    alert("Wpisz tytu≈Ç.");
    return;
  }

  // Tworzymy nowy dokument z automatycznym ID:
  const ref = doc(collection(db, "courses"));
  await setDoc(ref, {
    level: LEVEL,
    type,
    title,
    desc,
    order: Number.isFinite(order) ? order : 0,
    taskType
  });

  newTitle.value = "";
  newDesc.value = "";
  newOrder.value = "";

  await loadTopicsFromFirestore();
  applyFilters();
  alert("‚úÖ Dodano temat");
}

window.editTopic = async function(id){
  const ref = doc(db, "courses", id);
  const snap = await getDoc(ref);
  if(!snap.exists()){
    alert("Nie znaleziono tematu.");
    return;
  }
  const t = snap.data() || {};

  const title = prompt("Tytu≈Ç", t.title || "");
  if(title === null) return;

  const desc = prompt("Opis", t.desc || "");
  if(desc === null) return;

  const type = prompt("Typ (grammar / vocabulary)", t.type || "grammar");
  if(type === null) return;

  const taskType = prompt("TaskType (flashcards/audio/quiz/pdf/other)", t.taskType || "other");
  if(taskType === null) return;

  const order = prompt("Order (liczba)", String(t.order ?? 0));
  if(order === null) return;

  await updateDoc(ref, {
    title: String(title),
    desc: String(desc),
    type: String(type),
    taskType: String(taskType),
    order: Number(order) || 0
  });

  await loadTopicsFromFirestore();
  applyFilters();
  alert("‚úÖ Zapisano zmiany");
};

window.deleteTopicUI = async function(id){
  if(!confirm("UsunƒÖƒá temat?")) return;
  await deleteDoc(doc(db, "courses", id));
  await loadTopicsFromFirestore();
  applyFilters();
  alert("‚úÖ Usuniƒôto");
};

async function dedupeLevel(){
  // usuwa duplikaty w level po kluczu: type|title|taskType
  const qAll = query(collection(db, "courses"), where("level", "==", LEVEL));
  const snap = await getDocs(qAll);

  const seen = new Set();
  const toDelete = [];

  snap.forEach(d => {
    const x = d.data() || {};
    const key = `${(x.type||"").trim()}|${(x.title||"").trim().toLowerCase()}|${(x.taskType||"").trim()}`;
    if(seen.has(key)) toDelete.push(d.id);
    else seen.add(key);
  });

  if(!toDelete.length){
    alert("Brak duplikat√≥w ‚úÖ");
    return;
  }

  if(!confirm(`Znaleziono ${toDelete.length} duplikat√≥w. UsunƒÖƒá?`)) return;
  for(const id of toDelete){
    await deleteDoc(doc(db, "courses", id));
  }
  await loadTopicsFromFirestore();
  applyFilters();
  alert(`‚úÖ Usuniƒôto duplikaty: ${toDelete.length}`);
}

// ---- Events
btnAll.addEventListener("click", () => { setActiveChip("all"); applyFilters(); });
btnGrammar.addEventListener("click", () => { setActiveChip("grammar"); applyFilters(); });
btnVocab.addEventListener("click", () => { setActiveChip("vocabulary"); applyFilters(); });

searchInput.addEventListener("input", applyFilters);
taskSelect.addEventListener("change", applyFilters);

logoutBtn.addEventListener("click", () => {
  signOut(auth).then(() => window.location.href = "login.html");
});

editMetaBtn.addEventListener("click", editCourseMeta);
addTopicBtn.addEventListener("click", addTopic);
dedupeBtn.addEventListener("click", dedupeLevel);

// ---- Auth gate + access check (zgodne z adminem: users.access.{LEVEL}.freeUntil)
function parseIso(s){
  if(!s) return null;
  const d = new Date(s);
  return isNaN(d.getTime()) ? null : d;
}
function hasActiveAccess(userData, level){
  const exp = parseIso(userData?.access?.[level]?.freeUntil);
  if(!exp) return false;
  return exp > new Date();
}

onAuthStateChanged(auth, async (user) => {
  if(!user){
    window.location.href = "login.html";
    return;
  }

  isAdmin = ((user.email||"").toLowerCase() === ADMIN_EMAIL.toLowerCase());
  if(isAdmin) adminBar.classList.add("show");

  // Access gate:
  const uref = doc(db, "users", user.uid);
  const usnap = await getDoc(uref);
  const udata = usnap.exists() ? usnap.data() : null;

  // je≈õli nie ma doca users -> cofamy do panelu (tam tworzy trial)
  if(!udata){
    window.location.href = "panel.html";
    return;
  }

  if(!hasActiveAccess(udata, LEVEL) && !isAdmin){
    alert("üîí Brak dostƒôpu do tego poziomu. Wr√≥cisz do panelu.");
    window.location.href = "panel.html";
    return;
  }

  await loadCourseMeta();
  await loadTopicsFromFirestore();
  setActiveChip("all");
  applyFilters();
});
</script>

</body>
</html>
