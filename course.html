<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <title>Kurs | AquiVivo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap" rel="stylesheet">

  <style>
    :root { --yellow:#FCD116; --blue:#003893; --red:#CE1126; }

    body{
      margin:0;
      font-family: Montserrat, Arial, sans-serif;
      min-height:100vh;
      background:linear-gradient(180deg,#001a4d,#003893,#001a4d);
      color:white;
    }

    .wrap{ max-width: 980px; margin: 0 auto; padding: 36px 16px; }

    .titleRow{ display:flex; align-items:flex-start; gap:14px; }
    h1{
      color: var(--yellow);
      font-family: "Playfair Display", serif;
      font-size: 46px;
      margin: 0;
      line-height: 1.05;
    }

    .subtitle{ opacity:.85; margin: 6px 0 0 0; }

    .sectionTitle{ margin: 26px 0 10px 0; font-size: 18px; }

    .card{
      background:white;
      color: var(--blue);
      border-radius: 14px;
      padding: 14px 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.2);
      margin: 10px 0;
    }

    .topic{
      position: relative;
      transition: .2s;
      cursor: pointer;
    }
    .topic:hover{
      transform: translateY(-3px);
      box-shadow: 0 14px 40px rgba(0,0,0,.25);
    }

    .topic strong{ display:block; margin-bottom:4px; font-size: 18px; }
    .topic p{ margin:0; font-size: 13px; color: #4b5563; }

    .admin-tools{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      gap:6px;
    }
    .admin-tools button{
      border:none;
      padding:6px 10px;
      border-radius:8px;
      cursor:pointer;
      font-size:12px;
      font-weight:700;
    }
    .btn-edit{ background: var(--yellow); color:#111827; }
    .btn-del{ background: var(--red); color:white; }

    .topbar{
      position: fixed;
      top: 14px;
      right: 14px;
      display:flex;
      gap:10px;
      z-index: 50;
    }
    .topbar button{
      padding: 8px 12px;
      border:none;
      border-radius: 10px;
      cursor:pointer;
      font-weight:700;
      background: var(--red);
      color:white;
    }

    .backlink{ color: white; opacity:.9; text-decoration: underline; display:inline-block; margin-bottom: 14px; }

    .adminPanel{ display:none; margin-top: 20px; }
    .row{
      display:grid;
      grid-template-columns: 160px 1fr 1fr auto;
      gap:10px;
      align-items:center;
    }
    .row input, .row select{
      padding:10px;
      border-radius:10px;
      border: 1px solid #d1d5db;
      width: 100%;
      box-sizing: border-box;
    }
    .row button{
      padding:10px 14px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      background: var(--blue);
      color:white;
    }

    .adminBar{
      display:none;
      margin-top: 14px;
      gap:10px;
      flex-wrap: wrap;
    }
    .adminBar button{
      padding:10px 12px;
      border:none;
      border-radius:10px;
      cursor:pointer;
      font-weight:800;
      background: rgba(255,255,255,.12);
      color: white;
      border: 1px solid rgba(255,255,255,.18);
    }
    .adminBar button:hover{ opacity:.9; }
  </style>
</head>

<body>
  <div class="topbar">
    <button onclick="logout()">Wyloguj</button>
  </div>

  <div class="wrap">
    <a class="backlink" href="panel.html">‚Üê Wr√≥ƒá do panelu</a>

    <div class="titleRow">
      <div style="font-size:44px; line-height:1;">üìò</div>
      <div style="flex:1;">
        <h1 id="levelTitle">Poziom</h1>
        <p class="subtitle" id="levelSubtitle">≈Åadowanie‚Ä¶</p>

        <!-- ADMIN BUTTONS (ukryte dla uczni√≥w) -->
        <div id="adminBar" class="adminBar">
          <button onclick="editCourseMeta()">‚úèÔ∏è Edytuj opis kursu</button>
          <button onclick="dedupeLevel()">üßπ Usu≈Ñ duplikaty (A1)</button>
        </div>
      </div>
    </div>

    <div class="sectionTitle">üìò Gramatyka</div>
    <div id="grammarList"></div>

    <div class="sectionTitle">üìó S≈Çownictwo</div>
    <div id="vocabList"></div>

    <!-- ADMIN (dodawanie tematu) -->
    <div id="adminPanel" class="card adminPanel">
      <h3 style="margin:0 0 10px 0;">üëë Panel Admin ‚Äì dodaj temat</h3>

      <div class="row">
        <select id="adminType">
          <option value="grammar">gramatyka</option>
          <option value="vocabulary">s≈Çownictwo</option>
        </select>

        <input id="adminTitle" placeholder="Tytu≈Ç (ES)" />
        <input id="adminDesc" placeholder="Opis (ES)" />

        <button onclick="addTopic()">‚ûï Dodaj</button>
      </div>

      <p style="font-size:12px; color:#6b7280; margin:10px 0 0 0;">
        Je≈õli kliknƒô≈Ça≈õ import kilka razy ‚Äì u≈ºyj ‚ÄûUsu≈Ñ duplikaty‚Äù. To usunie powt√≥rki z Firestore.
      </p>
    </div>
  </div>

  <!-- üî• Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs,
      addDoc, deleteDoc, updateDoc, doc, getDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

    // ‚úÖ Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM",
      authDomain: "aquivivo-platform.firebaseapp.com",
      projectId: "aquivivo-platform",
      storageBucket: "aquivivo-platform.firebasestorage.app",
      messagingSenderId: "116115622011",
      appId: "1:116115622011:web:33a4a583eba4368071bade"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // üëë admin mail
    const ADMIN_EMAIL = "aquivivo.pl@gmail.com";
    let isAdmin = false;

    // level from URL: course.html?level=A1
    const params = new URLSearchParams(window.location.search);
    const LEVEL = (params.get("level") || "A1").toUpperCase();

    // UI refs
    const levelTitle = document.getElementById("levelTitle");
    const levelSubtitle = document.getElementById("levelSubtitle");
    const grammarList = document.getElementById("grammarList");
    const vocabList = document.getElementById("vocabList");
    const adminPanel = document.getElementById("adminPanel");
    const adminBar = document.getElementById("adminBar");

    levelTitle.textContent = `Poziom ${LEVEL}`;
    levelSubtitle.textContent = "≈Åadowanie‚Ä¶";

    // üîê Auth
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      isAdmin = (user.email === ADMIN_EMAIL);

      if (isAdmin) {
        adminPanel.style.display = "block";
        adminBar.style.display = "flex";
      } else {
        adminPanel.style.display = "none";
        adminBar.style.display = "none";
      }

      await loadCourseMeta();
      await loadTopics();
    });

    // üö™ logout
    window.logout = function () {
      signOut(auth).then(() => window.location.href = "login.html");
    };

    // --- helpers
    function normType(t) {
      return String(t || "").toLowerCase().trim();
    }

    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    // ‚úÖ 1) course meta: course_meta/A1 (title + subtitle)
    async function loadCourseMeta(){
      const metaRef = doc(db, "course_meta", LEVEL);
      const metaSnap = await getDoc(metaRef);

      if (metaSnap.exists()){
        const m = metaSnap.data();
        levelTitle.textContent = m.title || `Poziom ${LEVEL}`;
        levelSubtitle.textContent = m.subtitle || "Gotowe ‚úÖ";
      } else {
        // default if no meta yet
        levelTitle.textContent = `Poziom ${LEVEL}`;
        levelSubtitle.textContent = "Gotowe ‚úÖ";
      }
    }

    // Admin: edit meta
    window.editCourseMeta = async function(){
      if(!isAdmin) return;

      const currentTitle = levelTitle.textContent;
      const currentSub = levelSubtitle.textContent;

      const newTitle = prompt("Nowy tytu≈Ç kursu (nag≈Ç√≥wek):", currentTitle);
      if(newTitle === null) return;

      const newSub = prompt("Nowy opis kursu (pod tytu≈Çem):", currentSub);
      if(newSub === null) return;

      const metaRef = doc(db, "course_meta", LEVEL);
      await setDoc(metaRef, {
        title: newTitle.trim() || `Poziom ${LEVEL}`,
        subtitle: newSub.trim() || ""
      }, { merge: true });

      await loadCourseMeta();
      alert("‚úÖ Opis kursu zapisany");
    };

    // ‚úÖ 2) load topics from courses where level==LEVEL
    async function loadTopics() {
      grammarList.innerHTML = "";
      vocabList.innerHTML = "";

      const q = query(collection(db, "courses"), where("level", "==", LEVEL));
      const snap = await getDocs(q);

      const grammar = [];
      const vocab = [];

      snap.forEach((d) => {
        const data = d.data();
        const t = normType(data.type);

        const item = {
          id: d.id,
          title: data.title || "",
          desc: data.desc || "",
          order: Number(data.order ?? 9999),
          type: t
        };

        if (t === "grammar") grammar.push(item);
        if (t === "vocabulary") vocab.push(item);
      });

      grammar.sort((a,b) => a.order - b.order);
      vocab.sort((a,b) => a.order - b.order);

      grammarList.innerHTML = grammar.length
        ? grammar.map(renderTopicCard).join("")
        : `<div class="card">Brak temat√≥w gramatyki (jeszcze üòä)</div>`;

      vocabList.innerHTML = vocab.length
        ? vocab.map(renderTopicCard).join("")
        : `<div class="card">Brak temat√≥w s≈Çownictwa (jeszcze üòä)</div>`;

      if (levelSubtitle.textContent.toLowerCase().includes("≈Çadowanie")) {
        levelSubtitle.textContent = "Gotowe ‚úÖ";
      }
    }

    function renderTopicCard(t) {
      const adminButtons = isAdmin
        ? `<div class="admin-tools">
             <button class="btn-edit" onclick="event.stopPropagation(); editTopic('${t.id}')">‚úèÔ∏è</button>
             <button class="btn-del" onclick="event.stopPropagation(); deleteTopic('${t.id}')">‚ùå</button>
           </div>`
        : "";

      return `
        <div class="card topic" onclick="openLesson('${t.id}')">
          ${adminButtons}
          <strong>${escapeHtml(t.title)}</strong>
          <p>${escapeHtml(t.desc)}</p>
        </div>
      `;
    }

    // üîú next step: lesson.html?id=...
    window.openLesson = function(id){
      alert("Nastƒôpny etap: lesson.html?id=" + id);
    };

    // ‚úÖ Admin add topic
    window.addTopic = async function(){
      if(!isAdmin) return;

      const type = document.getElementById("adminType").value; // grammar/vocabulary
      const title = document.getElementById("adminTitle").value.trim();
      const desc  = document.getElementById("adminDesc").value.trim();

      if(!title || !desc) return alert("Uzupe≈Çnij tytu≈Ç i opis");

      // find max order in this level to append at end
      const q = query(collection(db, "courses"), where("level", "==", LEVEL));
      const snap = await getDocs(q);
      let maxOrder = 0;
      snap.forEach(d => {
        const o = Number(d.data().order ?? 0);
        if(o > maxOrder) maxOrder = o;
      });

      await addDoc(collection(db,"courses"),{
        level: LEVEL,
        type, // IMPORTANT: lowercase
        title,
        desc,
        order: maxOrder + 1
      });

      document.getElementById("adminTitle").value = "";
      document.getElementById("adminDesc").value = "";

      await loadTopics();
      alert("‚úÖ Dodano temat");
    };

    window.deleteTopic = async function(id){
      if(!isAdmin) return;
      if(!confirm("UsunƒÖƒá ten temat?")) return;

      await deleteDoc(doc(db,"courses",id));
      await loadTopics();
    };

    window.editTopic = async function(id){
      if(!isAdmin) return;

      // get current doc
      const ref = doc(db,"courses",id);
      const snap = await getDoc(ref);
      if(!snap.exists()) return alert("Nie znaleziono tematu");

      const cur = snap.data();
      const newTitle = prompt("Nowy tytu≈Ç:", cur.title || "");
      if(newTitle === null) return;
      const newDesc  = prompt("Nowy opis:", cur.desc || "");
      if(newDesc === null) return;

      const t = newTitle.trim();
      const d = newDesc.trim();
      if(!t || !d) return alert("Tytu≈Ç i opis nie mogƒÖ byƒá puste");

      await updateDoc(ref, { title: t, desc: d });
      await loadTopics();
    };

    // ‚úÖ 3) DEDUPE (usuwa duplikaty z Firestore)
    // Duplikat = taki sam: level + type + title + desc
    window.dedupeLevel = async function(){
      if(!isAdmin) return;
      if(!confirm("UsunƒÖƒá duplikaty temat√≥w dla poziomu " + LEVEL + "?")) return;

      const q = query(collection(db, "courses"), where("level", "==", LEVEL));
      const snap = await getDocs(q);

      const seen = new Map(); // key -> keepDocId
      const toDelete = [];

      snap.forEach(d => {
        const data = d.data();
        const key = [
          (data.level || "").toString().toUpperCase(),
          normType(data.type),
          (data.title || "").trim(),
          (data.desc || "").trim()
        ].join("||");

        if (!seen.has(key)) {
          seen.set(key, d.id);
        } else {
          // extra duplicate -> delete
          toDelete.push(d.id);
        }
      });

      for (const id of toDelete) {
        await deleteDoc(doc(db, "courses", id));
      }

      alert(`‚úÖ Usuniƒôto duplikaty: ${toDelete.length}`);
      await loadTopics();
    };
  </script>
</body>
</html>
