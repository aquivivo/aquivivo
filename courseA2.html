<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Curso | AquiVivo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />

    <style>
      :root {
        --yellow: #fcd116;
        --blue: #003893;
        --red: #ce1126;
      }

      body {
        margin: 0;
        font-family: Montserrat, Arial, sans-serif;
        min-height: 100vh;
        background: linear-gradient(180deg, #001a4d, #003893, #001a4d);
        color: white;
      }

      main.page {
        padding: 22px 0 70px;
      }
      .container {
        max-width: 1180px;
        margin: 0 auto;
        padding: 28px 16px;
      }

      .nav-glass {
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(0, 56, 147, 0.78);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid rgba(255, 255, 255, 0.14);
      }

      .nav-glass::after {
        content: '';
        display: block;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--yellow),
          var(--blue),
          var(--red)
        );
        opacity: 0.85;
      }

      .nav-inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 14px;
        padding: 14px 16px;
        max-width: 1180px;
        margin: 0 auto;
      }

      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo-flag {
        width: 42px;
        height: 42px;
        border-radius: 999px;
        background: linear-gradient(
          180deg,
          var(--yellow) 0 33.33%,
          var(--blue) 33.33% 66.66%,
          var(--red) 66.66% 100%
        );
        box-shadow: 0 12px 26px rgba(0, 0, 0, 0.25);
      }

      .name {
        font-family: 'Playfair Display', serif;
        font-weight: 900;
        font-size: 24px;
        letter-spacing: 0.2px;
        color: white;
      }

      .nav-actions {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .titleRow {
        display: flex;
        align-items: flex-start;
        gap: 14px;
      }
      h1 {
        color: var(--yellow);
        font-family: 'Playfair Display', serif;
        font-size: 46px;
        margin: 0;
        line-height: 1.05;
      }
      .subtitle {
        opacity: 0.85;
        margin: 6px 0 0 0;
      }

      .filtersSection {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.18);
        backdrop-filter: blur(12px);
        border-radius: 16px;
        padding: 18px;
        margin: 20px 0;
        display: flex;
        gap: 14px;
        flex-wrap: wrap;
        align-items: center;
      }

      .filterGroup {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .filterLabel {
        font-size: 13px;
        opacity: 0.85;
        font-weight: 700;
        letter-spacing: 0.3px;
      }

      #searchInput {
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 10px;
        padding: 10px 14px;
        color: white;
        font-size: 14px;
        width: 220px;
        transition: all 0.2s ease;
      }
      #searchInput:focus {
        outline: none;
        background: rgba(255, 255, 255, 0.18);
        border-color: rgba(252, 209, 22, 0.5);
        box-shadow: 0 0 8px rgba(252, 209, 22, 0.2);
      }
      #searchInput::placeholder {
        color: rgba(255, 255, 255, 0.5);
      }

      #typeFilter,
      #taskFilter {
        background: rgba(255, 255, 255, 0.12);
        border: 1px solid rgba(255, 255, 255, 0.25);
        border-radius: 10px;
        padding: 10px 14px;
        color: white;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s ease;
      }
      #typeFilter:hover,
      #taskFilter:hover {
        background: rgba(255, 255, 255, 0.18);
        border-color: rgba(252, 209, 22, 0.5);
      }
      #typeFilter option,
      #taskFilter option {
        background: var(--blue);
        color: white;
      }

      .sectionTitle {
        margin: 26px 0 16px 0;
        font-size: 18px;
        font-weight: 900;
        display: flex;
        align-items: center;
        gap: 10px;
        letter-spacing: 0.3px;
      }

      .card {
        background: white;
        color: var(--blue);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin: 10px 0;
      }

      .topic {
        position: relative;
        transition: 0.25s ease;
        cursor: pointer;
        background: white;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin: 10px 0;
      }
      .topic:hover {
        transform: translateY(-4px);
        box-shadow: 0 16px 48px rgba(0, 0, 0, 0.28);
      }
      .topic strong {
        display: block;
        margin-bottom: 6px;
        font-size: 18px;
        font-weight: 900;
        color: var(--blue);
      }
      .topic p {
        margin: 0;
        font-size: 14px;
        color: #6b7280;
        line-height: 1.5;
      }

      .admin-tools {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        gap: 6px;
      }
      .admin-tools button {
        border: none;
        padding: 6px 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 700;
      }
      .btn-edit {
        background: var(--yellow);
        color: #111827;
      }
      .btn-del {
        background: var(--red);
        color: white;
      }

      .adminPanel {
        display: none;
        margin-top: 20px;
      }
      .row {
        display: grid;
        grid-template-columns: 160px 1fr 1fr auto;
        gap: 10px;
        align-items: center;
      }
      .row input,
      .row select {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #d1d5db;
        width: 100%;
        box-sizing: border-box;
      }
      .row button {
        padding: 10px 14px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 800;
        background: var(--blue);
        color: white;
      }

      .adminBar {
        display: none;
        margin-top: 14px;
        gap: 10px;
        flex-wrap: wrap;
      }
      .adminBar button {
        padding: 10px 12px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 800;
        background: rgba(255, 255, 255, 0.12);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.18);
      }
      .adminBar button:hover {
        opacity: 0.9;
      }

      .noResults {
        text-align: center;
        padding: 20px;
        opacity: 0.7;
        font-style: italic;
      }

      .sessionBar {
        background: var(--yellow);
        border-bottom: none;
        padding: 8px 0;
        text-align: center;
        font-size: 12px;
        color: var(--blue);
        font-weight: 700;
        letter-spacing: 0.2px;
      }
      .sessionBar strong {
        color: var(--blue);
        font-weight: 900;
      }
    </style>
  </head>

  <body>
    <header class="nav-glass">
      <div class="container nav-inner">
        <div class="brand">
          <div class="logo-flag" aria-hidden="true"></div>
          <div class="name">Aqui vivo</div>
        </div>

        <div class="nav-actions">
          <a class="btn-white-outline" href="index.html">Inicio</a>
          <button class="btn-red" onclick="goBack()">Atr√°s</button>
        </div>
      </div>
    </header>

    <div class="sessionBar">
      Sesi√≥n activa: <strong id="sessionEmail">Cargando...</strong>
    </div>

    <main class="page">
      <div class="container">
        <div class="titleRow">
          <div style="font-size: 44px; line-height: 1">üìò</div>
          <div style="flex: 1">
            <h1 id="levelTitle">Nivel</h1>
            <p class="subtitle" id="levelSubtitle">Cargando‚Ä¶</p>

            <div id="adminBar" class="adminBar">
              <button onclick="editCourseMeta()">
                ‚úèÔ∏è Editar descripci√≥n del curso
              </button>
              <button onclick="dedupeLevel()">üßπ Eliminar duplicados</button>
              <button id="seedBtn" style="display: none"></button>
            </div>
          </div>
        </div>

        <div class="filtersSection">
          <div class="filterGroup">
            <span class="filterLabel">üîç Buscar:</span>
            <input
              type="text"
              id="searchInput"
              placeholder="Escribe el nombre del tema..."
            />
          </div>
          <div class="filterGroup">
            <span class="filterLabel">üìÇ Tipo:</span>
            <select id="typeFilter">
              <option value="">Todos</option>
              <option value="grammar">Gram√°tica</option>
              <option value="vocabulary">Vocabulario</option>
            </select>
          </div>
          <div class="filterGroup">
            <span class="filterLabel">‚úÖ Tarea:</span>
            <select id="taskFilter">
              <option value="">Todas las tareas</option>
              <option value="Rellenar los espacios">
                Rellenar los espacios
              </option>
              <option value="Relacionar palabra con imagen">
                Relacionar palabra con imagen
              </option>
              <option value="Relacionar palabra con traducci√≥n">
                Relacionar palabra con traducci√≥n
              </option>
              <option value="Elegir la palabra correcta">
                Elegir la palabra correcta
              </option>
              <option value="Tarjetas interactivas">
                Tarjetas interactivas
              </option>
              <option value="Agrupar palabras">Agrupar palabras</option>
              <option value="Verdadero o falso">Verdadero o falso</option>
              <option value="Completar la frase con una imagen">
                Completar la frase con una imagen
              </option>
              <option value="Juego de memoria (pares)">
                Juego de memoria (pares)
              </option>
              <option value="Opci√≥n m√∫ltiple">Opci√≥n m√∫ltiple</option>
              <option value="Completar la forma correcta">
                Completar la forma correcta
              </option>
              <option value="Elegir la forma correcta">
                Elegir la forma correcta
              </option>
              <option value="Transformaciones">Transformaciones</option>
              <option value="Relacionar pregunta con respuesta">
                Relacionar pregunta con respuesta
              </option>
              <option value="Ordenar palabras para formar una frase">
                Ordenar palabras para formar una frase
              </option>
              <option value="Corregir errores">Corregir errores</option>
              <option value="Unir dos partes de la frase">
                Unir dos partes de la frase
              </option>
              <option value="Completar con preposici√≥n o terminaci√≥n">
                Completar con preposici√≥n o terminaci√≥n
              </option>
              <option value="Opci√≥n √∫nica">Opci√≥n √∫nica</option>
              <option value="Escribir tu propia respuesta">
                Escribir tu propia respuesta
              </option>
              <option value="Repetir despu√©s del narrador">
                Repetir despu√©s del narrador
              </option>
              <option value="Completar la frase con tu voz">
                Completar la frase con tu voz
              </option>
              <option value="Responder a una pregunta">
                Responder a una pregunta
              </option>
              <option value="Describir una imagen">Describir una imagen</option>
              <option value="Juego de roles">Juego de roles</option>
              <option value="Mini-mon√≥logo">Mini-mon√≥logo</option>
              <option value="Di√°logo semiabierto">Di√°logo semiabierto</option>
              <option value="Decirlo de otra manera">
                Decirlo de otra manera
              </option>
              <option value="Escuchar y elegir la respuesta">
                Escuchar y elegir la respuesta
              </option>
              <option value="Escuchar y completar los espacios">
                Escuchar y completar los espacios
              </option>
              <option value="Escuchar y marcar verdadero o falso">
                Escuchar y marcar verdadero o falso
              </option>
              <option value="Escuchar y relacionar personas">
                Escuchar y relacionar personas
              </option>
              <option value="Escuchar y ordenar la secuencia">
                Escuchar y ordenar la secuencia
              </option>
              <option value="Dictado con audio">Dictado con audio</option>
              <option value="Escuchar y repetir">Escuchar y repetir</option>
              <option value="Di√°logo interactivo">Di√°logo interactivo</option>
              <option value="Misi√≥n del d√≠a">Misi√≥n del d√≠a</option>
              <option value="Quiz situacional">Quiz situacional</option>
              <option value="Video con preguntas">Video con preguntas</option>
              <option value="Test final del tema">Test final del tema</option>
              <option value="Debate grabado">Debate grabado</option>
              <option value="Contar una historia">Contar una historia</option>
              <option value="Simulaci√≥n de entrevista de trabajo">
                Simulaci√≥n de entrevista de trabajo
              </option>
              <option value="Retroalimentaci√≥n por voz">
                Retroalimentaci√≥n por voz
              </option>
            </select>
          </div>
        </div>

        <div class="sectionTitle">üìò Gram√°tica</div>
        <div id="grammarList"></div>

        <div class="sectionTitle">üìó Vocabulario</div>
        <div id="vocabList"></div>

        <div id="adminPanel" class="card adminPanel">
          <h3 style="margin: 0 0 10px 0">üëë Panel Admin ‚Äì agregar tema</h3>

          <div class="row">
            <select id="adminType">
              <option value="grammar">gram√°tica</option>
              <option value="vocabulary">vocabulario</option>
            </select>

            <input id="adminTitle" placeholder="T√≠tulo (ES)" />
            <input id="adminDesc" placeholder="Descripci√≥n (ES)" />

            <button onclick="addTopic()">‚ûï Agregar</button>
          </div>

          <p style="font-size: 12px; color: #6b7280; margin: 10px 0 0 0">
            Si hiciste clic en importar varias veces ‚Äì usa "Eliminar
            duplicados". Esto eliminar√° las repeticiones en Firestore.
          </p>
        </div>
      </div>
    </main>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
      import {
        getFirestore,
        collection,
        query,
        where,
        getDocs,
        addDoc,
        deleteDoc,
        updateDoc,
        doc,
        getDoc,
        setDoc,
        writeBatch,
        serverTimestamp,
      } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM',
        authDomain: 'aquivivo-platform.firebaseapp.com',
        projectId: 'aquivivo-platform',
        storageBucket: 'aquivivo-platform.firebasestorage.app',
        messagingSenderId: '116115622011',
        appId: '1:116115622011:web:33a4a583eba4368071bade',
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const ADMIN_EMAIL = 'aquivivo.pl@gmail.com';
      let isAdmin = false;

      // LEVEL detection:
      // 1) ?level=A1/A2/B1/B2
      // 2) filename contains a1/a2/b1/b2
      // 3) default A1
      let LEVEL = 'A1';
      const params = new URLSearchParams(window.location.search);
      if (params.get('level')) LEVEL = params.get('level').toUpperCase();

      const filename = window.location.pathname.split('/').pop().toLowerCase();
      if (!params.get('level')) {
        if (filename.includes('a2')) LEVEL = 'A2';
        else if (filename.includes('b1')) LEVEL = 'B1';
        else if (filename.includes('b2')) LEVEL = 'B2';
        else if (filename.includes('a1')) LEVEL = 'A1';
      }

      // UI refs
      const levelTitle = document.getElementById('levelTitle');
      const levelSubtitle = document.getElementById('levelSubtitle');
      const grammarList = document.getElementById('grammarList');
      const vocabList = document.getElementById('vocabList');
      const adminPanel = document.getElementById('adminPanel');
      const adminBar = document.getElementById('adminBar');
      const seedBtn = document.getElementById('seedBtn');

      const searchInput = document.getElementById('searchInput');
      const typeFilter = document.getElementById('typeFilter');
      const taskFilter = document.getElementById('taskFilter');

      let allTopics = [];

      levelTitle.textContent = `Nivel ${LEVEL}`;
      levelSubtitle.textContent = 'Cargando‚Ä¶';

      // ===== DATASETS =====
      const A1_TOPICS = [
        // üìò Gram√°tica (11)
        {
          type: 'grammar',
          title: 'Alfabeto y pronunciaci√≥n (Alfabet i wymowa)',
          desc: 'Sonidos, letras y acento. Tareas: Repetir despu√©s del narrador, Opci√≥n m√∫ltiple, Escuchar y repetir',
          order: 1,
        },
        {
          type: 'grammar',
          title: 'Orden de palabras en la frase (Szyk wyraz√≥w w zdaniu)',
          desc: 'Estructura b√°sica SVO y √©nfasis. Tareas: Ordenar palabras para formar una frase, Opci√≥n m√∫ltiple',
          order: 2,
        },
        {
          type: 'grammar',
          title:
            'Verbos b√°sicos: byƒá y mieƒá (Czasowniki podstawowe: byƒá i mieƒá)',
          desc: 'Conjugaci√≥n y uso en frases. Tareas: Completar la forma correcta, Elegir la forma correcta, Rellenar los espacios',
          order: 3,
        },
        {
          type: 'grammar',
          title:
            'Presente: verbos regulares (Czas tera≈∫niejszy: czasowniki regularne)',
          desc: 'Terminaciones y pr√°ctica. Tareas: Completar la forma correcta, Transformaciones, Rellenar los espacios',
          order: 4,
        },
        {
          type: 'grammar',
          title:
            'Pronombres personales y posesivos (Zaimki osobowe i dzier≈ºawcze)',
          desc: 'Yo/t√∫‚Ä¶ y mi/tu‚Ä¶ Tareas: Opci√≥n m√∫ltiple, Relacionar pregunta con respuesta, Rellenar los espacios',
          order: 5,
        },
        {
          type: 'grammar',
          title:
            'Oraciones afirmativas, negativas y preguntas (Zdania twierdzƒÖce, przeczƒÖce i pytania)',
          desc: 'Nie‚Ä¶? ¬øCzy‚Ä¶? Tareas: Opci√≥n m√∫ltiple, Corregir errores, Unir dos partes de la frase',
          order: 6,
        },
        {
          type: 'grammar',
          title: 'Sustantivos: g√©nero y n√∫mero (Rzeczowniki: rodzaj i liczba)',
          desc: 'Masculino/femenino/neutro + plural. Tareas: Elegir la palabra correcta, Opci√≥n m√∫ltiple, Rellenar los espacios',
          order: 7,
        },
        {
          type: 'grammar',
          title: 'Adjetivos y concordancia (Przymiotniki i ich zgodno≈õƒá)',
          desc: 'Acuerdo con sustantivo. Tareas: Completar con preposici√≥n o terminaci√≥n, Elegir la forma correcta, Transformaciones',
          order: 8,
        },
        {
          type: 'grammar',
          title:
            'Preposiciones b√°sicas: w, na, do (Przyimki podstawowe: w, na, do)',
          desc: 'Uso en lugar y direcci√≥n. Tareas: Completar con preposici√≥n o terminaci√≥n, Opci√≥n m√∫ltiple, Rellenar los espacios',
          order: 9,
        },
        {
          type: 'grammar',
          title: 'Caso acusativo (introducci√≥n) (Biernik - wprowadzenie)',
          desc: 'Kogo? co? formas b√°sicas. Tareas: Completar con preposici√≥n o terminaci√≥n, Elegir la forma correcta, Opci√≥n m√∫ltiple',
          order: 10,
        },
        {
          type: 'grammar',
          title: 'N√∫meros y cantidades (Liczby i ilo≈õci)',
          desc: 'N√∫meros b√°sicos + cantidades. Tareas: Dictado con audio, Opci√≥n m√∫ltiple, Rellenar los espacios',
          order: 11,
        },

        // üìó Vocabulario (16)
        {
          type: 'vocabulary',
          title: 'Saludos y presentaci√≥n (Powitania i przedstawianie siƒô)',
          desc: 'Frases b√°sicas para empezar conversaci√≥n. Tareas: Tarjetas interactivas, Juego de memoria (pares), Di√°logo interactivo',
          order: 101,
        },
        {
          type: 'vocabulary',
          title: 'Pa√≠ses y nacionalidades (Kraje i narodowo≈õci)',
          desc: 'Pa√≠ses, gentilicios, preguntas t√≠picas. Tareas: Relacionar palabra con traducci√≥n, Opci√≥n m√∫ltiple',
          order: 102,
        },
        {
          type: 'vocabulary',
          title: 'Informaci√≥n personal (Informacje osobiste)',
          desc: 'Edad, direcci√≥n, tel√©fono, datos. Tareas: Rellenar los espacios, Responder a una pregunta, Opci√≥n m√∫ltiple',
          order: 103,
        },
        {
          type: 'vocabulary',
          title: 'Profesiones y trabajo (Zawody i praca)',
          desc: 'Profesiones y verbos b√°sicos del trabajo. Tareas: Relacionar palabra con imagen, Tarjetas interactivas, Opci√≥n m√∫ltiple',
          order: 104,
        },
        {
          type: 'vocabulary',
          title: 'Familia (Rodzina)',
          desc: 'Miembros de la familia y relaciones. Tareas: Juego de memoria (pares), Relacionar palabra con traducci√≥n',
          order: 105,
        },
        {
          type: 'vocabulary',
          title: 'Casa y vivienda (Dom i mieszkanie)',
          desc: 'Habitaciones, muebles, objetos. Tareas: Relacionar palabra con imagen, Agrupar palabras, Opci√≥n m√∫ltiple',
          order: 106,
        },
        {
          type: 'vocabulary',
          title: 'Comida y bebidas (Jedzenie i napoje)',
          desc: 'Productos, bebidas y verbos (comer/beber). Tareas: Tarjetas interactivas, Verdadero o falso, Opci√≥n m√∫ltiple',
          order: 107,
        },
        {
          type: 'vocabulary',
          title: 'Tienda y compras (Sklep i zakupy)',
          desc: 'Preguntar precio, cantidades, tienda. Tareas: Quiz situacional, Di√°logo semiabierto, Opci√≥n m√∫ltiple',
          order: 108,
        },
        {
          type: 'vocabulary',
          title: 'Ropa (Ubrania)',
          desc: 'Prendas, colores, tallas. Tareas: Relacionar palabra con imagen, Opci√≥n m√∫ltiple, Tarjetas interactivas',
          order: 109,
        },
        {
          type: 'vocabulary',
          title: 'Tiempo y d√≠as (Czas i dni)',
          desc: 'D√≠as, meses, horas b√°sicas. Tareas: Escuchar y elegir la respuesta, Dictado con audio, Opci√≥n m√∫ltiple',
          order: 110,
        },
        {
          type: 'vocabulary',
          title: 'Rutina diaria (Codzienna rutyna)',
          desc: 'Acciones diarias y horarios. Tareas: Ordenar palabras para formar una frase, Rellenar los espacios',
          order: 111,
        },
        {
          type: 'vocabulary',
          title: 'Ciudad y lugares (Miasto i miejsca)',
          desc: 'Lugares en la ciudad y servicios. Tareas: Relacionar palabra con imagen, Opci√≥n m√∫ltiple',
          order: 112,
        },
        {
          type: 'vocabulary',
          title: 'Direcciones y orientaci√≥n (Kierunki i orientacja)',
          desc: 'Preguntar camino, direcciones. Tareas: Quiz situacional, Relacionar pregunta con respuesta, Opci√≥n m√∫ltiple',
          order: 113,
        },
        {
          type: 'vocabulary',
          title: 'M√©dico y salud (b√°sico) (Lekarz i zdrowie - podstawy)',
          desc: 'S√≠ntomas simples y frases √∫tiles. Tareas: Opci√≥n m√∫ltiple, Verdadero o falso, Responder a una pregunta',
          order: 114,
        },
        {
          type: 'vocabulary',
          title:
            'Oficina p√∫blica y documentos (b√°sico) (UrzƒÖd i dokumenty - podstawy)',
          desc: 'Tr√°mites b√°sicos y documentos. Tareas: Quiz situacional, Opci√≥n m√∫ltiple, Unir dos partes de la frase',
          order: 115,
        },
        {
          type: 'vocabulary',
          title: 'Frases √∫tiles (Przydatne zwroty)',
          desc: 'Zwroty na co dzie≈Ñ. Tareas: Tarjetas interactivas, Di√°logo interactivo, Opci√≥n √∫nica',
          order: 116,
        },
      ];

      const A2_TOPICS = [
        // üìò Gram√°tica (13)
        {
          type: 'grammar',
          title:
            'Presente: verbos irregulares (Czas tera≈∫niejszy: czasowniki nieregularne)',
          desc: 'Conjugaci√≥n b√°sica de irregulares. Tareas: Completar la forma correcta, Elegir la forma correcta, Transformaciones',
          order: 1,
        },
        {
          type: 'grammar',
          title: 'Verbos reflexivos (Czasowniki zwrotne)',
          desc: 'Formas con siƒô y uso en frases. Tareas: Rellenar los espacios, Elegir la forma correcta, Opci√≥n m√∫ltiple',
          order: 2,
        },
        {
          type: 'grammar',
          title: 'Pasado simple (Czas przesz≈Çy prosty)',
          desc: 'Formaci√≥n del pasado y pr√°ctica. Tareas: Completar la forma correcta, Dictado con audio, Transformaciones',
          order: 3,
        },
        {
          type: 'grammar',
          title: 'Futuro simple (Czas przysz≈Çy prosty)',
          desc: 'Futuro con byƒá + infinitivo / formas b√°sicas. Tareas: Rellenar los espacios, Opci√≥n m√∫ltiple, Transformaciones',
          order: 4,
        },
        {
          type: 'grammar',
          title:
            'Verbos modales: m√≥c, musieƒá, chcieƒá (Czasowniki modalne: m√≥c, musieƒá, chcieƒá)',
          desc: 'Estructuras modales en contexto. Tareas: Elegir la forma correcta, Completar la forma correcta, Unir dos partes de la frase',
          order: 5,
        },
        {
          type: 'grammar',
          title:
            'Casos del polaco: visi√≥n general (Przypadki w jƒôzyku polskim: przeglƒÖd)',
          desc: 'Qu√© caso usar y cu√°ndo. Tareas: Opci√≥n m√∫ltiple, Relacionar pregunta con respuesta',
          order: 6,
        },
        {
          type: 'grammar',
          title: 'Caso genitivo (Dope≈Çniacz)',
          desc: 'Formas b√°sicas + negaci√≥n y cantidades. Tareas: Completar con preposici√≥n o terminaci√≥n, Elegir la forma correcta',
          order: 7,
        },
        {
          type: 'grammar',
          title: 'Caso locativo (Miejscownik)',
          desc: 'D√≥nde: w/na + miejscownik. Tareas: Completar con preposici√≥n o terminaci√≥n, Opci√≥n m√∫ltiple',
          order: 8,
        },
        {
          type: 'grammar',
          title: 'Caso instrumental (Narzƒôdnik)',
          desc: 'Con kim? z czym? formas y usos. Tareas: Completar con preposici√≥n o terminaci√≥n, Transformaciones',
          order: 9,
        },
        {
          type: 'grammar',
          title: 'Preposiciones con casos (Przyimki z przypadkami)',
          desc: 'Mapa de preposiciones + casos. Tareas: Completar con preposici√≥n o terminaci√≥n, Opci√≥n m√∫ltiple, Corregir errores',
          order: 10,
        },
        {
          type: 'grammar',
          title: 'Comparativos y superlativos (Stopniowanie przymiotnik√≥w)',
          desc: 'lepszy/najlepszy + regulares. Tareas: Transformaciones, Elegir la forma correcta',
          order: 11,
        },
        {
          type: 'grammar',
          title:
            'Adverbios de tiempo y frecuencia (Przys≈Ç√≥wki czasu i czƒôstotliwo≈õci)',
          desc: 'zawsze/czƒôsto/ju≈º/jeszcze. Tareas: Rellenar los espacios, Opci√≥n m√∫ltiple',
          order: 12,
        },
        {
          type: 'grammar',
          title: 'Conectores b√°sicos (Sp√≥jniki podstawowe)',
          desc: 'i/ale/bo/≈ºe/wiƒôc. Tareas: Unir dos partes de la frase, Ordenar palabras para formar una frase',
          order: 13,
        },

        // üìó Vocabulario (10)
        {
          type: 'vocabulary',
          title: 'Presentaci√≥n y small talk (Przedstawianie siƒô i small talk)',
          desc: 'Preguntas t√≠picas + respuestas naturales. Tareas: Di√°logo semiabierto, Di√°logo interactivo, Responder a una pregunta',
          order: 101,
        },
        {
          type: 'vocabulary',
          title: 'Trabajo y responsabilidades (Praca i obowiƒÖzki)',
          desc: 'Vocabulario laboral + verbos. Tareas: Tarjetas interactivas, Opci√≥n m√∫ltiple, Quiz situacional',
          order: 102,
        },
        {
          type: 'vocabulary',
          title: 'Vivienda y alquiler (Mieszkanie i wynajem)',
          desc: 'Anuncios, contrato, problemas. Tareas: Quiz situacional, Relacionar palabra con traducci√≥n, Opci√≥n m√∫ltiple',
          order: 103,
        },
        {
          type: 'vocabulary',
          title: 'Comida y restaurante (Jedzenie i restauracja)',
          desc: 'Pedido, men√∫, preferencias. Tareas: Di√°logo interactivo, Opci√≥n m√∫ltiple, Verdadero o falso',
          order: 104,
        },
        {
          type: 'vocabulary',
          title: 'Tienda y devoluciones (Sklep i zwroty)',
          desc: 'Reclamaci√≥n, cambio, recibo. Tareas: Quiz situacional, Unir dos partes de la frase, Opci√≥n m√∫ltiple',
          order: 105,
        },
        {
          type: 'vocabulary',
          title: 'M√©dico y farmacia (Lekarz i apteka)',
          desc: 'S√≠ntomas, medicamentos, consejos. Tareas: Responder a una pregunta, Opci√≥n m√∫ltiple, Verdadero o falso',
          order: 106,
        },
        {
          type: 'vocabulary',
          title: 'Oficina p√∫blica y tr√°mites (UrzƒÖd i za≈Çatwianie spraw)',
          desc: 'Citas, formularios, documentos. Tareas: Quiz situacional, Opci√≥n m√∫ltiple, Corregir errores',
          order: 107,
        },
        {
          type: 'vocabulary',
          title: 'Transporte p√∫blico (Transport publiczny)',
          desc: 'Billetes, horarios, direcciones. Tareas: Escuchar y elegir la respuesta, Opci√≥n m√∫ltiple, Quiz situacional',
          order: 108,
        },
        {
          type: 'vocabulary',
          title: 'Tiempo libre (Czas wolny)',
          desc: 'Planes, hobbies, propuestas. Tareas: Di√°logo semiabierto, Ordenar palabras para formar una frase',
          order: 109,
        },
        {
          type: 'vocabulary',
          title: 'Emociones y estado de √°nimo (Emocje i nastr√≥j)',
          desc: 'Sentimientos, reacciones, opiniones. Tareas: Mini-mon√≥logo, Responder a una pregunta, Opci√≥n √∫nica',
          order: 110,
        },
      ];

      const SEEDS = {
        A1: { label: 'üå± Reset + Import A1 (27 temas)', topics: A1_TOPICS },
        A2: { label: 'üåø Reset + Import A2 (23 temas)', topics: A2_TOPICS },
        // B1: { label: "‚ú® Reset + Import B1 (...)", topics: B1_TOPICS },
        // B2: { label: "üöÄ Reset + Import B2 (...)", topics: B2_TOPICS },
      };

      // auth
      onAuthStateChanged(auth, async (user) => {
        if (!user) {
          window.location.href = 'login.html';
          return;
        }

        document.getElementById('sessionEmail').textContent =
          user.email || '(sin correo)';
        isAdmin = user.email === ADMIN_EMAIL;

        if (isAdmin) {
          adminPanel.style.display = 'block';
          adminBar.style.display = 'flex';
        } else {
          adminPanel.style.display = 'none';
          adminBar.style.display = 'none';
        }

        // configure seed button per LEVEL
        configureSeedButton();

        await loadCourseMeta();
        await loadTopics();
      });

      function configureSeedButton() {
        seedBtn.style.display = 'none';
        seedBtn.onclick = null;

        if (!isAdmin) return;

        const seed = SEEDS[LEVEL];
        if (!seed) return;

        seedBtn.textContent = seed.label;
        seedBtn.style.display = 'inline-flex';
        seedBtn.onclick = () => seedLevel(LEVEL, seed.topics);
      }

      // logout (kept)
      window.logout = function () {
        signOut(auth).then(() => (window.location.href = 'login.html'));
      };

      // helpers
      function normType(t) {
        return String(t || '')
          .toLowerCase()
          .trim();
      }

      function escapeHtml(s) {
        return String(s)
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      // meta
      async function loadCourseMeta() {
        const metaRef = doc(db, 'course_meta', LEVEL);
        const metaSnap = await getDoc(metaRef);

        if (metaSnap.exists()) {
          const m = metaSnap.data();
          levelTitle.textContent = m.title || `Nivel ${LEVEL}`;
          levelSubtitle.textContent = m.subtitle || 'Listo ‚úÖ';
        } else {
          levelTitle.textContent = `Nivel ${LEVEL}`;
          levelSubtitle.textContent = 'Listo ‚úÖ';
        }
      }

      window.editCourseMeta = async function () {
        if (!isAdmin) return;

        const currentTitle = levelTitle.textContent;
        const currentSub = levelSubtitle.textContent;

        const newTitle = prompt(
          'Nuevo t√≠tulo del curso (encabezado):',
          currentTitle,
        );
        if (newTitle === null) return;

        const newSub = prompt(
          'Nueva descripci√≥n del curso (debajo del t√≠tulo):',
          currentSub,
        );
        if (newSub === null) return;

        const metaRef = doc(db, 'course_meta', LEVEL);
        await setDoc(
          metaRef,
          {
            title: newTitle.trim() || `Nivel ${LEVEL}`,
            subtitle: newSub.trim() || '',
          },
          { merge: true },
        );

        await loadCourseMeta();
        alert('‚úÖ Descripci√≥n del curso guardada');
      };

      // topics
      async function loadTopics() {
        grammarList.innerHTML = '';
        vocabList.innerHTML = '';

        const q = query(collection(db, 'courses'), where('level', '==', LEVEL));
        const snap = await getDocs(q);

        allTopics = [];

        snap.forEach((d) => {
          const data = d.data();
          const t = normType(data.type);

          allTopics.push({
            id: d.id,
            title: data.title || '',
            desc: data.desc || '',
            order: Number(data.order ?? 9999),
            type: t,
          });
        });

        allTopics.sort((a, b) => {
          if (a.type !== b.type) return a.type === 'grammar' ? -1 : 1;
          return a.order - b.order;
        });

        renderFiltered();

        if (levelSubtitle.textContent.toLowerCase().includes('cargando')) {
          levelSubtitle.textContent = 'Listo ‚úÖ';
        }
      }

      function renderFiltered() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedType = typeFilter.value;
        const selectedTask = taskFilter.value;

        const grammar = [];
        const vocab = [];

        allTopics.forEach((item) => {
          if (
            searchTerm &&
            !item.title.toLowerCase().includes(searchTerm) &&
            !item.desc.toLowerCase().includes(searchTerm)
          )
            return;
          if (selectedType && item.type !== selectedType) return;
          if (
            selectedTask &&
            !item.desc.toLowerCase().includes(selectedTask.toLowerCase())
          )
            return;

          if (item.type === 'grammar') grammar.push(item);
          if (item.type === 'vocabulary') vocab.push(item);
        });

        grammar.sort((a, b) => a.order - b.order);
        vocab.sort((a, b) => a.order - b.order);

        grammarList.innerHTML = grammar.length
          ? grammar.map(renderTopicCard).join('')
          : `<div class="card noResults">Sin resultados para gram√°tica</div>`;

        vocabList.innerHTML = vocab.length
          ? vocab.map(renderTopicCard).join('')
          : `<div class="card noResults">Sin resultados para vocabulario</div>`;
      }

      function renderTopicCard(t) {
        const adminButtons = isAdmin
          ? `<div class="admin-tools">
             <button class="btn-edit" onclick="event.stopPropagation(); editTopic('${t.id}')">‚úèÔ∏è</button>
             <button class="btn-del" onclick="event.stopPropagation(); deleteTopic('${t.id}')">‚ùå</button>
           </div>`
          : '';

        return `
        <div class="card topic" onclick="openLesson('${t.id}')">
          ${adminButtons}
          <strong>${escapeHtml(t.title)}</strong>
          <p>${escapeHtml(t.desc)}</p>
        </div>
      `;
      }

      window.openLesson = function (id) {
        alert('Pr√≥ximo paso: lesson.html?id=' + id);
      };

      // add/edit/delete
      window.addTopic = async function () {
        if (!isAdmin) return;

        const type = document.getElementById('adminType').value;
        const title = document.getElementById('adminTitle').value.trim();
        const desc = document.getElementById('adminDesc').value.trim();

        if (!title || !desc)
          return alert('Completa el t√≠tulo y la descripci√≥n');

        const q = query(collection(db, 'courses'), where('level', '==', LEVEL));
        const snap = await getDocs(q);
        let maxOrder = 0;
        snap.forEach((d) => {
          const o = Number(d.data().order ?? 0);
          if (o > maxOrder) maxOrder = o;
        });

        await addDoc(collection(db, 'courses'), {
          level: LEVEL,
          type,
          title,
          desc,
          order: maxOrder + 1,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        });

        document.getElementById('adminTitle').value = '';
        document.getElementById('adminDesc').value = '';

        await loadTopics();
        alert('‚úÖ Tema agregado');
      };

      window.deleteTopic = async function (id) {
        if (!isAdmin) return;
        if (!confirm('¬øEliminar este tema?')) return;

        await deleteDoc(doc(db, 'courses', id));
        await loadTopics();
      };

      window.editTopic = async function (id) {
        if (!isAdmin) return;

        const ref = doc(db, 'courses', id);
        const snap = await getDoc(ref);
        if (!snap.exists()) return alert('Tema no encontrado');

        const cur = snap.data();
        const newTitle = prompt('Nuevo t√≠tulo:', cur.title || '');
        if (newTitle === null) return;
        const newDesc = prompt('Nueva descripci√≥n:', cur.desc || '');
        if (newDesc === null) return;

        const t = newTitle.trim();
        const d = newDesc.trim();
        if (!t || !d)
          return alert('El t√≠tulo y la descripci√≥n no pueden estar vac√≠os');

        await updateDoc(ref, {
          title: t,
          desc: d,
          updatedAt: serverTimestamp(),
        });
        await loadTopics();
      };

      window.dedupeLevel = async function () {
        if (!isAdmin) return;
        if (!confirm('¬øEliminar temas duplicados para el nivel ' + LEVEL + '?'))
          return;

        const q = query(collection(db, 'courses'), where('level', '==', LEVEL));
        const snap = await getDocs(q);

        const seen = new Map();
        const toDelete = [];

        snap.forEach((d) => {
          const data = d.data();
          const key = [
            (data.level || '').toString().toUpperCase(),
            normType(data.type),
            (data.title || '').trim(),
            (data.desc || '').trim(),
          ].join('||');

          if (!seen.has(key)) seen.set(key, d.id);
          else toDelete.push(d.id);
        });

        for (const id of toDelete) {
          await deleteDoc(doc(db, 'courses', id));
        }

        alert(`‚úÖ Duplicados eliminados: ${toDelete.length}`);
        await loadTopics();
      };

      // ===== UNIVERSAL SEED FUNCTION =====
      async function seedLevel(level, topics) {
        if (!isAdmin) return;

        const ok = confirm(
          `UWAGA: To usunie WSZYSTKIE tematy ${level} i wgra ${topics.length} nowych. Kontynuowaƒá?`,
        );
        if (!ok) return;

        // delete all docs for that level
        const qLvl = query(
          collection(db, 'courses'),
          where('level', '==', level),
        );
        const snap = await getDocs(qLvl);

        const ids = [];
        snap.forEach((d) => ids.push(d.id));

        const CHUNK = 400;
        for (let i = 0; i < ids.length; i += CHUNK) {
          const batch = writeBatch(db);
          ids
            .slice(i, i + CHUNK)
            .forEach((id) => batch.delete(doc(db, 'courses', id)));
          await batch.commit();
        }

        // add topics
        const toAdd = topics.map((t) => ({
          level,
          type: t.type,
          title: t.title,
          desc: t.desc,
          order: t.order,
          createdAt: serverTimestamp(),
          updatedAt: serverTimestamp(),
        }));

        for (let i = 0; i < toAdd.length; i += CHUNK) {
          const batch = writeBatch(db);
          toAdd.slice(i, i + CHUNK).forEach((obj) => {
            const newRef = doc(collection(db, 'courses'));
            batch.set(newRef, obj);
          });
          await batch.commit();
        }

        alert(
          `‚úÖ ${level} gotowe: usuniƒôto ${ids.length} i wgrano ${toAdd.length} temat√≥w.`,
        );
        await loadTopics();
      }

      // listeners
      searchInput.addEventListener('input', renderFiltered);
      typeFilter.addEventListener('change', renderFiltered);
      taskFilter.addEventListener('change', renderFiltered);

      window.goBack = function () {
        window.location.href = 'espanel.html';
      };
    </script>
  </body>
</html>
