<!doctype html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Import A2 ‚Üí Firestore (AquiVivo)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body{ font-family: Arial, sans-serif; padding: 20px; }
    button{ padding: 12px 16px; font-weight: 800; cursor: pointer; }
    .box{ margin-top: 12px; padding: 12px; border: 1px solid #ddd; border-radius: 10px; }
    .ok{ color: #065f46; font-weight: 800; }
    .err{ color: #b91c1c; font-weight: 800; }
    code{ background:#f3f4f6; padding:2px 6px; border-radius:6px; }
    .muted{ color:#6b7280; }
  </style>
</head>
<body>

<h2>üî• Import A2 ‚Üí Firestore</h2>
<p>Dodaje tematy <b>A2</b> do kolekcji <code>courses</code> bez duplikat√≥w. Ustawia <code>free=false</code>.</p>
<p class="muted">Wymaga zalogowania jako admin: <code>aquivivo.pl@gmail.com</code></p>

<button id="importBtn">IMPORT A2 (bez duplikat√≥w)</button>
<div id="log" class="box">Status: gotowe.</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  query,
  where
} from "https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js";

/* üî• FIREBASE CONFIG */
const firebaseConfig = {
  "apiKey": "AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM",
  "authDomain": "aquivivo-platform.firebaseapp.com",
  "projectId": "aquivivo-platform",
  "storageBucket": "aquivivo-platform.firebasestorage.app",
  "messagingSenderId": "116115622011",
  "appId": "1:116115622011:web:33a4a583eba4368071bade"
};
const ADMIN_EMAIL = "aquivivo.pl@gmail.com";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const logEl = document.getElementById("log");
function log(msg, type=""){
  logEl.innerHTML = `<div class="${type}">${msg}</div>`;
}

/* üîê CHECK ADMIN */
onAuthStateChanged(auth, (user) => {
  if (!user || (user.email || "").toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
    alert("‚ùå Nie jeste≈õ adminem (albo nie jeste≈õ zalogowana na tej domenie).");
    window.location.href = "login.html";
  }
});

/* ===================== A2 DATA ===================== */
/* Format: ["Tytu≈Ç", "Opis"] */
const A2_GRAMMAR = [
  [
    "Tiempo pasado (pret√©rito)",
    "Opanowaƒá m√≥wienie o przesz≈Ço≈õci: co robi≈Çam/robi≈Çe≈õ, gdzie by≈Çam/by≈Çe≈õ, kiedy i z kim"
  ],
  [
    "Tiempo futuro simple",
    "Nauczyƒá siƒô m√≥wiƒá o planach i przysz≈Ço≈õci: co zrobiƒô, dokƒÖd p√≥jdƒô, kiedy to bƒôdzie"
  ],
  [
    "Verbos reflexivos (siƒô)",
    "Zrozumieƒá i stosowaƒá czasowniki zwrotne: myjƒô siƒô, uczƒô siƒô, ubieram siƒô"
  ],
  [
    "Verbos modales (m√≥c, musieƒá, chcieƒá)",
    "M√≥wiƒá o mo≈ºliwo≈õci, konieczno≈õci i chƒôci: mogƒô, muszƒô, chcƒô"
  ],
  [
    "Caso genitivo (dope≈Çniacz)",
    "U≈ºywaƒá dope≈Çniacza w praktyce: nie ma‚Ä¶, potrzebujƒô‚Ä¶, szukam‚Ä¶, do/od/bez"
  ],
  [
    "Caso locativo (miejscownik)",
    "M√≥wiƒá o miejscu: w Polsce, na uczelni, o temacie, po (po pracy)"
  ],
  [
    "Caso instrumental (narzƒôdnik)",
    "Opanowaƒá narzƒôdnik: z kim? z czym? jestem nauczycielkƒÖ, interesujƒô siƒô‚Ä¶"
  ],
  [
    "Comparaci√≥n de adjetivos (comparativo y superlativo)",
    "Por√≥wnywaƒá: lepszy, gorszy, wiƒôkszy, najmniejszy itd."
  ],
  [
    "Adverbios de frecuencia y tiempo",
    "M√≥wiƒá jak czƒôsto i kiedy: zawsze, czƒôsto, rzadko, wczoraj, jutro, niedawno"
  ]
];
const A2_VOCAB   = [
  [
    "(Uzupe≈Çnij)",
    "Wklej listƒô s≈Çownictwa tutaj w formacie: [\"Temat\",\"Opis\"]"
  ]
];

/* ===================== HELPERS ===================== */
function makeKey(level, type, title, desc){
  return [
    String(level||"").toUpperCase().trim(),
    String(type||"").toLowerCase().trim(),
    String(title||"").trim(),
    String(desc||"").trim()
  ].join("||");
}

async function fetchExistingKeysForLevel(level){
  const qRef = query(collection(db, "courses"), where("level", "==", level));
  const snap = await getDocs(qRef);
  const set = new Set();
  snap.forEach(d => {
    const data = d.data();
    set.add(makeKey(data.level, data.type, data.title, data.desc));
  });
  return set;
}

/* ===================== IMPORT ===================== */
document.getElementById("importBtn").onclick = async () => {
  try{
    log("‚è≥ Importujƒô‚Ä¶", "");

    const col = collection(db, "courses");
    const existing = await fetchExistingKeysForLevel("A2");

    let order = 1;
    let added = 0;
    let skipped = 0;

    for (const [title, desc] of A2_GRAMMAR) {
      const level = "A2";
      const type = "grammar";
      const key = makeKey(level, type, title, desc);

      if (existing.has(key)) skipped++;
      else {
        await addDoc(col, {
          level, type, title, desc,
          order,
          free: false,
          exerciseTypes: []
        });
        existing.add(key);
        added++;
      }
      order++;
    }

    for (const [title, desc] of A2_VOCAB) {
      const level = "A2";
      const type = "vocabulary";
      const key = makeKey(level, type, title, desc);

      if (existing.has(key)) skipped++;
      else {
        await addDoc(col, {
          level, type, title, desc,
          order,
          free: false,
          exerciseTypes: []
        });
        existing.add(key);
        added++;
      }
      order++;
    }

    log(`‚úÖ Gotowe! Dodano: ${added} ‚Ä¢ Pominiƒôto (duplikaty): ${skipped}`, "ok");
    alert(`‚úÖ Import zako≈Ñczony!\nDodano: ${added}\nPominiƒôto (duplikaty): ${skipped}`);
  } catch(e) {
    console.error(e);
    log("‚ùå B≈ÇƒÖd importu: " + (e?.message || e), "err");
    alert("‚ùå B≈ÇƒÖd importu: " + (e?.message || e));
  }
};
</script>

</body>
</html>
