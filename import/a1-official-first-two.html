<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <title>A1 Official (2 pierwsze tematy) â†’ Firestore (AquiVivo)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="../assets/css/styles.css?v=20260209a" />
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      button {
        padding: 12px 16px;
        font-weight: 900;
        cursor: pointer;
      }
      .box {
        margin-top: 12px;
        padding: 12px;
        border: 1px solid var(--border-light);
        border-radius: 10px;
      }
      .ok {
        color: var(--success-ink);
        font-weight: 900;
      }
      .err {
        color: var(--danger-ink);
        font-weight: 900;
      }
      code {
        background: #f3f4f6;
        padding: 2px 6px;
        border-radius: 6px;
      }
      .muted {
        color: var(--ink-muted);
      }
      .topicLine {
        margin-top: 6px;
        line-height: 1.55;
      }
    </style>
  </head>
  <body>
    <div
      style="
        background: var(--yellow);
        color: var(--blue);
        padding: 8px;
        text-align: center;
        font-size: 12px;
        font-weight: 700;
        margin-bottom: 14px;
      "
    >
      SesiÃ³n activa:
      <strong id="sessionEmail" style="color: var(--blue); font-weight: 900"
        >Cargando...</strong
      >
    </div>

    <h2>ğŸ§© Oficjalne: 2 pierwsze tematy A1 (peÅ‚na lekcja + Ä‡wiczenia + fiszki)</h2>
    <p>
      Ta strona uzupeÅ‚nia Firestore: <code>course_meta</code> (treÅ›Ä‡ lekcji) i
      <code>exercises</code> (zadania) dla <b>pierwszych 2 tematÃ³w</b> w trasie A1
      (gramatyka + sÅ‚ownictwo przeplatane jak w Duolingo/Busuu).
    </p>
    <p class="muted">
      Wymaga admin: <code>aquivivo.pl@gmail.com</code>. Import jest idempotentny
      (ponowne uruchomienie tylko aktualizuje te same dokumenty).
    </p>

    <button id="importBtn">WGRYWAJ: 2 lekcje A1 (pierwsze 2 tematy)</button>
    <div id="preview" class="box">Tematy: (jeszcze nie wczytano)</div>
    <div id="log" class="box">Status: gotowe.</div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
      } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
      import {
        getFirestore,
        collection,
        doc,
        getDocs,
        query,
        where,
        orderBy,
        setDoc,
        serverTimestamp,
      } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM',
        authDomain: 'aquivivo-platform.firebaseapp.com',
        projectId: 'aquivivo-platform',
        storageBucket: 'aquivivo-platform.firebasestorage.app',
        messagingSenderId: '116115622011',
        appId: '1:116115622011:web:33a4a583eba4368071bade',
      };

      const ADMIN_EMAIL = 'aquivivo.pl@gmail.com';
      const LEVEL = 'A1';
      const SEED_VERSION = 'a1_official_v1_2026-02-09';

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const logEl = document.getElementById('log');
      const previewEl = document.getElementById('preview');
      const sessionEl = document.getElementById('sessionEmail');
      function log(msg, type = '') {
        logEl.innerHTML = `<div class="${type}">${msg}</div>`;
      }

      function esc(s) {
        return String(s || '')
          .replaceAll('&', '&amp;')
          .replaceAll('<', '&lt;')
          .replaceAll('>', '&gt;')
          .replaceAll('"', '&quot;')
          .replaceAll("'", '&#039;');
      }

      let IS_ADMIN = false;

      onAuthStateChanged(auth, (user) => {
        if (sessionEl) sessionEl.textContent = user?.email || '(sin sesiÃ³n)';
        IS_ADMIN =
          !!user &&
          String(user.email || '').toLowerCase() === ADMIN_EMAIL.toLowerCase();
        if (!IS_ADMIN) {
          log(
            `âŒ Zaloguj siÄ™ jako admin (${esc(ADMIN_EMAIL)}), potem wrÃ³Ä‡ na tÄ™ stronÄ™.`,
            'err',
          );
        }
      });

      function topicTypeKey(topic) {
        const raw = String(topic?.type || topic?.category || '')
          .trim()
          .toLowerCase();
        if (!raw) return 'grammar';

        if (
          raw === 'vocab' ||
          raw === 'vocabulary' ||
          raw === 'vocabulario' ||
          raw === 'slownictwo' ||
          raw === 'sÅ‚ownictwo'
        )
          return 'vocabulary';

        if (
          raw === 'grammar' ||
          raw === 'gramatyka' ||
          raw === 'gramatica' ||
          raw === 'gramÃ¡tica'
        )
          return 'grammar';

        if (
          raw === 'both' ||
          raw === 'mix' ||
          raw === 'mixed' ||
          raw === 'mieszane' ||
          raw.includes('+')
        )
          return 'both';

        return raw;
      }

      function buildMixedRoute(topics) {
        const grammar = [];
        const vocab = [];
        const both = [];
        const other = [];

        (topics || []).forEach((t) => {
          const k = topicTypeKey(t);
          if (k === 'vocabulary') vocab.push(t);
          else if (k === 'grammar') grammar.push(t);
          else if (k === 'both') both.push(t);
          else other.push(t);
        });

        if (!grammar.length || !vocab.length) return topics || [];

        const mixed = [];
        const max = Math.max(grammar.length, vocab.length, both.length);
        for (let i = 0; i < max; i += 1) {
          if (grammar[i]) mixed.push(grammar[i]);
          if (vocab[i]) mixed.push(vocab[i]);
          if (both[i]) mixed.push(both[i]);
        }
        return [...mixed, ...other];
      }

      function metaDocId(level, courseId) {
        return `${level}__${courseId}`;
      }

      function exerciseDocId(level, topicId, seq) {
        const n = String(seq).padStart(3, '0');
        return `${level}__${topicId}__OFF__${n}`;
      }

      const HTML_A1_PRESENTACION = `
        <h2>ğŸ¯ Objetivo</h2>
        <p>Vas a presentarte en polaco y decir de dÃ³nde eres con frases naturales.</p>

        <h2>ğŸ§  GramÃ¡tica rÃ¡pida: <i>byÄ‡</i> (ser/estar) en presente</h2>
        <div class="card" style="padding:12px; margin:12px 0;">
          <div style="font-weight:900;">Formas bÃ¡sicas</div>
          <div style="margin-top:8px; line-height:1.75;">
            <b>ja</b> â€” <b>jestem</b> (yo soy/estoy)<br/>
            <b>ty</b> â€” <b>jesteÅ›</b> (tÃº eres/estÃ¡s)<br/>
            <b>on/ona</b> â€” <b>jest</b> (Ã©l/ella es/estÃ¡)
          </div>
        </div>

        <h2>ğŸ§© Frases listas (chunking)</h2>
        <ul>
          <li><b>DzieÅ„ dobry!</b> â€” Â¡Buenos dÃ­as!</li>
          <li><b>CzeÅ›Ä‡!</b> â€” Â¡Hola! (informal)</li>
          <li><b>Mam na imiÄ™â€¦</b> â€” Me llamoâ€¦</li>
          <li><b>Jestem z Hiszpanii.</b> â€” Soy de EspaÃ±a.</li>
          <li><b>A ty?</b> â€” Â¿Y tÃº?</li>
        </ul>

        <h2>ğŸ“š Vocabulario clave</h2>
        <ul>
          <li><b>proszÄ™</b> â€” por favor / de nada</li>
          <li><b>dziÄ™kujÄ™</b> â€” gracias</li>
          <li><b>przepraszam</b> â€” perdÃ³n</li>
          <li><b>Polska</b> â€” Polonia</li>
          <li><b>Hiszpania</b> â€” EspaÃ±a</li>
        </ul>

        <h2>ğŸ’¬ Mini diÃ¡logo</h2>
        <p style="line-height:1.7;">
          <b>A:</b> DzieÅ„ dobry! Jak masz na imiÄ™?<br/>
          <b>B:</b> Mam na imiÄ™ Juan. A ty?<br/>
          <b>A:</b> Mam na imiÄ™ Ania. SkÄ…d jesteÅ›?<br/>
          <b>B:</b> Jestem z Hiszpanii.
        </p>

        <div class="hintSmall" style="margin-top:12px;">
          Dalej: zrÃ³b <b>Ejercicios</b>, potem przejdÅº do <b>Fichas</b>. Na Ä‡wiczeniach z ikonÄ… ğŸ™ï¸ moÅ¼esz nagraÄ‡ gÅ‚os.
        </div>
      `;

      const HTML_A1_CAFE_NUMEROS = `
        <h2>ğŸ¯ Objetivo</h2>
        <p>Vas a pedir algo en una cafeterÃ­a y entender precios sencillos.</p>

        <h2>ğŸ§  GramÃ¡tica rÃ¡pida: <i>PoproszÄ™â€¦</i> (quisieraâ€¦)</h2>
        <p>
          En A1 lo tratamos como <b>frase lista</b>. Ãšsala para pedir con educaciÃ³n:
          <b>PoproszÄ™ kawÄ™</b>, <b>PoproszÄ™ wodÄ™</b>, <b>PoproszÄ™ herbatÄ™</b>.
        </p>

        <h2>ğŸ”¢ NÃºmeros (1â€“10)</h2>
        <div class="card" style="padding:12px; margin:12px 0; line-height:1.7;">
          1 <b>jeden</b>, 2 <b>dwa</b>, 3 <b>trzy</b>, 4 <b>cztery</b>, 5 <b>piÄ™Ä‡</b><br/>
          6 <b>szeÅ›Ä‡</b>, 7 <b>siedem</b>, 8 <b>osiem</b>, 9 <b>dziewiÄ™Ä‡</b>, 10 <b>dziesiÄ™Ä‡</b>
        </div>

        <h2>ğŸ“š Vocabulario clave</h2>
        <ul>
          <li><b>kawa</b> â€” cafÃ©</li>
          <li><b>herbata</b> â€” tÃ©</li>
          <li><b>woda</b> â€” agua</li>
          <li><b>ile kosztuje?</b> â€” Â¿cuÃ¡nto cuesta?</li>
          <li><b>rachunek, proszÄ™</b> â€” la cuenta, por favor</li>
        </ul>

        <h2>ğŸ’¬ Mini diÃ¡logo</h2>
        <p style="line-height:1.7;">
          <b>A:</b> DzieÅ„ dobry. Co podaÄ‡?<br/>
          <b>B:</b> PoproszÄ™ kawÄ™ i wodÄ™, proszÄ™.<br/>
          <b>A:</b> Jasne. To kosztuje cztery zÅ‚ote.<br/>
          <b>B:</b> DziÄ™kujÄ™!
        </p>

        <div class="hintSmall" style="margin-top:12px;">
          Dalej: <b>Ejercicios</b> (z audio i nagrywaniem), potem <b>Fichas</b>.
        </div>
      `;

      function buildSeedForTopic(topic, idx) {
        const topicTitle = String(topic?.title || topic?.name || '').trim();
        const topicSlug = String(topic?.slug || '').trim();
        const base = {
          published: true,
          durationMin: 10,
          resources: [],
          updatedAt: serverTimestamp(),
          createdAt: serverTimestamp(),
          seedVersion: SEED_VERSION,
        };

        if (idx === 0) {
          return {
            meta: {
              ...base,
              level: LEVEL,
              courseId: topic.id,
              titleEs: 'A1 â€” Saludos y presentaciÃ³n',
              descriptionEs:
                'Frases clave + byÄ‡ (jestem/jesteÅ›) + mini diÃ¡logo + voz.',
              html: HTML_A1_PRESENTACION,
              summary:
                'Te presentas y dices de dÃ³nde eres. Practicas â€œbyÄ‡â€ en presente con audio y grabaciÃ³n.',
              vocab: ['dzieÅ„ dobry', 'czeÅ›Ä‡', 'mam na imiÄ™', 'jestem', 'proszÄ™', 'dziÄ™kujÄ™', 'Polska', 'Hiszpania'],
              homework:
                'Nagraj 3 frases: â€œDzieÅ„ dobryâ€, â€œMam na imiÄ™â€¦â€, â€œJestem z â€¦â€.',
            },
            exercises: [
              {
                order: 1,
                type: 'Rellenar los espacios',
                prompt: 'Ja ___ z Hiszpanii.',
                answer: 'jestem',
                notes: 'byÄ‡ (ja) = jestem',
                tags: ['a1', 'official', 'grammar'],
              },
              {
                order: 2,
                type: 'OpciÃ³n mÃºltiple',
                prompt: 'Elige: Ty ___ z Meksyku.',
                options: ['A) jestem', 'B) jesteÅ›', 'C) jest'],
                answer: 'B',
                notes: 'byÄ‡ (ty) = jesteÅ›',
                tags: ['a1', 'official', 'grammar'],
              },
              {
                order: 3,
                type: 'Escuchar y completar los espacios',
                prompt: 'DzieÅ„ ___!',
                answer: 'dobry',
                notes: 'TTS_PL: DzieÅ„ dobry!',
                tags: ['a1', 'official', 'listening'],
              },
              {
                order: 4,
                type: 'Rellenar los espacios',
                prompt: 'Mam na ___â€¦',
                answer: 'imiÄ™',
                notes: 'Frase lista: Mam na imiÄ™â€¦',
                tags: ['a1', 'official', 'grammar'],
              },
              {
                order: 5,
                type: 'Escuchar y repetir (voz)',
                prompt: 'PowtÃ³rz: Mam na imiÄ™ Juan. Jestem z Hiszpanii.',
                answer: '',
                notes: 'TTS_PL: Mam na imiÄ™ Juan. Jestem z Hiszpanii.',
                tags: ['a1', 'official', 'speaking'],
              },
              {
                order: 6,
                type: 'Tarjetas interactivas',
                prompt: 'Fichas del tema',
                options: [
                  '1) PL: dzieÅ„ dobry | ES: buenos dÃ­as | EX: DzieÅ„ dobry! Jak siÄ™ masz?',
                  '2) PL: czeÅ›Ä‡ | ES: hola (informal) | EX: CzeÅ›Ä‡! Co sÅ‚ychaÄ‡?',
                  '3) PL: proszÄ™ | ES: por favor / de nada | EX: ProszÄ™, usiÄ…dÅº.',
                  '4) PL: dziÄ™kujÄ™ | ES: gracias | EX: DziÄ™kujÄ™ bardzo!',
                  '5) PL: przepraszam | ES: perdÃ³n | EX: Przepraszam, gdzie jest toaleta?',
                ],
                answer: '',
                notes: 'Abre â€œFichasâ€ para practicar tipo Quizlet.',
                tags: ['a1', 'official', 'flashcards'],
              },
              {
                order: 7,
                type: 'Test final del tema',
                prompt: 'Elige la frase correcta: â€œI am from Spain.â€',
                options: ['A) Jestem z Hiszpanii.', 'B) JesteÅ› z Hiszpanii.', 'C) Jest z Hiszpanii.'],
                answer: 'A',
                notes: 'Test: jestem (yo).',
                tags: ['a1', 'official', 'test'],
              },
            ],
          };
        }

        return {
          meta: {
            ...base,
            level: LEVEL,
            courseId: topic.id,
            titleEs: 'A1 â€” En la cafeterÃ­a (pedir + precios)',
            descriptionEs:
              'PoproszÄ™â€¦ + nÃºmeros 1â€“10 + Ile kosztuje? + audio + voz.',
            html: HTML_A1_CAFE_NUMEROS,
            summary:
              'Pides en una cafeterÃ­a y practicas nÃºmeros y precios con audio y grabaciÃ³n.',
            vocab: ['poproszÄ™', 'kawa', 'herbata', 'woda', 'ile kosztuje', 'rachunek', 'zÅ‚oty'],
            homework:
              'Nagraj: â€œPoproszÄ™ kawÄ™â€, â€œPoproszÄ™ wodÄ™â€, â€œRachunek, proszÄ™â€.',
          },
          exercises: [
            {
              order: 1,
              type: 'OpciÃ³n mÃºltiple',
              prompt: 'Elige: PoproszÄ™ ___.',
              options: ['A) kawÄ™', 'B) kawa', 'C) kawy'],
              answer: 'A',
              notes: 'Frase lista (A1): PoproszÄ™ kawÄ™.',
              tags: ['a1', 'official', 'vocab'],
            },
            {
              order: 2,
              type: 'Rellenar los espacios',
              prompt: 'To kosztuje ___ zÅ‚ote.',
              answer: 'cztery|4',
              notes: 'NÃºmeros: 4 = cztery',
              tags: ['a1', 'official', 'grammar'],
            },
            {
              order: 3,
              type: 'Escuchar y completar los espacios',
              prompt: 'DzieÅ„ dobry. PoproszÄ™ ___ i ___, proszÄ™.',
              answer: 'kawÄ™||wodÄ™',
              notes: 'TTS_PL: DzieÅ„ dobry. PoproszÄ™ kawÄ™ i wodÄ™, proszÄ™.',
              tags: ['a1', 'official', 'listening'],
            },
            {
              order: 4,
              type: 'Escuchar y repetir (voz)',
              prompt: 'PowtÃ³rz: Rachunek, proszÄ™.',
              answer: '',
              notes: 'TTS_PL: Rachunek, proszÄ™.',
              tags: ['a1', 'official', 'speaking'],
            },
            {
              order: 5,
              type: 'Tarjetas interactivas',
              prompt: 'Fichas del tema',
              options: [
                '1) PL: poproszÄ™ | ES: quisiera | EX: PoproszÄ™ kawÄ™.',
                '2) PL: kawa | ES: cafÃ© | EX: PoproszÄ™ kawÄ™, proszÄ™.',
                '3) PL: herbata | ES: tÃ© | EX: PoproszÄ™ herbatÄ™.',
                '4) PL: woda | ES: agua | EX: PoproszÄ™ wodÄ™.',
                '5) PL: ile kosztuje? | ES: Â¿cuÃ¡nto cuesta? | EX: Ile kosztuje kawa?',
                '6) PL: rachunek, proszÄ™ | ES: la cuenta, por favor | EX: Rachunek, proszÄ™.',
              ],
              answer: '',
              notes: 'Abre â€œFichasâ€ para practicar tipo Quizlet.',
              tags: ['a1', 'official', 'flashcards'],
            },
            {
              order: 6,
              type: 'Test final del tema',
              prompt: 'Elige: Â¿CÃ³mo preguntas por el precio?',
              options: ['A) Ile kosztuje?', 'B) SkÄ…d jesteÅ›?', 'C) Jak masz na imiÄ™?'],
              answer: 'A',
              notes: 'Test: frase clave',
              tags: ['a1', 'official', 'test'],
            },
          ],
        };
      }

      async function loadA1Topics() {
        const q = query(
          collection(db, 'courses'),
          where('level', '==', LEVEL),
          orderBy('order'),
        );
        const snap = await getDocs(q);
        return snap.docs
          .map((d) => ({ id: d.id, ...(d.data() || {}) }))
          .filter((t) => t.isArchived !== true);
      }

      function renderPreview(selected) {
        if (!previewEl) return;
        if (!selected?.length) {
          previewEl.innerHTML = 'Tematy: (brak)';
          return;
        }
        previewEl.innerHTML = `
          <div style="font-weight:900;">Wykryte tematy (ruta A1 â†’ pierwsze 2):</div>
          ${selected
            .map((t, i) => {
              const tt = esc(t?.title || t?.name || '(bez tytuÅ‚u)');
              const ty = esc(String(t?.type || ''));
              const sl = esc(String(t?.slug || ''));
              return `<div class="topicLine">
                <b>#${i + 1}</b> ${tt}
                <div class="muted">id: <code>${esc(t.id)}</code> Â· type: <code>${ty || '-'}</code> Â· slug: <code>${sl || '-'}</code></div>
              </div>`;
            })
            .join('')}
        `;
      }

      async function upsertTopicMetaAndExercises(topic, idx) {
        const seed = buildSeedForTopic(topic, idx);

        const metaRef = doc(db, 'course_meta', metaDocId(LEVEL, topic.id));
        await setDoc(
          metaRef,
          {
            level: LEVEL,
            courseId: topic.id,
            published: seed.meta.published === true,
            titleEs: seed.meta.titleEs,
            descriptionEs: seed.meta.descriptionEs,
            durationMin: seed.meta.durationMin || null,
            html: seed.meta.html,
            summary: seed.meta.summary || '',
            vocab: seed.meta.vocab || [],
            resources: seed.meta.resources || [],
            homework: seed.meta.homework || '',
            seedVersion: seed.meta.seedVersion || SEED_VERSION,
            updatedAt: serverTimestamp(),
            createdAt: serverTimestamp(),
          },
          { merge: true },
        );

        const topicSlug = String(topic?.slug || '').trim();
        for (let i = 0; i < seed.exercises.length; i += 1) {
          const ex = seed.exercises[i];
          const exId = exerciseDocId(LEVEL, topic.id, ex.order);
          const exRef = doc(db, 'exercises', exId);
          await setDoc(
            exRef,
            {
              level: LEVEL,
              topicId: topic.id,
              topicSlug: topicSlug || topic.id,
              order: ex.order,
              type: ex.type,
              prompt: ex.prompt,
              options: ex.options || [],
              answer: ex.answer || '',
              notes: ex.notes || '',
              tags: ex.tags || [],
              category: 'both',
              seedVersion: SEED_VERSION,
              updatedAt: serverTimestamp(),
              createdAt: serverTimestamp(),
            },
            { merge: true },
          );
        }
      }

      document.getElementById('importBtn').onclick = async () => {
        if (!IS_ADMIN) {
          alert('Nie jesteÅ› adminem.');
          return;
        }
        try {
          log('â³ WczytujÄ™ tematy A1...', '');
          const all = await loadA1Topics();
          if (!all.length) {
            renderPreview([]);
            log('âŒ Brak tematÃ³w A1 w collection courses.', 'err');
            return;
          }

          const route = buildMixedRoute(all);
          const selected = route.slice(0, 2);
          renderPreview(selected);

          if (selected.length < 2) {
            log('âŒ PotrzebujÄ™ minimum 2 tematy A1.', 'err');
            return;
          }

          log('â³ Wgrywam 2 oficjalne lekcje A1...', '');
          for (let i = 0; i < selected.length; i += 1) {
            await upsertTopicMetaAndExercises(selected[i], i);
          }

          log(
            'âœ… Gotowe. OtwÃ³rz: <code>course.html?level=A1</code> â†’ wybierz temat #1/#2 â†’ potem <code>Ejercicios</code> i <code>Fichas</code>.',
            'ok',
          );
        } catch (e) {
          console.error(e);
          log('âŒ BÅ‚Ä…d importu. SprawdÅº konsolÄ™.', 'err');
        }
      };
    </script>
  </body>
</html>

