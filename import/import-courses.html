<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <title>Importar Cursos | AquiVivo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&family=Playfair+Display:wght@700;900&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="assets/css/styles.css" />
    <style>
      body {
        margin: 0;
        font-family: Montserrat, Arial, sans-serif;
        min-height: 100vh;
        background: linear-gradient(180deg, #001a4d, var(--blue), #001a4d);
        color: white;
      }
      .wrap {
        max-width: 1100px;
        margin: 0 auto;
        padding: 28px 16px 60px;
      }
      h1 {
        font-family: 'Playfair Display', serif;
        color: var(--yellow);
        margin: 0 0 6px 0;
        font-size: 44px;
      }
      .sub {
        opacity: 0.85;
        margin: 0 0 18px 0;
      }
      .card {
        background: white;
        color: #111827;
        border-radius: 14px;
        padding: 14px 14px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.22);
        margin: 12px 0;
      }
      textarea {
        width: 100%;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid var(--border-light);
        font-family: monospace;
        font-size: 13px;
        box-sizing: border-box;
        min-height: 200px;
      }
      button {
        padding: 10px 14px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 800;
        background: var(--blue);
        color: white;
        margin-top: 10px;
      }
      button:hover {
        opacity: 0.9;
      }
      .status {
        margin-top: 12px;
        padding: 10px;
        border-radius: 10px;
        font-weight: 700;
      }
      .status.ok {
        background: #d1fae5;
        color: var(--success-ink);
      }
      .status.error {
        background: #fee2e2;
        color: var(--danger-ink);
      }
      .status.loading {
        background: #fef3c7;
        color: #92400e;
      }
      .topbar {
        position: fixed;
        top: 14px;
        right: 14px;
        display: flex;
        gap: 10px;
        z-index: 50;
      }
      .topbar button {
        padding: 8px 12px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        background: var(--red);
        color: white;
      }
    </style>
  </head>
  <body>
    <div
      style="
        background: var(--yellow);
        color: var(--blue);
        padding: 8px 0;
        text-align: center;
        font-size: 12px;
        font-weight: 700;
        letter-spacing: 0.2px;
      "
    >
      Sesi√≥n activa:
      <strong id="sessionEmail" style="color: var(--blue); font-weight: 900"
        >Cargando...</strong
      >
    </div>

    <div class="topbar">
      <button onclick="logout()">Cerrar sesi√≥n</button>
    </div>

    <div class="wrap">
      <a
        style="
          color: white;
          opacity: 0.9;
          text-decoration: underline;
          display: inline-block;
          margin-bottom: 14px;
        "
        href="esadmin.html"
        >‚Üê Volver a Admin</a
      >

      <h1>üì• Importar Temas de Cursos</h1>
      <p class="sub">
        Copia y pega los temas en el formato de abajo. El sistema los a√±adir√° a
        Firestore.
      </p>

      <div class="card">
        <h3>Formato esperado:</h3>
        <pre
          style="
            background: #f3f4f6;
            padding: 10px;
            border-radius: 8px;
            overflow-x: auto;
            color: #111827;
          "
        >
NIVEL:A2
TIPO:grammar
Tema 1
Tema 2
Tema 3

TIPO:vocabulary
Tema A
Tema B</pre
        >

        <h3 style="margin-top: 20px">Pega los temas aqu√≠:</h3>
        <textarea
          id="importData"
          placeholder="NIVEL:A2&#10;TIPO:grammar&#10;Presente: verbos irregulares&#10;Verbos reflexivos&#10;..."
        ></textarea>

        <div style="display: flex; gap: 10px; flex-wrap: wrap">
          <button onclick="importTopics()">‚úÖ Importar Ahora</button>
          <button onclick="cleanAndImport()" style="background: var(--red)">
            üßπ Limpiar A2 + Importar
          </button>
        </div>
        <div id="status"></div>
      </div>

      <div class="card">
        <h3>üìã Datos de ejemplo para A2:</h3>
        <textarea
          id="exampleA2"
          readonly
          style="color: var(--ink-muted); background: #f9fafb"
        >
NIVEL:A2
TIPO:grammar
Presente: verbos irregulares
Verbos reflexivos
Pasado simple
Futuro simple
Verbos modales: m√≥c, musieƒá, chcieƒá
Casos del polaco: visi√≥n general
Caso genitivo
Caso locativo
Caso instrumental
Preposiciones con casos
Comparativos y superlativos
Adverbios de tiempo y frecuencia
Conectores b√°sicos

TIPO:vocabulary
Presentaci√≥n y small talk
Trabajo y responsabilidades
Vivienda y alquiler
Comida y restaurante
Tienda y devoluciones
M√©dico y farmacia
Oficina p√∫blica y tr√°mites
Transporte p√∫blico
Tiempo libre
Emociones y estado de √°nimo</textarea
        >
        <button onclick="copyExample('exampleA2')">üìã Copiar para A2</button>
      </div>

      <div class="card">
        <h3>‚öôÔ∏è Editar Descripciones de Niveles</h3>
        <p style="font-size: 13px; color: var(--ink-muted)">
          Estos textos aparecer√°n en la parte superior de cada p√°gina de curso.
        </p>

        <div
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 14px;
            margin-top: 14px;
          "
        >
          <div
            style="
              border: 1px solid var(--border-light);
              border-radius: 10px;
              padding: 14px;
            "
          >
            <h4 style="margin: 0 0 10px 0; color: var(--blue)">
              üìö Nivel A1-A2
            </h4>
            <input
              type="text"
              id="meta_a1_title"
              placeholder="T√≠tulo (ej: üìö Nivel A1-A2)"
              style="
                width: 100%;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border-light);
                margin-bottom: 8px;
                box-sizing: border-box;
              "
            />
            <textarea
              id="meta_a1_subtitle"
              placeholder="Subt√≠tulo..."
              style="
                width: 100%;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border-light);
                box-sizing: border-box;
                min-height: 60px;
                font-size: 12px;
              "
            ></textarea>
            <button
              onclick="saveMeta('A1')"
              style="
                width: 100%;
                margin-top: 8px;
                padding: 8px;
                background: var(--yellow);
                color: var(--ink-blue);
              "
            >
              Guardar A1
            </button>
            <button
              onclick="saveMeta('A2')"
              style="
                width: 100%;
                margin-top: 6px;
                padding: 8px;
                background: var(--yellow);
                color: var(--ink-blue);
              "
            >
              Guardar A2
            </button>
          </div>

          <div
            style="
              border: 1px solid var(--border-light);
              border-radius: 10px;
              padding: 14px;
            "
          >
            <h4 style="margin: 0 0 10px 0; color: var(--blue)">üìñ Nivel B1</h4>
            <input
              type="text"
              id="meta_b1_title"
              placeholder="T√≠tulo"
              style="
                width: 100%;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border-light);
                margin-bottom: 8px;
                box-sizing: border-box;
              "
            />
            <textarea
              id="meta_b1_subtitle"
              placeholder="Subt√≠tulo..."
              style="
                width: 100%;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border-light);
                box-sizing: border-box;
                min-height: 60px;
                font-size: 12px;
              "
            ></textarea>
            <button
              onclick="saveMeta('B1')"
              style="
                width: 100%;
                margin-top: 8px;
                padding: 8px;
                background: var(--blue);
                color: white;
              "
            >
              Guardar B1
            </button>
          </div>

          <div
            style="
              border: 1px solid var(--border-light);
              border-radius: 10px;
              padding: 14px;
            "
          >
            <h4 style="margin: 0 0 10px 0; color: var(--red)">üìñ Nivel B2</h4>
            <input
              type="text"
              id="meta_b2_title"
              placeholder="T√≠tulo"
              style="
                width: 100%;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border-light);
                margin-bottom: 8px;
                box-sizing: border-box;
              "
            />
            <textarea
              id="meta_b2_subtitle"
              placeholder="Subt√≠tulo..."
              style="
                width: 100%;
                padding: 8px;
                border-radius: 8px;
                border: 1px solid var(--border-light);
                box-sizing: border-box;
                min-height: 60px;
                font-size: 12px;
              "
            ></textarea>
            <button
              onclick="saveMeta('B2')"
              style="
                width: 100%;
                margin-top: 8px;
                padding: 8px;
                background: var(--red);
                color: white;
              "
            >
              Guardar B2
            </button>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js';
      import {
        getAuth,
        onAuthStateChanged,
        signOut,
      } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js';
      import {
        getFirestore,
        collection,
        addDoc,
        serverTimestamp,
        query,
        where,
        getDocs,
        deleteDoc,
        doc,
        setDoc,
      } from 'https://www.gstatic.com/firebasejs/12.8.0/firebase-firestore.js';

      const firebaseConfig = {
        apiKey: 'AIzaSyBoa3Yf82CDW6k1FSwdeoQg-gBTjh9kVZM',
        authDomain: 'aquivivo-platform.firebaseapp.com',
        projectId: 'aquivivo-platform',
        storageBucket: 'aquivivo-platform.firebasestorage.app',
        messagingSenderId: '116115622011',
        appId: '1:116115622011:web:33a4a583eba4368071bade',
      };

      const ADMIN_EMAIL = 'aquivivo.pl@gmail.com';
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      const statusEl = document.getElementById('status');

      // Verificar que sea admin
      onAuthStateChanged(auth, (user) => {
        if (!user) {
          window.location.href = 'eslogin.html';
          return;
        }
        if ((user.email || '').toLowerCase() !== ADMIN_EMAIL.toLowerCase()) {
          document.body.innerHTML = `<div class="wrap"><h1>Acceso denegado</h1><p class="sub">Solo administradores.</p></div>`;
          return;
        }
      });

      window.logout = function () {
        signOut(auth).then(() => (window.location.href = 'eslogin.html'));
      };

      window.copyExample = function (id) {
        const text = document.getElementById(id).value;
        navigator.clipboard.writeText(text).then(() => {
          alert('‚úÖ Copiado al portapapeles');
        });
      };

      window.cleanAndImport = async function () {
        if (!confirm('‚ö†Ô∏è Esto eliminar√° TODOS los temas de A2. ¬øContinuar?'))
          return;

        setStatus('Limpiando A2...', 'loading');

        try {
          // Eliminar todos los temas de A2
          const q = query(
            collection(db, 'courses'),
            where('level', '==', 'A2'),
          );
          const snap = await getDocs(q);

          let deleted = 0;
          for (const docSnap of snap.docs) {
            await deleteDoc(doc(db, 'courses', docSnap.id));
            deleted++;
          }

          setStatus(
            `‚úÖ Se eliminaron ${deleted} temas de A2. Ahora importando nuevos...`,
            'ok',
          );

          // Ahora importar los nuevos
          await importTopics();
        } catch (error) {
          setStatus(`‚ùå Error: ${error.message}`, 'error');
        }
      };

      window.copyExample = function (id) {
        const text = document.getElementById(id).value;
        navigator.clipboard.writeText(text).then(() => {
          alert('‚úÖ Copiado al portapapeles');
        });
      };

      window.saveMeta = async function (level) {
        const titleEl = document.getElementById(
          `meta_${level.toLowerCase()}_title`,
        );
        const subtitleEl = document.getElementById(
          `meta_${level.toLowerCase()}_subtitle`,
        );

        const title = titleEl?.value?.trim() || `Nivel ${level}`;
        const subtitle = subtitleEl?.value?.trim() || '';

        if (!title || !subtitle) {
          alert('Por favor completa t√≠tulo y subt√≠tulo');
          return;
        }

        setStatus(`Guardando ${level}...`, 'loading');

        try {
          await setDoc(doc(db, 'course_meta', level), {
            title: title,
            subtitle: subtitle,
            updatedAt: serverTimestamp(),
          });

          setStatus(`‚úÖ ${level} guardado correctamente`, 'ok');
        } catch (error) {
          setStatus(`‚ùå Error: ${error.message}`, 'error');
        }
      };

      window.importTopics = async function () {
        const data = document.getElementById('importData').value.trim();
        if (!data) {
          setStatus('Por favor, pega los datos', 'error');
          return;
        }

        setStatus('Importando...', 'loading');

        try {
          const lines = data
            .split('\n')
            .map((l) => l.trim())
            .filter((l) => l);

          let currentLevel = 'A1';
          let currentType = 'grammar';
          const topicsToAdd = [];

          for (const line of lines) {
            if (line.startsWith('NIVEL:')) {
              currentLevel = line.replace('NIVEL:', '').toUpperCase();
            } else if (line.startsWith('TIPO:')) {
              const typeStr = line.replace('TIPO:', '').toLowerCase();
              currentType = typeStr === 'vocabulary' ? 'vocabulary' : 'grammar';
            } else if (line.length > 0) {
              topicsToAdd.push({
                level: currentLevel,
                type: currentType,
                title: line,
                desc: line,
                createdAt: serverTimestamp(),
              });
            }
          }

          let added = 0;
          for (let i = 0; i < topicsToAdd.length; i++) {
            const topic = topicsToAdd[i];
            topic.order = i + 1; // Agregar n√∫mero de orden para mantener secuencia
            await addDoc(collection(db, 'courses'), topic);
            added++;
          }

          setStatus(`‚úÖ ${added} temas a√±adidos correctamente`, 'ok');
          document.getElementById('importData').value = '';
        } catch (error) {
          setStatus(`‚ùå Error: ${error.message}`, 'error');
        }
      };

      function setStatus(msg, type) {
        statusEl.textContent = msg;
        statusEl.className = `status ${type}`;
      }

      // Cargar email del usuario
      onAuthStateChanged(auth, (user) => {
        if (user) {
          document.getElementById('sessionEmail').textContent =
            user.email || '(sin correo)';
        } else {
          document.getElementById('sessionEmail').textContent = 'No conectado';
        }
      });
    </script>
  </body>
</html>
